<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Studio Manager - × ×™×”×•×œ ×¡×˜×•×“×™×• ×× ×™××¦×™×”</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap');

:root {
  --bg: #f4f5f7;
  --surface: #ffffff;
  --surface2: #f8f9fb;
  --surface3: #eef0f4;
  --border: #dfe1e6;
  --text: #172b4d;
  --text2: #6b778c;
  --accent: #4a6cf7;
  --accent2: #3b5de7;
  --green: #36b37e;
  --green-bg: rgba(54,179,126,0.10);
  --yellow: #f5a623;
  --yellow-bg: rgba(245,166,35,0.10);
  --red: #eb5757;
  --red-bg: rgba(235,87,87,0.10);
  --blue: #4a9df8;
  --blue-bg: rgba(74,157,248,0.10);
  --pink: #e8598b;
  --orange: #f7943e;
  --cyan: #4ecdc4;
  --purple: #8777d9;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --radius: 8px;
}

* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:'Heebo',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}

.sidebar {
  position:fixed; top:0; right:0; width:220px; height:100vh;
  background:var(--surface);
  border-left:1px solid var(--border);
  z-index:100;
  display:flex; flex-direction:column;
  box-shadow:-2px 0 8px rgba(0,0,0,0.04);
}
.sidebar-header {
  padding:18px 16px;
  border-bottom:1px solid var(--border);
  text-align:center;
  background:var(--accent);
}
.sidebar-header h1 {
  font-size:16px; font-weight:700;
  color:#fff;
  -webkit-text-fill-color:#fff;
  background:none;
}
.sidebar-header p { font-size:11px; color:rgba(255,255,255,0.7); margin-top:3px; }
.sidebar-nav { flex:1; padding:8px 0; overflow-y:auto; }
.nav-item {
  display:flex; align-items:center; gap:10px;
  padding:9px 16px; cursor:pointer;
  color:var(--text2); font-size:13px;
  transition: all 0.15s;
  border-right:3px solid transparent;
}
.nav-item:hover { background:var(--surface2); color:var(--text); }
.nav-item.active {
  background:rgba(74,108,247,0.08); color:var(--accent);
  border-right-color:var(--accent);
  font-weight:600;
}
.nav-item .icon { font-size:16px; width:22px; text-align:center; }

.team-section {
  padding:14px 16px;
  border-top:1px solid var(--border);
  background:var(--surface2);
}
.team-section h3 { font-size:11px; color:var(--text2); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px; font-weight:600; }
.team-member {
  display:flex; align-items:center; gap:8px;
  padding:5px 0; font-size:12px;
}
.avatar {
  width:26px; height:26px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:10px; font-weight:700; color:#fff;
}
.avatar-rubi { background:var(--accent); }
.avatar-gilad { background:var(--green); }
.avatar-dana { background:var(--pink); }

.main { margin-right:220px; min-height:100vh; }

.topbar {
  position:sticky; top:0;
  background:rgba(255,255,255,0.92);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  padding:10px 24px;
  display:flex; align-items:center; justify-content:space-between;
  z-index:50;
  box-shadow:var(--shadow-sm);
}
.topbar-right { display:flex; align-items:center; gap:14px; }
.topbar-title { font-size:18px; font-weight:700; color:var(--text); }
.topbar-left { display:flex; align-items:center; gap:10px; }
.search-box {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:var(--radius); padding:7px 14px; color:var(--text);
  font-family:'Heebo',sans-serif; font-size:13px; width:220px;
  outline:none;
}
.search-box:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(74,108,247,0.12); }
.btn {
  padding:7px 16px; border-radius:var(--radius); border:none;
  font-family:'Heebo',sans-serif; font-size:13px; font-weight:500;
  cursor:pointer; transition: all 0.15s; white-space:nowrap;
}
.btn-primary { background:var(--accent); color:#fff; box-shadow:0 1px 3px rgba(74,108,247,0.3); }
.btn-primary:hover { background:var(--accent2); box-shadow:0 2px 6px rgba(74,108,247,0.35); }
.btn-secondary { background:var(--surface); color:var(--text); border:1px solid var(--border); }
.btn-secondary:hover { background:var(--surface2); border-color:#ccc; }
.btn-sm { padding:5px 10px; font-size:12px; }
.btn-google { background:#4285f4; color:#fff; }
.btn-google:hover { background:#5a95f5; }

.content { padding:20px 24px; }

.stats-grid {
  display:grid; grid-template-columns:repeat(4,1fr); gap:16px;
  margin-bottom:24px;
}
.stat-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:16px 18px;
  box-shadow:var(--shadow-sm);
}
.stat-card .label { font-size:11px; color:var(--text2); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px; }
.stat-card .value { font-size:26px; font-weight:700; }
.stat-card .sub { font-size:11px; color:var(--text2); margin-top:3px; }
.stat-card.accent .value { color:var(--accent); }
.stat-card.green .value { color:var(--green); }
.stat-card.yellow .value { color:var(--yellow); }
.stat-card.red .value { color:var(--red); }

.filters-bar {
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  margin-bottom:20px;
}
.filter-chip {
  padding:5px 14px; border-radius:20px;
  background:var(--surface); border:1px solid var(--border);
  font-size:12px; cursor:pointer; transition:all 0.15s;
  color:var(--text2);
}
.filter-chip:hover { border-color:var(--accent); color:var(--accent); }
.filter-chip.active { background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 1px 3px rgba(74,108,247,0.25); }

.task-table-wrap {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); overflow:hidden;
  box-shadow:var(--shadow-sm);
}
.task-table { width:100%; border-collapse:collapse; }
.task-table th {
  background:var(--surface2);
  padding:10px 14px; text-align:right;
  font-size:11px; font-weight:600; color:var(--text2);
  border-bottom:2px solid var(--border);
  cursor:pointer; user-select:none; white-space:nowrap;
  text-transform:uppercase; letter-spacing:0.3px;
}
.task-table th:hover { color:var(--accent); }
.task-table td {
  padding:9px 14px; border-bottom:1px solid var(--border);
  font-size:13px; vertical-align:middle;
}
.task-table tr:hover td { background:rgba(74,108,247,0.03); }
.task-table tr:last-child td { border-bottom:none; }

.status-badge {
  display:inline-flex; align-items:center; gap:4px;
  padding:3px 10px; border-radius:12px; font-size:11px; font-weight:500;
}
.status-todo { background:#eef0f4; color:var(--text2); }
.status-progress { background:var(--blue-bg); color:#2b7cd8; }
.status-review { background:var(--yellow-bg); color:#c07b00; }
.status-done { background:var(--green-bg); color:#1e8f5e; }
.status-blocked { background:var(--red-bg); color:#c03030; }

.priority-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
.priority-high { background:var(--red); }
.priority-medium { background:var(--yellow); }
.priority-low { background:var(--green); }

.category-tag {
  display:inline-block; padding:2px 8px; border-radius:6px;
  font-size:11px; font-weight:500;
}

/* GANTT */
.gantt-container {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); overflow:hidden;
  box-shadow:var(--shadow-sm);
}
.gantt-header { display:flex; border-bottom:2px solid var(--border); }
.gantt-label-col {
  min-width:280px; width:280px; padding:10px 14px;
  background:var(--surface2);
  font-size:11px; font-weight:600; color:var(--text2);
  border-left:1px solid var(--border);
  text-transform:uppercase; letter-spacing:0.3px;
}
.gantt-timeline-header { flex:1; display:flex; }
.gantt-day-header {
  flex:1; min-width:38px;
  padding:4px 2px; text-align:center;
  font-size:9px; color:var(--text2);
  border-left:1px solid #eef0f4;
}
.gantt-day-header.weekend { background:#fafbfc; }
.gantt-day-header.today-col { background:rgba(74,108,247,0.08); color:var(--accent); font-weight:700; }
.gantt-week-header {
  text-align:center; padding:6px 0;
  font-size:11px; font-weight:700; color:var(--text);
  border-left:1px solid var(--border);
  border-bottom:1px solid var(--border);
  background:var(--surface2);
}
.gantt-body { max-height:650px; overflow-y:auto; overflow-x:hidden; }
.gantt-row {
  display:flex; border-bottom:1px solid #eef0f4;
  min-height:36px;
}
.gantt-row:nth-child(even) { background:#fafbfc; }
.gantt-row:hover { background:rgba(74,108,247,0.03); }
.gantt-row.cat-header { background:var(--surface2); border-bottom:1px solid var(--border); }
.gantt-row-label {
  min-width:280px; width:280px; padding:7px 14px;
  display:flex; align-items:center; gap:8px;
  font-size:12px; border-left:1px solid var(--border);
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  flex-shrink:0;
}
.gantt-row-timeline {
  flex:1; position:relative; display:flex;
}
.gantt-day-cell {
  flex:1; min-width:38px;
  border-left:1px solid #f0f1f4;
}
.gantt-day-cell.weekend { background:#fafbfc; }
.gantt-day-cell.today-col { background:rgba(74,108,247,0.04); }
.gantt-bar {
  position:absolute; top:5px; height:26px;
  border-radius:4px; display:flex; align-items:center;
  padding:0 8px; font-size:10px; font-weight:500; color:#fff;
  cursor:grab; overflow:hidden; white-space:nowrap;
  z-index:2; user-select:none;
  transition: box-shadow 0.15s, opacity 0.15s;
}
.gantt-bar:hover { box-shadow:0 2px 8px rgba(0,0,0,0.15); }
.gantt-bar.dragging {
  opacity:0.85; cursor:grabbing;
  box-shadow:0 4px 16px rgba(0,0,0,0.2);
  z-index:10;
}
.gantt-bar .resize-handle {
  position:absolute; top:0; width:8px; height:100%;
  cursor:col-resize; z-index:3;
}
.gantt-bar .resize-handle.left { left:0; }
.gantt-bar .resize-handle.right { right:0; }
.gantt-bar .resize-handle:hover { background:rgba(255,255,255,0.2); border-radius:2px; }
.gantt-bar .bar-label { pointer-events:none; overflow:hidden; text-overflow:ellipsis; flex:1; }
.gantt-bar .gcal-btn {
  opacity:0; transition:opacity 0.2s;
  background:rgba(255,255,255,0.25); border:none; color:#fff;
  border-radius:3px; padding:1px 4px; font-size:9px; cursor:pointer;
  margin-right:4px; flex-shrink:0;
}
.gantt-bar:hover .gcal-btn { opacity:1; }

/* CALENDAR */
.calendar-grid {
  display:grid; grid-template-columns:repeat(7,1fr);
  gap:1px; background:var(--border);
  border:1px solid var(--border); border-radius:var(--radius);
  overflow:hidden;
}
.cal-header {
  background:var(--surface2); padding:10px;
  text-align:center; font-size:11px; font-weight:600; color:var(--text2);
  text-transform:uppercase; letter-spacing:0.5px;
}
.cal-day {
  background:var(--surface); padding:8px;
  min-height:110px; cursor:pointer;
  transition: background 0.15s, border-color 0.15s;
  border:2px solid transparent;
}
.cal-day:hover { background:rgba(74,108,247,0.03); }
.cal-day.other-month { opacity:0.35; }
.cal-day.today { border-color:var(--accent); border-radius:2px; background:rgba(74,108,247,0.03); }
.cal-day.drag-over { background:rgba(74,108,247,0.06); border-color:var(--accent); border-radius:2px; }
.cal-day-num { font-size:13px; font-weight:600; margin-bottom:4px; }
.cal-event {
  padding:2px 6px; border-radius:4px;
  font-size:10px; margin-bottom:2px;
  cursor:grab; overflow:hidden;
  white-space:nowrap; text-overflow:ellipsis;
  user-select:none;
  transition:opacity 0.15s;
}
.cal-event.dragging { opacity:0.4; }
.cal-event:active { cursor:grabbing; }
.cal-event .gcal-icon {
  opacity:0; transition:opacity 0.2s;
  cursor:pointer; float:left;
  font-size:9px;
}
.cal-event:hover .gcal-icon { opacity:1; }
.cal-nav {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:16px;
}
.cal-nav h2 { font-size:20px; font-weight:600; }
.cal-nav-btns { display:flex; gap:8px; }

.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.35);
  backdrop-filter:blur(4px); z-index:200;
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition: opacity 0.2s;
}
.modal-overlay.show { opacity:1; pointer-events:all; }
.modal {
  background:var(--surface); border:1px solid var(--border);
  border-radius:12px; width:560px; max-height:85vh;
  overflow-y:auto; padding:28px;
  transform:translateY(20px); transition:transform 0.2s;
  box-shadow:0 20px 60px rgba(0,0,0,0.15);
}
.modal-overlay.show .modal { transform:translateY(0); }
.modal h2 { font-size:17px; font-weight:700; margin-bottom:18px; color:var(--text); }
.form-group { margin-bottom:12px; }
.form-group label {
  display:block; font-size:11px; font-weight:600;
  color:var(--text2); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.3px;
}
.form-input {
  width:100%; padding:8px 12px; border-radius:var(--radius);
  border:1px solid var(--border); background:var(--surface);
  color:var(--text); font-family:'Heebo',sans-serif; font-size:13px;
  outline:none;
}
.form-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(74,108,247,0.1); }
select.form-input { cursor:pointer; }
textarea.form-input { resize:vertical; min-height:60px; }
.modal-actions { display:flex; gap:10px; justify-content:flex-start; margin-top:18px; }

.category-section { margin-bottom:20px; }
.category-header {
  display:flex; align-items:center; gap:10px;
  padding:12px 16px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius) var(--radius) 0 0;
  cursor:pointer;
}
.category-header h3 { font-size:13px; font-weight:600; flex:1; }
.category-count {
  background:var(--surface2); padding:2px 10px;
  border-radius:10px; font-size:11px; color:var(--text2);
}
.category-tasks {
  border:1px solid var(--border); border-top:none;
  border-radius:0 0 var(--radius) var(--radius);
  overflow:hidden;
}
.category-tasks.collapsed { display:none; }

.progress-bar { height:5px; background:var(--surface3); border-radius:3px; overflow:hidden; }
.progress-fill { height:100%; border-radius:3px; transition:width 0.5s ease; }

.kpi-grid {
  display:grid; grid-template-columns:repeat(3,1fr); gap:12px;
  margin-bottom:20px;
}
.kpi-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:16px;
  box-shadow:var(--shadow-sm);
}
.kpi-card h4 { font-size:12px; color:var(--text2); margin-bottom:10px; }

::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:#ccd0d8; border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:#b0b5bf; }

@media (max-width:1200px) {
  .stats-grid { grid-template-columns:repeat(2,1fr); }
  .kpi-grid { grid-template-columns:repeat(2,1fr); }
}

@keyframes fadeIn {
  from { opacity:0; transform:translateY(4px); }
  to { opacity:1; transform:translateY(0); }
}

.task-name-cell { cursor:pointer; }
.task-name-cell:hover { color:var(--accent); }

.tab-content { display:none; }
.tab-content.active { display:block; animation:fadeIn 0.2s ease; }

/* Toast notification */
.toast {
  position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
  background:#172b4d; color:#fff;
  padding:10px 24px; border-radius:var(--radius); font-size:13px;
  z-index:500; transition: opacity 0.3s, transform 0.3s;
  box-shadow:0 8px 24px rgba(0,0,0,0.15);
}
.toast.hide { opacity:0; transform:translateX(-50%) translateY(10px); }

/* Export panel */
/* Task Bank */
.bank-layout { display:grid; grid-template-columns:1fr 320px; gap:16px; }
.bank-main { }
.bank-sidebar { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px; position:sticky; top:80px; max-height:calc(100vh - 100px); overflow-y:auto; box-shadow:var(--shadow-sm); }
.bank-sidebar h3 { font-size:14px; margin-bottom:12px; }
.bank-cards { display:flex; flex-direction:column; gap:8px; }
.bank-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:12px 14px; cursor:grab; transition:all 0.15s; box-shadow:var(--shadow-sm); }
.bank-card:hover { border-color:var(--accent); background:rgba(74,108,247,0.03); }
.bank-card.dragging { opacity:0.4; }
.bank-card-title { font-size:13px; font-weight:500; margin-bottom:4px; }
.bank-card-meta { display:flex; gap:8px; font-size:11px; color:var(--text2); flex-wrap:wrap; align-items:center; }
.bank-cat-group { margin-bottom:20px; }
.bank-cat-header { display:flex; align-items:center; gap:8px; padding:8px 0; font-size:14px; font-weight:600; border-bottom:1px solid var(--border); margin-bottom:10px; cursor:pointer; }
.bank-cat-header:hover { color:var(--accent); }
.bank-count { background:var(--surface3); padding:1px 8px; border-radius:10px; font-size:11px; color:var(--text2); font-weight:400; }
.bank-assign-zone { min-height:60px; border:2px dashed var(--border); border-radius:10px; display:flex; align-items:center; justify-content:center; color:var(--text2); font-size:12px; padding:12px; transition:all 0.2s; margin-bottom:8px; }
.bank-assign-zone.drag-over { border-color:var(--accent); background:rgba(74,108,247,0.06); color:var(--accent); }
.bank-assign-panel { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:14px; margin-bottom:12px; }
.bank-assign-panel h4 { font-size:13px; margin-bottom:8px; display:flex; align-items:center; gap:6px; }
.bank-search { width:100%; padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-family:'Heebo',sans-serif; font-size:13px; outline:none; margin-bottom:12px; }
.bank-search:focus { border-color:var(--accent); }
.bank-stat-row { display:flex; gap:12px; margin-bottom:16px; }
.bank-stat { flex:1; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:10px; text-align:center; }
.bank-stat .num { font-size:22px; font-weight:700; }
.bank-stat .lbl { font-size:10px; color:var(--text2); margin-top:2px; }

.export-panel {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:14px 18px; margin-bottom:16px;
  display:flex; align-items:center; gap:12px; flex-wrap:wrap;
  box-shadow:var(--shadow-sm);
}
.export-panel .label { font-size:12px; color:var(--text2); }

/* WORKLOAD */
.workload-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-bottom:20px; }
.workload-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow-sm); }
.workload-card h3 { font-size:14px; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.wl-bar-row { display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:11px; }
.wl-bar-row .wl-label { width:50px; color:var(--text2); text-align:left; }
.wl-bar-row .wl-track { flex:1; height:18px; background:var(--surface3); border-radius:4px; overflow:hidden; position:relative; }
.wl-bar-row .wl-fill { height:100%; border-radius:4px; transition:width 0.4s; display:flex; align-items:center; justify-content:center; font-size:9px; color:#fff; font-weight:600; }
.wl-bar-row .wl-fill.overload { background:var(--red)!important; }
.wl-week-grid { display:grid; grid-template-columns:repeat(13,1fr); gap:3px; margin-top:12px; }
.wl-week-cell { text-align:center; font-size:9px; padding:3px; border-radius:4px; }

/* WEEK VIEW */
.week-grid { display:grid; grid-template-columns:260px repeat(5,1fr); gap:1px; background:var(--border); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; }
.week-header { background:var(--surface2); padding:10px; text-align:center; font-size:12px; font-weight:600; color:var(--text2); }
.week-header.today-h { background:var(--accent); color:#fff; font-weight:700; }
.week-member { background:var(--surface2); padding:10px; display:flex; align-items:center; gap:8px; font-size:13px; font-weight:500; }
.week-cell { background:var(--surface); padding:6px; min-height:80px; }
.week-task { padding:4px 6px; border-radius:4px; font-size:10px; margin-bottom:3px; cursor:pointer; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.week-task:hover { opacity:0.8; }

/* TIME TRACKER */
.timer-widget { display:inline-flex; align-items:center; gap:6px; background:var(--surface3); border-radius:8px; padding:4px 10px; font-size:12px; font-family:'Courier New',monospace; }
.timer-btn { background:none; border:none; cursor:pointer; font-size:14px; padding:2px; }
.timer-display { min-width:60px; text-align:center; font-weight:600; }
.time-logged { font-size:11px; color:var(--text2); margin-top:4px; }

/* KANBAN */
.kanban-container { display:flex; gap:12px; overflow-x:auto; padding-bottom:12px; }
.kanban-column { min-width:260px; flex:1; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; }
.kanban-col-header { padding:12px 14px; font-size:12px; font-weight:600; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:var(--surface); }
.kanban-col-header .col-count { background:var(--surface3); padding:2px 8px; border-radius:8px; font-size:11px; color:var(--text2); }
.kanban-col-body { padding:8px; min-height:120px; }
.kanban-card { background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:10px; margin-bottom:8px; cursor:grab; transition:box-shadow 0.15s, opacity 0.15s; font-size:12px; box-shadow:var(--shadow-sm); }
.kanban-card:hover { box-shadow:var(--shadow-md); }
.kanban-card.dragging { opacity:0.4; }
.kanban-card .kc-title { font-weight:500; margin-bottom:6px; }
.kanban-card .kc-meta { display:flex; align-items:center; gap:6px; font-size:10px; color:var(--text2); }
.kanban-col-body.drag-over, .kanban-column.drag-over { background:rgba(74,108,247,0.05); }

/* Burndown Chart */
.burndown-canvas { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow-sm); }
.burndown-svg { width:100%; height:320px; }
.burndown-legend { display:flex; gap:20px; margin-top:12px; justify-content:center; }
.burndown-legend span { font-size:12px; display:flex; align-items:center; gap:6px; }
.burndown-legend span::before { content:''; width:12px; height:3px; border-radius:2px; }
.burndown-controls { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }

/* Activity Log */
.activity-log { max-height:70vh; overflow-y:auto; }
.log-entry { display:flex; gap:12px; padding:12px 16px; border-bottom:1px solid var(--border); font-size:13px; align-items:flex-start; }
.log-entry:hover { background:rgba(74,108,247,0.03); }
.log-time { color:var(--text2); font-size:11px; min-width:120px; white-space:nowrap; }
.log-icon { font-size:16px; min-width:24px; text-align:center; }
.log-text { flex:1; line-height:1.5; }
.log-text strong { color:var(--accent); }
.log-filter-bar { display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap; align-items:center; }

/* Reports */
.report-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.report-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow-sm); }
.report-card h3 { font-size:14px; margin-bottom:14px; display:flex; align-items:center; gap:8px; }
.report-card .big-num { font-size:32px; font-weight:700; }
.report-table { width:100%; border-collapse:collapse; font-size:12px; }
.report-table th { text-align:right; padding:8px 6px; border-bottom:2px solid var(--border); color:var(--text2); font-weight:500; }
.report-table td { padding:8px 6px; border-bottom:1px solid var(--border); }
.report-bar { height:6px; border-radius:3px; background:var(--surface3); overflow:hidden; }
.report-bar-fill { height:100%; border-radius:3px; transition:width 0.3s; }
.report-period { display:flex; gap:8px; margin-bottom:16px; }

/* Velocity */
.velocity-chart { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow-sm); }
.velocity-bars { display:flex; align-items:flex-end; gap:6px; height:200px; padding:0 4px; }
.vel-bar-wrap { flex:1; display:flex; flex-direction:column; align-items:center; gap:4px; height:100%; justify-content:flex-end; }
.vel-bar { width:100%; border-radius:6px 6px 0 0; min-height:4px; transition:height 0.4s; position:relative; }
.vel-bar:hover { filter:brightness(1.2); }
.vel-label { font-size:9px; color:var(--text2); text-align:center; white-space:nowrap; }
.vel-val { font-size:10px; font-weight:600; }
.velocity-stats { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:18px; }
.vel-stat { background:var(--surface); border:1px solid var(--border); padding:12px; border-radius:var(--radius); text-align:center; box-shadow:var(--shadow-sm); }
.vel-stat .num { font-size:24px; font-weight:700; }
.vel-stat .lbl { font-size:11px; color:var(--text2); }

/* Dependencies */
.dep-graph { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; overflow-x:auto; box-shadow:var(--shadow-sm); }
.dep-list { display:flex; flex-direction:column; gap:8px; }
.dep-row { display:flex; align-items:center; gap:10px; padding:10px 14px; background:var(--surface); border-radius:6px; border:1px solid var(--border); font-size:13px; transition:background 0.15s; }
.dep-row:hover { background:rgba(74,108,247,0.03); }
.dep-arrow { color:var(--accent); font-size:18px; min-width:30px; text-align:center; }
.dep-task { padding:6px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); cursor:pointer; }
.dep-task:hover { border-color:var(--accent); }
.dep-task.blocked { border-color:var(--red); background:var(--red-bg); }
.dep-task.done { border-color:var(--green); opacity:0.7; }
.dep-add-bar { display:flex; gap:8px; margin-bottom:16px; align-items:center; flex-wrap:wrap; }
.dep-chain { display:flex; flex-direction:column; gap:2px; }
.dep-chain-label { font-size:10px; color:var(--text2); padding:2px 8px; }

/* Subtasks */
.subtask-list { display:flex; flex-direction:column; gap:4px; margin-top:6px; }
.subtask-item { display:flex; align-items:center; gap:8px; padding:6px 10px; background:var(--surface2); border-radius:6px; font-size:12px; }
.subtask-item input[type=checkbox] { accent-color:var(--accent); width:16px; height:16px; cursor:pointer; }
.subtask-item .st-text { flex:1; }
.subtask-item .st-text.done { text-decoration:line-through; color:var(--text2); }
.subtask-item .st-del { background:none; border:none; color:var(--red); cursor:pointer; font-size:14px; opacity:0.5; }
.subtask-item .st-del:hover { opacity:1; }
.subtask-add { display:flex; gap:6px; margin-top:6px; }
.subtask-add input { flex:1; padding:6px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:12px; font-family:'Heebo'; }
.subtask-progress { display:flex; align-items:center; gap:8px; font-size:11px; color:var(--text2); margin-top:4px; }

/* Tags */
.tag { display:inline-flex; align-items:center; gap:3px; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:500; cursor:pointer; transition:opacity 0.15s; }
.tag:hover { opacity:0.8; }
.tag-remove { background:none; border:none; color:inherit; font-size:12px; cursor:pointer; opacity:0.6; padding:0; margin:0 -2px 0 2px; }
.tag-remove:hover { opacity:1; }
.tags-wrap { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
.tag-input-wrap { display:flex; gap:6px; margin-top:6px; }
.tag-input-wrap input { flex:1; padding:5px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:12px; font-family:'Heebo'; }
.tag-presets { display:flex; flex-wrap:wrap; gap:4px; margin-top:6px; }
.tag-preset { padding:2px 8px; border-radius:10px; font-size:10px; cursor:pointer; border:1px dashed var(--border); color:var(--text2); transition:all 0.15s; }
.tag-preset:hover { border-color:var(--accent); color:var(--accent); }

/* Recurring */
.recur-badge { display:inline-flex; align-items:center; gap:3px; padding:2px 7px; border-radius:8px; font-size:10px; background:var(--blue-bg); color:var(--blue); }

/* Comments */
.comments-section { margin-top:4px; }
.comment-list { max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
.comment-item { padding:8px 12px; background:var(--surface2); border-radius:8px; font-size:12px; position:relative; }
.comment-item:hover { background:var(--surface3); }
.comment-header { display:flex; align-items:center; gap:6px; margin-bottom:4px; }
.comment-author { font-weight:600; font-size:11px; }
.comment-time { font-size:10px; color:var(--text2); }
.comment-text { line-height:1.5; white-space:pre-wrap; }
.comment-text .mention { color:var(--accent); font-weight:500; cursor:pointer; }
.comment-text .mention:hover { text-decoration:underline; }
.comment-input-wrap { display:flex; gap:6px; }
.comment-input-wrap textarea { flex:1; padding:8px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:12px; font-family:'Heebo'; resize:none; min-height:36px; }
.comment-input-wrap textarea:focus { border-color:var(--accent); outline:none; }
.comment-del { position:absolute; top:6px; left:6px; background:none; border:none; color:var(--red); cursor:pointer; font-size:12px; opacity:0; transition:opacity 0.15s; }
.comment-item:hover .comment-del { opacity:0.6; }
.comment-del:hover { opacity:1 !important; }
.comment-count { font-size:10px; color:var(--text2); }

/* Notifications */
.notif-bell { position:relative; cursor:pointer; font-size:20px; }
.notif-badge { position:absolute; top:-4px; right:-6px; background:var(--red); color:#fff; font-size:9px; width:16px; height:16px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; }
.notif-backdrop { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.2); z-index:149; }
.notif-backdrop.open { display:block; }
.notif-panel { position:fixed; top:0; left:0; width:360px; height:100vh; background:var(--surface); border-left:1px solid var(--border); z-index:150; transform:translateX(-400px); transition:transform 0.25s; overflow-y:auto; box-shadow:4px 0 24px rgba(0,0,0,0.1); }
.notif-panel.open { transform:translateX(0); }
.notif-panel-header { padding:16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.notif-item { padding:12px 16px; border-bottom:1px solid var(--border); font-size:12px; cursor:pointer; transition:background 0.15s; }
.notif-item:hover { background:var(--surface2); }
.notif-item.unread { background:rgba(74,108,247,0.05); border-right:3px solid var(--accent); }
.notif-item .notif-title { font-weight:500; margin-bottom:3px; }
.notif-item .notif-desc { color:var(--text2); font-size:11px; }
.notif-item .notif-time { color:var(--text2); font-size:10px; margin-top:4px; }
.notif-empty { text-align:center; padding:40px; color:var(--text2); }

/* Mentions dropdown */
.mention-dropdown { position:absolute; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow-md); z-index:200; min-width:150px; }
.mention-option { padding:8px 12px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:6px; }
.mention-option:hover { background:var(--surface2); }

/* Dark Theme */
body.light { --bg:#0f0f13; --surface:#1a1a24; --surface2:#22222f; --surface3:#2a2a3a; --border:#333346; --text:#e8e8f0; --text2:#9999b0; }
body.light .sidebar { background:#1a1a24; border-left-color:#333346; }
body.light .sidebar-header { background:#22222f; }
body.light .topbar { background:rgba(15,15,19,0.85); border-bottom-color:#333346; }
body.light .modal { background:#1a1a24; }
body.light .form-input { background:#22222f; border-color:#333346; color:#e8e8f0; }
body.light .search-box { background:#22222f; border-color:#333346; color:#e8e8f0; }
body.light .btn-secondary { background:#22222f; border-color:#333346; color:#e8e8f0; }
body.light .nav-item:hover { background:rgba(74,108,247,0.1); }
body.light .toast { background:#333; color:#fff; }
body.light .gantt-row:nth-child(even) { background:rgba(255,255,255,0.02); }
body.light .gantt-row:hover { background:rgba(255,255,255,0.03); }
body.light .gantt-day-cell { border-left-color:rgba(51,51,70,0.2); }
body.light .gantt-day-header { border-left-color:rgba(51,51,70,0.3); }
body.light .gantt-day-header.weekend, body.light .gantt-day-cell.weekend { background:rgba(255,255,255,0.02); }

/* Theme Toggle */
.theme-toggle { display:flex; align-items:center; gap:8px; padding:8px 16px; cursor:pointer; font-size:12px; color:var(--text2); border-top:1px solid var(--border); }
.theme-toggle:hover { color:var(--text); }
.toggle-track { width:36px; height:20px; border-radius:10px; background:var(--surface3); position:relative; transition:background 0.25s; }
.toggle-track.on { background:var(--accent); }
.toggle-knob { width:16px; height:16px; border-radius:50%; background:#fff; position:absolute; top:2px; right:2px; transition:transform 0.25s; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
.toggle-track.on .toggle-knob { transform:translateX(-16px); }

/* Personal Timeline */
.timeline-container { position:relative; padding-right:30px; }
.timeline-line { position:absolute; right:14px; top:0; bottom:0; width:2px; background:var(--border); }
.timeline-item { position:relative; margin-bottom:14px; padding:12px 16px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); margin-right:20px; cursor:pointer; transition:border-color 0.15s; box-shadow:var(--shadow-sm); }
.timeline-item:hover { border-color:var(--accent); }
.timeline-dot { position:absolute; right:-27px; top:16px; width:10px; height:10px; border-radius:50%; border:2px solid var(--bg); z-index:2; }
.timeline-date-group { font-size:13px; font-weight:600; color:var(--accent); margin:18px 0 8px 0; padding-right:24px; }
.timeline-filter { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; align-items:center; }

/* Custom Dashboard Widgets */
.dash-widgets { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:14px; }
.dash-widget { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px; min-height:120px; position:relative; box-shadow:var(--shadow-sm); }
.dash-widget-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.dash-widget-title { font-size:13px; font-weight:600; }
.widget-toggle { display:flex; gap:4px; flex-wrap:wrap; margin-bottom:14px; }
.widget-chip { padding:4px 10px; border-radius:8px; font-size:11px; cursor:pointer; border:1px solid var(--border); background:var(--surface2); color:var(--text2); transition:all 0.15s; }
.widget-chip.active { background:var(--accent); color:#fff; border-color:var(--accent); }

/* Success Animations */
.confetti-container { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; overflow:hidden; }
.confetti { position:absolute; width:8px; height:8px; border-radius:2px; animation:confettiFall 2.5s ease-out forwards; }
@keyframes confettiFall { 0%{transform:translateY(-20px) rotate(0deg);opacity:1;} 100%{transform:translateY(100vh) rotate(720deg);opacity:0;} }
.success-flash { animation:flashGreen 0.6s ease; }
@keyframes flashGreen { 0%{box-shadow:0 0 0 0 rgba(0,184,148,0.5);} 50%{box-shadow:0 0 20px 10px rgba(0,184,148,0.3);} 100%{box-shadow:none;} }
.checkmark-anim { display:inline-block; animation:popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275); }
@keyframes popIn { 0%{transform:scale(0);} 100%{transform:scale(1);} }

/* Hours vs Pricing */
.pricing-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.pricing-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow-sm); }
.pricing-table { width:100%; border-collapse:collapse; font-size:12px; }
.pricing-table th { text-align:right; padding:8px 6px; border-bottom:2px solid var(--border); color:var(--text2); font-weight:500; }
.pricing-table td { padding:8px 6px; border-bottom:1px solid var(--border); }
.pricing-input { width:70px; padding:4px 6px; background:var(--surface2); border:1px solid var(--border); border-radius:4px; color:var(--text); font-size:12px; text-align:center; font-family:'Heebo'; }
.profit-positive { color:var(--green); font-weight:600; }
.profit-negative { color:var(--red); font-weight:600; }

/* Client Dashboard */
.client-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px; }
.client-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px; transition:border-color 0.15s; cursor:pointer; box-shadow:var(--shadow-sm); }
.client-card:hover { border-color:var(--accent); }
.client-status { display:inline-flex; padding:3px 8px; border-radius:6px; font-size:10px; font-weight:500; }
.client-add-bar { display:flex; gap:8px; margin-bottom:16px; }

/* OKR Tracker */
.okr-container { display:flex; flex-direction:column; gap:16px; }
.okr-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow-sm); }
.okr-objective { font-size:15px; font-weight:600; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.kr-item { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid var(--border); }
.kr-item:last-child { border-bottom:none; }
.kr-progress { flex:1; }
.kr-value { font-size:20px; font-weight:700; min-width:50px; text-align:center; }
.okr-add-bar { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
</style>

<!-- Firebase SDKs (compat version for simple use) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;">
  <div style="background:var(--surface);border-radius:16px;padding:48px 40px;text-align:center;box-shadow:var(--shadow-md);max-width:400px;width:90%;">
    <div style="font-size:48px;margin-bottom:12px;">ğŸ¬</div>
    <h1 style="font-size:24px;font-weight:700;margin-bottom:6px;color:var(--text);">Studio Manager</h1>
    <p style="font-size:14px;color:var(--text2);margin-bottom:32px;">× ×™×”×•×œ ×¡×˜×•×“×™×• ×× ×™××¦×™×” ×•×ª×œ×ª-××™××“</p>
    <button id="googleSignInBtn" onclick="signInWithGoogle()" style="display:inline-flex;align-items:center;gap:10px;padding:12px 28px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-family:inherit;font-size:15px;font-weight:500;color:var(--text);transition:all 0.2s;box-shadow:var(--shadow-sm);">
      <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59A14.5 14.5 0 019.5 24c0-1.59.28-3.14.76-4.59l-7.98-6.19A23.99 23.99 0 000 24c0 3.77.87 7.35 2.56 10.78l7.97-6.19z"/><path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      ×”×ª×—×‘×¨ ×¢× Google
    </button>
    <p id="loginError" style="margin-top:16px;color:var(--red);font-size:13px;display:none;"></p>
    <p id="loginLoading" style="margin-top:16px;color:var(--text2);font-size:13px;display:none;">â³ ××ª×—×‘×¨...</p>
  </div>
</div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h1>ğŸ¬ Studio Manager</h1>
    <p>× ×™×”×•×œ ×¡×˜×•×“×™×• ×× ×™××¦×™×” ×•×ª×œ×ª-××™××“</p>
  </div>
  <div class="sidebar-nav">
    <div class="nav-item active" onclick="switchView('dashboard',this)">
      <span class="icon">ğŸ“Š</span> ×“×©×‘×•×¨×“
    </div>
    <div class="nav-item" onclick="switchView('bank',this)">
      <span class="icon">ğŸ¦</span> ×‘× ×§ ××©×™××•×ª
    </div>
    <div class="nav-item" onclick="switchView('tasks',this)">
      <span class="icon">ğŸ“‹</span> ××©×™××•×ª
    </div>
    <div class="nav-item" onclick="switchView('gantt',this)">
      <span class="icon">ğŸ“…</span> ×’×× ×˜
    </div>
    <div class="nav-item" onclick="switchView('calendar',this)">
      <span class="icon">ğŸ—“ï¸</span> ×§×œ× ×“×¨
    </div>
    <div class="nav-item" onclick="switchView('categories',this)">
      <span class="icon">ğŸ“</span> ×œ×¤×™ ×§×˜×’×•×¨×™×”
    </div>
    <div class="nav-item" onclick="switchView('workload',this)">
      <span class="icon">âš–ï¸</span> ×¢×•××¡×™×
    </div>
    <div class="nav-item" onclick="switchView('weekview',this)">
      <span class="icon">ğŸ“†</span> ×©×‘×•×¢ × ×•×›×—×™
    </div>
    <div class="nav-item" onclick="switchView('kanban',this)">
      <span class="icon">ğŸ”²</span> ×§× ×‘××Ÿ
    </div>
    <div class="nav-item" onclick="switchView('burndown',this)">
      <span class="icon">ğŸ“‰</span> ×‘×¨× ×“××•×Ÿ
    </div>
    <div class="nav-item" onclick="switchView('activitylog',this)">
      <span class="icon">ğŸ“</span> ×œ×•×’ ×¤×¢×™×œ×•×ª
    </div>
    <div class="nav-item" onclick="switchView('reports',this)">
      <span class="icon">ğŸ“Š</span> ×“×•×—×•×ª
    </div>
    <div class="nav-item" onclick="switchView('velocity',this)">
      <span class="icon">ğŸš€</span> ××”×™×¨×•×ª
    </div>
    <div class="nav-item" onclick="switchView('dependencies',this)">
      <span class="icon">ğŸ”—</span> ×ª×œ×•×™×•×ª
    </div>
    <div class="nav-item" onclick="switchView('timeline',this)">
      <span class="icon">ğŸ“Œ</span> ×¦×™×¨ ×–××Ÿ ××™×©×™
    </div>
    <div class="nav-item" onclick="switchView('pricing',this)">
      <span class="icon">ğŸ’°</span> ×©×¢×•×ª ×•×ª××—×•×¨
    </div>
    <div class="nav-item" onclick="switchView('clients',this)">
      <span class="icon">ğŸ¢</span> ×œ×§×•×—×•×ª
    </div>
    <div class="nav-item" onclick="switchView('okr',this)">
      <span class="icon">ğŸ¯</span> OKR
    </div>
  </div>
  <div class="team-section">
    <h3>×¦×•×•×ª</h3>
    <div class="team-member"><div class="avatar avatar-rubi">×¨</div> ×¨×•×‘×™ - ××™×™×¡×“</div>
    <div class="team-member"><div class="avatar avatar-gilad">×’</div> ×’×œ×¢×“ - ××™×™×¡×“</div>
    <div class="team-member"><div class="avatar avatar-dana">×“</div> ×“× ×” - ××¢×¦×‘×ª</div>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()">
    <span>ğŸŒ™</span>
    <div class="toggle-track" id="themeToggle"><div class="toggle-knob"></div></div>
    <span id="themeLabel">××¦×‘ ×›×”×”</span>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <div class="topbar-right">
      <span class="topbar-title" id="viewTitle">ğŸ“Š ×“×©×‘×•×¨×“</span>
    </div>
    <div class="topbar-left">
      <input class="search-box" placeholder="×—×™×¤×•×© ××©×™××•×ª..." id="searchBox" oninput="filterTasks()">
      <button class="btn btn-primary" onclick="openAddTask()">+ ××©×™××” ×—×“×©×”</button>
      <button class="btn btn-google" onclick="exportAllToGCal()">ğŸ“… ×™×™×¦×•× ×œ-Google Calendar</button>
      <button class="btn btn-secondary" onclick="exportICS()">â¬‡ï¸ ICS</button>
      <div class="notif-bell" onclick="toggleNotifPanel()" id="notifBell">ğŸ””<span class="notif-badge" id="notifBadge" style="display:none;">0</span></div>
      <div id="userInfo" style="display:flex;align-items:center;gap:8px;margin-right:8px;"></div>
    </div>
  </div>

  <!-- Notification Panel -->
  <div class="notif-backdrop" id="notifBackdrop" onclick="toggleNotifPanel()"></div>
  <div class="notif-panel" id="notifPanel">
    <div class="notif-panel-header">
      <h3 style="font-size:15px;">ğŸ”” ×”×ª×¨××•×ª</h3>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-secondary btn-sm" onclick="markAllNotifsRead()">×¡××Ÿ ×›× ×§×¨×</button>
        <button style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:18px;" onclick="toggleNotifPanel()">âœ•</button>
      </div>
    </div>
    <div id="notifList"></div>
  </div>

  <div class="content">
    <!-- DASHBOARD -->
    <div class="tab-content active" id="view-dashboard">
      <div class="widget-toggle" id="widgetToggle"></div>
      <div class="stats-grid" id="statsGrid"></div>
      <div class="kpi-grid" id="kpiGrid"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;">
          <h3 style="font-size:14px;margin-bottom:14px;">ğŸ“Œ ××©×™××•×ª ×“×—×•×¤×•×ª</h3>
          <div id="urgentTasks"></div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;">
          <h3 style="font-size:14px;margin-bottom:14px;">ğŸ“Š ×”×ª×§×“××•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”</h3>
          <div id="recentActivity"></div>
        </div>
      </div>
    </div>

    <!-- TASKS -->
    <div class="tab-content" id="view-tasks">
      <div class="filters-bar" id="filtersBar"></div>
      <div class="task-table-wrap">
        <table class="task-table">
          <thead>
            <tr>
              <th onclick="sortTasks('priority')" style="width:50px">×¢×“×™×¤×•×ª</th>
              <th onclick="sortTasks('name')">××©×™××”</th>
              <th onclick="sortTasks('category')">×§×˜×’×•×¨×™×”</th>
              <th onclick="sortTasks('assignee')">××—×¨××™</th>
              <th onclick="sortTasks('status')">×¡×˜×˜×•×¡</th>
              <th onclick="sortTasks('deadline')">×“×“-×œ×™×™×Ÿ</th>
              <th onclick="sortTasks('goal')">×™×¢×“</th>
              <th style="width:80px">×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody id="taskTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- GANTT -->
    <div class="tab-content" id="view-gantt">
      <div class="export-panel">
        <span class="label">×¡×™× ×•×Ÿ:</span>
        <div class="filter-chip active" onclick="ganttFilter('all',this)">×”×›×œ</div>
        <div class="filter-chip" onclick="ganttFilter('rubi',this)">×¨×•×‘×™</div>
        <div class="filter-chip" onclick="ganttFilter('gilad',this)">×’×œ×¢×“</div>
        <div class="filter-chip" onclick="ganttFilter('dana',this)">×“× ×”</div>
        <span style="flex:1;"></span>
        <span class="label" style="font-size:11px;">ğŸ–±ï¸ ×’×¨×•×¨ ×¤×¡×™× ×œ×©×™× ×•×™ ×ª××¨×™×›×™× | ×’×¨×•×¨ ×§×¦×•×•×ª ×œ×©×™× ×•×™ ××•×¨×š</span>
      </div>
      <div class="gantt-container" id="ganttContainer"></div>
    </div>

    <!-- CALENDAR -->
    <div class="tab-content" id="view-calendar">
      <div class="cal-nav">
        <div class="cal-nav-btns">
          <button class="btn btn-secondary btn-sm" onclick="calNav(-1)">â†’</button>
          <button class="btn btn-secondary btn-sm" onclick="calNav(0)">×”×™×•×</button>
          <button class="btn btn-secondary btn-sm" onclick="calNav(1)">â†</button>
        </div>
        <h2 id="calTitle"></h2>
        <span style="font-size:11px;color:var(--text2);">ğŸ–±ï¸ ×’×¨×•×¨ ××©×™××•×ª ×‘×™×Ÿ ×™××™×</span>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- CATEGORIES -->
    <div class="tab-content" id="view-categories">
      <div id="categoriesContainer"></div>
    </div>

    <!-- WORKLOAD -->
    <div class="tab-content" id="view-workload">
      <div class="workload-grid" id="workloadCards"></div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;">
        <h3 style="font-size:14px;margin-bottom:14px;">ğŸ“Š ×¢×•××¡ ×©×‘×•×¢×™ - 13 ×©×‘×•×¢×•×ª</h3>
        <div id="workloadHeatmap"></div>
      </div>
    </div>

    <!-- WEEK VIEW -->
    <div class="tab-content" id="view-weekview">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary btn-sm" onclick="weekNav(-1)">â†’ ×©×‘×•×¢ ×§×•×“×</button>
          <button class="btn btn-secondary btn-sm" onclick="weekNav(0)">×©×‘×•×¢ × ×•×›×—×™</button>
          <button class="btn btn-secondary btn-sm" onclick="weekNav(1)">×©×‘×•×¢ ×”×‘× â†</button>
        </div>
        <h2 id="weekTitle" style="font-size:18px;"></h2>
      </div>
      <div id="weekGrid"></div>
    </div>

    <!-- KANBAN -->
    <div class="tab-content" id="view-kanban">
      <div class="filters-bar" style="margin-bottom:14px;">
        <span style="font-size:12px;color:var(--text2);">×¡×™× ×•×Ÿ ××—×¨××™:</span>
        <div class="filter-chip active" onclick="kanbanFilter('all',this)">×›×•×œ×</div>
        <div class="filter-chip" onclick="kanbanFilter('rubi',this)">×¨×•×‘×™</div>
        <div class="filter-chip" onclick="kanbanFilter('gilad',this)">×’×œ×¢×“</div>
        <div class="filter-chip" onclick="kanbanFilter('dana',this)">×“× ×”</div>
      </div>
      <div class="kanban-container" id="kanbanContainer"></div>
    </div>

    <!-- BURNDOWN -->
    <div class="tab-content" id="view-burndown">
      <div class="burndown-controls">
        <span style="font-size:12px;color:var(--text2);line-height:32px;">×ª×§×•×¤×”:</span>
        <div class="filter-chip active" onclick="setBurndownRange('month',this)">×—×•×“×©</div>
        <div class="filter-chip" onclick="setBurndownRange('quarter',this)">×¨×‘×¢×•×Ÿ</div>
        <div class="filter-chip" onclick="setBurndownRange('all',this)">×”×›×œ</div>
      </div>
      <div class="burndown-canvas" id="burndownChart"></div>
    </div>

    <!-- ACTIVITY LOG -->
    <div class="tab-content" id="view-activitylog">
      <div class="log-filter-bar">
        <span style="font-size:12px;color:var(--text2);">×¡×•×’:</span>
        <div class="filter-chip active" onclick="logFilter('all',this)">×”×›×œ</div>
        <div class="filter-chip" onclick="logFilter('status',this)">×©×™× ×•×™ ×¡×˜×˜×•×¡</div>
        <div class="filter-chip" onclick="logFilter('create',this)">×™×¦×™×¨×”</div>
        <div class="filter-chip" onclick="logFilter('edit',this)">×¢×¨×™×›×”</div>
        <div class="filter-chip" onclick="logFilter('time',this)">×–××Ÿ</div>
      </div>
      <div class="activity-log" id="activityLog"></div>
    </div>

    <!-- REPORTS -->
    <div class="tab-content" id="view-reports">
      <div class="report-period">
        <span style="font-size:12px;color:var(--text2);line-height:32px;">×ª×§×•×¤×”:</span>
        <div class="filter-chip active" onclick="setReportPeriod('week',this)">×©×‘×•×¢×™</div>
        <div class="filter-chip" onclick="setReportPeriod('month',this)">×—×•×“×©×™</div>
        <div class="filter-chip" onclick="setReportPeriod('all',this)">×›×œ×œ×™</div>
      </div>
      <div class="report-grid" id="reportGrid"></div>
    </div>

    <!-- VELOCITY -->
    <div class="tab-content" id="view-velocity">
      <div class="velocity-stats" id="velocityStats"></div>
      <div class="velocity-chart">
        <h3 style="font-size:14px;margin-bottom:14px;">ğŸš€ ××©×™××•×ª ×©×”×•×©×œ××• ×œ×¤×™ ×©×‘×•×¢</h3>
        <div class="velocity-bars" id="velocityBars"></div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:10px;color:var(--text2);padding:0 4px;" id="velocityLabels"></div>
      </div>
      <div style="margin-top:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;">
        <h3 style="font-size:14px;margin-bottom:14px;">ğŸ‘¥ ××”×™×¨×•×ª ×œ×¤×™ ×—×‘×¨ ×¦×•×•×ª</h3>
        <div id="velocityTeam"></div>
      </div>
    </div>

    <!-- DEPENDENCIES -->
    <div class="tab-content" id="view-dependencies">
      <div class="dep-add-bar">
        <span style="font-size:12px;color:var(--text2);">×”×•×¡×£ ×ª×œ×•×ª:</span>
        <select class="form-input" id="depFrom" style="width:200px;padding:6px 10px;font-size:12px;"></select>
        <span style="font-size:16px;">â†’ ×—×•×¡× ××ª â†’</span>
        <select class="form-input" id="depTo" style="width:200px;padding:6px 10px;font-size:12px;"></select>
        <button class="btn btn-primary btn-sm" onclick="addDependency()">â• ×”×•×¡×£</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="dep-graph">
          <h3 style="font-size:14px;margin-bottom:14px;">ğŸ”— ×¨×©×™××ª ×ª×œ×•×™×•×ª</h3>
          <div class="dep-list" id="depList"></div>
        </div>
        <div class="dep-graph">
          <h3 style="font-size:14px;margin-bottom:14px;">âš ï¸ ××©×™××•×ª ×—×¡×•××•×ª</h3>
          <div id="depBlocked"></div>
        </div>
      </div>
    </div>

    <!-- PERSONAL TIMELINE -->
    <div class="tab-content" id="view-timeline">
      <div class="timeline-filter">
        <span style="font-size:12px;color:var(--text2);">×—×‘×¨ ×¦×•×•×ª:</span>
        <div class="filter-chip active" onclick="setTimelinePerson('rubi',this)">×¨×•×‘×™</div>
        <div class="filter-chip" onclick="setTimelinePerson('gilad',this)">×’×œ×¢×“</div>
        <div class="filter-chip" onclick="setTimelinePerson('dana',this)">×“× ×”</div>
      </div>
      <div class="timeline-container" id="timelineContainer"></div>
    </div>

    <!-- HOURS & PRICING -->
    <div class="tab-content" id="view-pricing">
      <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center;">
        <span style="font-size:12px;color:var(--text2);">×ª×¢×¨×™×£ ×©×¢×ª×™ ×‘×¨×™×¨×ª ××—×“×œ: â‚ª</span>
        <input class="pricing-input" id="defaultRate" value="250" onchange="renderPricing()">
      </div>
      <div class="pricing-grid" id="pricingGrid"></div>
    </div>

    <!-- CLIENT DASHBOARD -->
    <div class="tab-content" id="view-clients">
      <div class="client-add-bar">
        <input class="form-input" id="newClientName" placeholder="×©× ×œ×§×•×— ×—×“×©..." style="width:200px;padding:8px 12px;">
        <input class="form-input" id="newClientProject" placeholder="×¤×¨×•×™×§×˜..." style="width:200px;padding:8px 12px;">
        <button class="btn btn-primary btn-sm" onclick="addClient()">â• ×”×•×¡×£ ×œ×§×•×—</button>
      </div>
      <div class="client-grid" id="clientGrid"></div>
    </div>

    <!-- OKR TRACKER -->
    <div class="tab-content" id="view-okr">
      <div class="okr-add-bar">
        <input class="form-input" id="newOkrObj" placeholder="×™×¢×“ ×—×“×© (Objective)..." style="flex:1;padding:8px 12px;">
        <select class="form-input" id="newOkrOwner" style="width:120px;padding:8px;">
          <option value="rubi">×¨×•×‘×™</option><option value="gilad">×’×œ×¢×“</option><option value="dana">×“× ×”</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="addOKR()">â• ×”×•×¡×£ ×™×¢×“</button>
      </div>
      <div class="okr-container" id="okrContainer"></div>
    </div>

    <!-- TASK BANK -->
    <div class="tab-content" id="view-bank">
      <div class="bank-stat-row" id="bankStats"></div>
      <input class="bank-search" id="bankSearch" placeholder="ğŸ” ×—×¤×© ××©×™××•×ª ×‘×‘× ×§..." oninput="renderBank()">
      <div class="bank-layout">
        <div class="bank-main" id="bankMain"></div>
        <div class="bank-sidebar">
          <h3>ğŸ“¤ ×©×™×‘×•×¥ ××©×™××”</h3>
          <p style="font-size:11px;color:var(--text2);margin-bottom:12px;">×’×¨×•×¨ ××©×™××” ×œ×›××Ÿ ××• ×œ×—×¥ ×¢×œ âš¡ ×›×“×™ ×œ×©×‘×¥</p>
          <div class="bank-assign-zone" id="bankDropZone"
            ondragover="event.preventDefault();this.classList.add('drag-over')"
            ondragleave="this.classList.remove('drag-over')"
            ondrop="bankDrop(event)">
            ×’×¨×•×¨ ××©×™××” ×œ×›××Ÿ ×œ×©×™×‘×•×¥
          </div>
          <div id="bankAssignForm" style="display:none;">
            <div class="bank-assign-panel">
              <h4>ğŸ“‹ <span id="bankAssignTaskName"></span></h4>
              <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">××—×¨××™:</label>
              <select class="form-input" id="bankAssignPerson" style="width:100%;padding:8px;margin-bottom:10px;">
                <option value="">-- ×‘×—×¨ ××—×¨××™ --</option>
                <option value="rubi">×¨×•×‘×™</option>
                <option value="gilad">×’×œ×¢×“</option>
                <option value="dana">×“× ×”</option>
              </select>
              <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">×ª××¨×™×š ×”×ª×—×œ×”:</label>
              <input type="date" class="form-input" id="bankAssignStart" style="width:100%;padding:8px;margin-bottom:10px;">
              <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">×ª××¨×™×š ×¡×™×•×:</label>
              <input type="date" class="form-input" id="bankAssignEnd" style="width:100%;padding:8px;margin-bottom:10px;">
              <div style="display:flex;gap:8px;">
                <button class="btn btn-primary btn-sm" onclick="bankAssignConfirm()" style="flex:1;">âœ… ×©×‘×¥</button>
                <button class="btn btn-secondary btn-sm" onclick="bankAssignCancel()">×‘×™×˜×•×œ</button>
              </div>
            </div>
          </div>
          <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px;">
            <h3 style="font-size:13px;margin-bottom:8px;">ğŸ“Œ ××©×™××•×ª ××©×•×‘×¦×•×ª</h3>
            <div id="bankAssignedList" style="font-size:12px;color:var(--text2);"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalContent"></div>
</div>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyC-9uit_eC83a2OjzVLkJbSNF4omX7ZUyI",
  authDomain: "replica-dashboard-52a64.firebaseapp.com",
  databaseURL: "https://replica-dashboard-52a64-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "replica-dashboard-52a64",
  storageBucket: "replica-dashboard-52a64.firebasestorage.app",
  messagingSenderId: "506950396387",
  appId: "1:506950396387:web:47d580b6c178403131d8d6"
};

const ALLOWED_EMAILS = [
  "rubi@replica.works",
  "gilad@replica.works",
  "dana@replica.works"
];

// Map emails to team member IDs
const EMAIL_TO_TEAM = {
  "rubi@replica.works": "rubi",
  "gilad@replica.works": "gilad",
  "dana@replica.works": "dana"
};

// Initialize Firebase
const firebaseApp = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
let currentUser = null;
let currentTeamId = 'rubi';
let dbReady = false;

// ===== AUTH =====
function signInWithGoogle() {
  document.getElementById('googleSignInBtn').style.display = 'none';
  document.getElementById('loginLoading').style.display = 'block';
  document.getElementById('loginError').style.display = 'none';
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err => {
    document.getElementById('googleSignInBtn').style.display = 'inline-flex';
    document.getElementById('loginLoading').style.display = 'none';
    document.getElementById('loginError').style.display = 'block';
    document.getElementById('loginError').textContent = '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + err.message;
  });
}

function signOutUser() {
  auth.signOut();
}

auth.onAuthStateChanged(user => {
  if (user) {
    if (!ALLOWED_EMAILS.includes(user.email)) {
      document.getElementById('loginError').style.display = 'block';
      document.getElementById('loginError').textContent = 'âŒ ××™×Ÿ ×œ×š ×”×¨×©××ª ×’×™×©×”. ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.';
      document.getElementById('googleSignInBtn').style.display = 'inline-flex';
      document.getElementById('loginLoading').style.display = 'none';
      auth.signOut();
      return;
    }
    currentUser = user;
    currentTeamId = EMAIL_TO_TEAM[user.email] || 'rubi';
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('userInfo').innerHTML =
      '<span style="font-size:12px;color:var(--text2);">' + (user.displayName || user.email) + '</span>' +
      '<button onclick="signOutUser()" style="background:none;border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;color:var(--text2);font-family:inherit;">×”×ª× ×ª×§</button>';
    initFirebaseSync();
  } else {
    currentUser = null;
    document.getElementById('loginScreen').style.display = 'flex';
  }
});

// ===== REAL-TIME SYNC =====
function serializeDate(d) {
  if (!d) return null;
  return d instanceof Date ? d.toISOString() : d;
}
function deserializeDate(s) {
  if (!s) return null;
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}
function serializeTasks(tasks) {
  return tasks.map(t => ({
    ...t,
    startDate: serializeDate(t.startDate),
    endDate: serializeDate(t.endDate),
    comments: (t.comments||[]).map(c => ({...c, time: serializeDate(c.time)}))
  }));
}
function deserializeTasks(data) {
  if (!data) return null;
  const arr = Array.isArray(data) ? data : Object.values(data);
  return arr.map(t => ({
    ...t,
    startDate: deserializeDate(t.startDate),
    endDate: deserializeDate(t.endDate),
    subtasks: t.subtasks || [],
    tags: t.tags || [],
    comments: (t.comments||[]).map(c => ({...c, time: deserializeDate(c.time)}))
  }));
}

function saveToDB() {
  if (!dbReady) { console.warn('âš ï¸ saveToDB called but dbReady is false'); return; }
  console.log('ğŸ’¾ Saving', allTasks.length, 'tasks to Firebase...');
  db.ref('tasks').set(serializeTasks(allTasks))
    .then(() => console.log('âœ… Tasks saved successfully'))
    .catch(err => { console.error('âŒ Firebase save FAILED:', err); toast('âŒ ×©×’×™××” ×‘×©××™×¨×”: ' + err.message); });
  db.ref('meta/nextId').set(nextId);
}
let _saveTimer = null;
function saveTasks() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(saveToDB, 400);
}

function initFirebaseSync() {
  console.log('ğŸ”„ Starting Firebase sync...');
  db.ref('tasks').on('value', snap => {
    const data = snap.val();
    console.log('ğŸ“¥ Firebase data received:', data ? 'has data' : 'empty/null');
    if (data) {
      const parsed = deserializeTasks(data);
      if (parsed && parsed.length > 0) {
        console.log('âœ… Loaded', parsed.length, 'tasks from Firebase');
        allTasks = parsed;
        nextId = allTasks.reduce((m, t) => Math.max(m, t.id || 0), 0) + 1;
        dbReady = true;
        generateInitialNotifs();
        updateNotifBadge();
        renderView();
        return;
      }
    }
    // First time â€” generate default tasks and push to DB
    console.log('ğŸ†• No data in Firebase, generating default tasks...');
    allTasks = generateTasks();
    enrichTasks();
    dbReady = true;
    saveToDB();
    generateInitialNotifs();
    updateNotifBadge();
    renderView();
  });
  db.ref('meta/nextId').on('value', snap => {
    const val = snap.val();
    if (val && val > nextId) nextId = val;
  });
}

const TEAM = [
  { id:'rubi', name:'×¨×•×‘×™', role:'××™×™×¡×“', color:'#4a6cf7' },
  { id:'gilad', name:'×’×œ×¢×“', role:'××™×™×¡×“', color:'#36b37e' },
  { id:'dana', name:'×“× ×”', role:'××¢×¦×‘×ª', color:'#e8598b' }
];

const CATEGORIES = [
  { id:'studio', emoji:'ğŸ¢', name:'× ×™×”×•×œ ×”×¡×˜×•×“×™×•', color:'#4a6cf7',
    subs:['× ×™×”×•×œ ×©×œ ×“× ×”','× ×™×§×™×•×Ÿ, ×¡×“×¨, ×”×©×§×™×”','×ª×—×–×•×§×”','×ª×©×ª×™×•×ª','×¡×¤×§×™×','×¨×›×©','××©×¤×˜×™','××“××™× ×™×¡×˜×¨×¦×™×”'] },
  { id:'clients', emoji:'ğŸ‘¥', name:'× ×™×”×•×œ ×œ×§×•×—×•×ª', color:'#2b8ed8',
    subs:['CRM','×œ×™×“×™×','×—×•×–×™×','××•× ×‘×•×¨×“×™× ×’','×’×‘×™×™×”','××©×•×‘','×©×™××•×¨','×¤×¨×•×™×§×˜×™×','×ª×§×©×•×¨×ª'] },
  { id:'social', emoji:'ğŸ“±', name:'×¡×•×©×™××œ', color:'#eb5757',
    subs:['××¡×˜×¨×˜×’×™×”','×§×¨×™××™×™×˜×™×‘','×§×•×¤×™ (×›×ª×™×‘×”)','×ª×–××•×Ÿ','×§×”×™×œ×”','×× ×œ×™×˜×™×§×”'] },
  { id:'product', emoji:'ğŸ› ï¸', name:'×™×¦×™×¨×ª ××•×¦×¨', color:'#36b37e',
    subs:['××—×§×¨','××¤×™×•×Ÿ','×¤×™×ª×•×—','×‘×“×™×§×•×ª (QA)','×”×©×§×”','×ª××—×•×¨'] },
  { id:'design', emoji:'ğŸ¨', name:'× ×™×”×•×œ ×¢×™×¦×•×‘', color:'#e8598b',
    subs:['××™×ª×•×’','××¨×›×™×•×Ÿ','×˜×¨× ×“×™×','×‘×™×§×•×¨×ª (Review)','×›×œ×™×','× ×›×¡×™× (Assets)'] },
  { id:'strategy', emoji:'ğŸ“ˆ', name:'××¡×˜×¨×˜×’×™×” ×•×¦××™×—×”', color:'#f5a623',
    subs:['×—×–×•×Ÿ','×™×¢×“×™×','×—×“×©× ×•×ª','×¦××™×—×” (Scaling)','×¤×™×ª×•×— (R&D)'] },
  { id:'marketing', emoji:'ğŸ–¼ï¸', name:'× ×›×¡×™ ×©×™×•×•×§', color:'#4a9df8',
    subs:['××ª×¨','×ª×™×§ ×¢×‘×•×“×•×ª (Portfolio)','×¤×¨×¡×™×','×™×—"×¦','×”××œ×¦×•×ª (Testimonials)'] },
  { id:'finance', emoji:'ğŸ’°', name:'×¤×™× × ×¡×™×', color:'#8777d9',
    subs:['×¨×•×•×—×™×•×ª','×ª×–×¨×™×','××™×¡×•×™','×ª×§×¦×™×‘','×”×©×§×¢×•×ª'] },
  { id:'knowledge', emoji:'ğŸ§ ', name:'×™×“×¢ ×•×ª×•×›×Ÿ', color:'#4ecdc4',
    subs:['××ª×•×“×•×œ×•×’×™×”','×ª×‘× ×™×•×ª (Templates)','×”×“×¨×›×•×ª','××•×˜×•××¦×™×”','×‘×™× ×” ××œ××›×•×ª×™×ª (AI)'] },
  { id:'networking', emoji:'ğŸŒ', name:'× ×˜×•×•×¨×§×™× ×’', color:'#f7943e',
    subs:['Outreach','×¤×’×™×©×•×ª','×¡×“× ××•×ª','××™×¨×•×¢×™×','×”×¨×¦××•×ª'] }
];

let nextId = 1;
const today = new Date(2026, 1, 16);

function generateTasks() {
  const tasks = [];
  const T = {
    'studio': [
      { sub:'× ×™×”×•×œ ×©×œ ×“× ×”', tasks:[
        { name:'×”×’×“×¨×ª ×™×¢×“×™× ×©×‘×•×¢×™×™× ×œ×“× ×”', goal:'×©×™×¤×•×¨ ×¤×¨×•×“×•×§×˜×™×‘×™×•×ª', priority:'high', assignee:'rubi', ws:0, wl:1 },
        { name:'×¤×’×™×©×ª ××©×•×‘ ×©×‘×•×¢×™×ª ×¢× ×“× ×”', goal:'××¢×§×‘ ×‘×™×¦×•×¢×™×', priority:'medium', assignee:'rubi', ws:0, wl:12 },
        { name:'×‘× ×™×™×ª ×ª×•×›× ×™×ª ×¤×™×ª×•×— ××§×¦×•×¢×™ ×œ×“× ×”', goal:'×©×™××•×¨ ×•×”×¢×¦××ª ×¢×•×‘×“×ª', priority:'medium', assignee:'gilad', ws:2, wl:2 },
      ]},
      { sub:'×ª×©×ª×™×•×ª', tasks:[
        { name:'××™×¤×•×™ ×›×œ×œ ×”×ª×©×ª×™×•×ª ×•×”×¦×™×•×“ ×‘×¡×˜×•×“×™×•', goal:'×¡×“×¨ ×•×ª×—×–×•×§×”', priority:'medium', assignee:'gilad', ws:0, wl:1 },
        { name:'×”×§××ª ×œ×•×— ×ª×—×–×•×§×” ×©×•×˜×¤×ª', goal:'×× ×™×¢×ª ×ª×§×œ×•×ª', priority:'low', assignee:'gilad', ws:1, wl:1 },
      ]},
      { sub:'×¡×¤×§×™×', tasks:[
        { name:'×™×¦×™×¨×ª ×¨×©×™××ª ×¡×¤×§×™× ××•×¢×“×¤×™×', goal:'×™×™×¢×•×œ ×¨×›×©', priority:'low', assignee:'rubi', ws:3, wl:1 },
        { name:'××©× ×•××ª×Ÿ ×¢×œ ×”×¡×›××™ ××¡×’×¨×ª', goal:'×—×™×¡×›×•×Ÿ ×‘×¢×œ×•×™×•×ª', priority:'medium', assignee:'rubi', ws:4, wl:2 },
      ]},
      { sub:'××©×¤×˜×™', tasks:[
        { name:'×”×›× ×ª ×—×•×–×” ×¡×˜× ×“×¨×˜×™ ×œ×œ×§×•×—×•×ª', goal:'×”×’× ×” ××©×¤×˜×™×ª', priority:'high', assignee:'rubi', ws:1, wl:2 },
        { name:'×‘×“×™×§×ª ×‘×™×˜×•×—×™× ×•×›×™×¡×•×™×™×', goal:'× ×™×”×•×œ ×¡×™×›×•× ×™×', priority:'medium', assignee:'gilad', ws:3, wl:1 },
      ]},
      { sub:'××“××™× ×™×¡×˜×¨×¦×™×”', tasks:[
        { name:'×”×§××ª ××¢×¨×›×ª × ×™×”×•×œ ××¡××›×™×', goal:'×¡×“×¨ ×•× ×’×™×©×•×ª', priority:'medium', assignee:'rubi', ws:0, wl:2 },
        { name:'×”×’×“×¨×ª ×ª×”×œ×™×›×™ ×¢×‘×•×“×” ××ª×•×¢×“×™×', goal:'×¢×§×‘×™×•×ª ×ª×¤×¢×•×œ×™×ª', priority:'high', assignee:'gilad', ws:1, wl:3 },
      ]},
    ],
    'clients': [
      { sub:'CRM', tasks:[
        { name:'×‘×—×™×¨×ª ××¢×¨×›×ª CRM ××ª××™××”', goal:'× ×™×”×•×œ ×œ×§×•×—×•×ª ×™×¢×™×œ', priority:'high', assignee:'rubi', ws:0, wl:1 },
        { name:'×”×˜××¢×ª CRM ×•×”×–× ×ª ×œ×§×•×—×•×ª ×§×™×™××™×', goal:'××¢×‘×¨ ×œ×“×™×’×™×˜×œ', priority:'high', assignee:'rubi', ws:1, wl:2 },
      ]},
      { sub:'×œ×™×“×™×', tasks:[
        { name:'×‘× ×™×™×ª ×¤×× ×œ ×œ×™×“×™× ×•××§×•×¨×•×ª', goal:'×”×’×“×œ×ª ×œ×™×“×™×', priority:'high', assignee:'gilad', ws:1, wl:2 },
        { name:'×™×¦×™×¨×ª ×ª×¡×¨×™×˜ ×©×™×—×ª ××›×™×¨×”', goal:'×©×™×¤×•×¨ ×”××¨×•×ª', priority:'medium', assignee:'rubi', ws:2, wl:1 },
      ]},
      { sub:'×—×•×–×™×', tasks:[
        { name:'×¡×˜× ×“×¨×˜×™×–×¦×™×” ×©×œ ×—×•×–×™×', goal:'××”×™×¨×•×ª ×¡×’×™×¨×ª ×¢×¡×§×”', priority:'high', assignee:'rubi', ws:1, wl:2 },
      ]},
      { sub:'××•× ×‘×•×¨×“×™× ×’', tasks:[
        { name:'×‘× ×™×™×ª ×ª×”×œ×™×š ××•× ×‘×•×¨×“×™× ×’ ×œ×œ×§×•×— ×—×“×©', goal:'×—×•×•×™×ª ×œ×§×•×— ××•×©×œ××ª', priority:'high', assignee:'gilad', ws:3, wl:2 },
        { name:'×”×›× ×ª ×¢×¨×›×ª ×§×‘×œ×ª ×¤× ×™× ×œ×œ×§×•×—', goal:'×¨×•×©× ×¨××©×•× ×™ ××¦×•×™×Ÿ', priority:'medium', assignee:'dana', ws:4, wl:2 },
      ]},
      { sub:'×’×‘×™×™×”', tasks:[
        { name:'×”×’×“×¨×ª ×ª× ××™ ×ª×©×œ×•× ×‘×¨×•×¨×™×', goal:'×ª×–×¨×™× ××–×•×× ×™×', priority:'high', assignee:'rubi', ws:0, wl:1 },
        { name:'×”×§××ª ××¢×¨×›×ª ××¢×§×‘ ×—×©×‘×•× ×™×•×ª', goal:'×’×‘×™×™×” ×©×•×˜×¤×ª', priority:'medium', assignee:'rubi', ws:1, wl:1 },
      ]},
      { sub:'××©×•×‘', tasks:[
        { name:'×™×¦×™×¨×ª ×©××œ×•×Ÿ ×©×‘×™×¢×•×ª ×¨×¦×•×Ÿ', goal:'×©×™×¤×•×¨ ×©×™×¨×•×ª', priority:'medium', assignee:'gilad', ws:5, wl:1 },
      ]},
      { sub:'×©×™××•×¨', tasks:[
        { name:'×ª×•×›× ×™×ª ×©×™××•×¨ ×œ×§×•×—×•×ª ×§×™×™××™×', goal:'×”×’×“×œ×ª LTV', priority:'medium', assignee:'rubi', ws:6, wl:2 },
      ]},
      { sub:'×ª×§×©×•×¨×ª', tasks:[
        { name:'×”×’×“×¨×ª ×¢×¨×•×¦×™ ×ª×§×©×•×¨×ª ×¢× ×œ×§×•×—', goal:'×ª×§×©×•×¨×ª ×‘×¨×•×¨×”', priority:'medium', assignee:'gilad', ws:2, wl:1 },
      ]},
    ],
    'social': [
      { sub:'××¡×˜×¨×˜×’×™×”', tasks:[
        { name:'×”×’×“×¨×ª ××¡×˜×¨×˜×’×™×™×ª ×ª×•×›×Ÿ ×œ×¡×•×©×™××œ', goal:'× ×•×›×—×•×ª ×“×™×’×™×˜×œ×™×ª', priority:'high', assignee:'gilad', ws:0, wl:2 },
        { name:'××—×§×¨ ××ª×—×¨×™× ×‘×¨×©×ª×•×ª', goal:'××¡×˜×¨×˜×’×™×” ××‘×•×¡×¡×ª', priority:'medium', assignee:'dana', ws:0, wl:1 },
      ]},
      { sub:'×§×¨×™××™×™×˜×™×‘', tasks:[
        { name:'×¢×™×¦×•×‘ ×ª×‘× ×™×•×ª ×¤×•×¡×˜ (Templates)', goal:'×¢×§×‘×™×•×ª ×•×™×–×•××œ×™×ª', priority:'high', assignee:'dana', ws:1, wl:2 },
        { name:'×™×¦×™×¨×ª 8 ×¤×•×¡×˜×™× ×œ×—×•×“×© ×”×¨××©×•×Ÿ', goal:'×ª×•×›×Ÿ ××•×›×Ÿ', priority:'high', assignee:'dana', ws:2, wl:3 },
        { name:'×”×¤×§×ª ×¨×™×œ / ×¡×¨×˜×•×Ÿ ×§×¦×¨', goal:'×—×©×™×¤×” ×’×‘×•×”×”', priority:'medium', assignee:'gilad', ws:3, wl:2 },
      ]},
      { sub:'×§×•×¤×™ (×›×ª×™×‘×”)', tasks:[
        { name:'×›×ª×™×‘×ª ×‘×™×• ××•×©×œ× ×œ×›×œ ×¤×œ×˜×¤×•×¨××”', goal:'××™×§×•×“ ××¡×¨×™×', priority:'medium', assignee:'rubi', ws:1, wl:1 },
        { name:'×‘× ×™×™×ª ×‘× ×§ ××©×¤×˜×™ ×©×™×•×•×§×™×™×', goal:'×™×¢×™×œ×•×ª ×›×ª×™×‘×”', priority:'low', assignee:'rubi', ws:4, wl:2 },
      ]},
      { sub:'×ª×–××•×Ÿ', tasks:[
        { name:'×‘×—×™×¨×ª ×›×œ×™ ×ª×–××•×Ÿ ×¤×•×¡×˜×™×', goal:'××•×˜×•××¦×™×”', priority:'medium', assignee:'gilad', ws:2, wl:1 },
        { name:'×”×§××ª ×œ×•×— ×ª×•×›×Ÿ ×—×•×“×©×™', goal:'×¢×§×‘×™×•×ª ×¤×¨×¡×•×', priority:'high', assignee:'gilad', ws:3, wl:1 },
      ]},
      { sub:'×× ×œ×™×˜×™×§×”', tasks:[
        { name:'×”×’×“×¨×ª KPIs ×œ×¡×•×©×™××œ', goal:'××“×™×“×ª ×”×¦×œ×—×”', priority:'medium', assignee:'rubi', ws:1, wl:1 },
        { name:'×“×•×— ×‘×™×¦×•×¢×™× ×—×•×“×©×™ ×¨××©×•×Ÿ', goal:'× ×™×ª×•×— ×•×©×™×¤×•×¨', priority:'medium', assignee:'gilad', ws:8, wl:1 },
      ]},
    ],
    'product': [
      { sub:'××—×§×¨', tasks:[
        { name:'××™×¤×•×™ ×¦×¨×›×™ ×©×•×§ ×œ×©×™×¨×•×ª×™ ×× ×™××¦×™×”', goal:'×”×‘× ×ª ×”×‘×™×§×•×©', priority:'high', assignee:'rubi', ws:0, wl:2 },
        { name:'× ×™×ª×•×— ××ª×—×¨×™× ×•×ª××—×•×¨', goal:'××™×¦×•×‘ ×‘×©×•×§', priority:'high', assignee:'gilad', ws:0, wl:2 },
      ]},
      { sub:'××¤×™×•×Ÿ', tasks:[
        { name:'×”×’×“×¨×ª ×—×‘×™×œ×•×ª ×©×™×¨×•×ª', goal:'××•×¦×¨×™× ×‘×¨×•×¨×™×', priority:'high', assignee:'rubi', ws:2, wl:2 },
        { name:'××¤×™×•×Ÿ ×ª×”×œ×™×š ×¢×‘×•×“×” ××•×œ ×œ×§×•×—', goal:'×—×•×•×™×ª ×©×™×¨×•×ª', priority:'medium', assignee:'gilad', ws:3, wl:2 },
      ]},
      { sub:'×ª××—×•×¨', tasks:[
        { name:'×‘× ×™×™×ª ××•×“×œ ×ª××—×•×¨', goal:'×¨×•×•×—×™×•×ª', priority:'high', assignee:'rubi', ws:2, wl:2 },
        { name:'×”×›× ×ª ××—×™×¨×•×Ÿ ×©×™×¨×•×ª×™×', goal:'×©×§×™×¤×•×ª', priority:'medium', assignee:'rubi', ws:4, wl:1 },
      ]},
      { sub:'×”×©×§×”', tasks:[
        { name:'×ª×•×›× ×™×ª ×”×©×§×” ×œ×©×™×¨×•×ª/××•×¦×¨ ×—×“×©', goal:'×›× ×™×¡×” ×œ×©×•×§', priority:'medium', assignee:'gilad', ws:8, wl:3 },
      ]},
    ],
    'design': [
      { sub:'××™×ª×•×’', tasks:[
        { name:'×¢×“×›×•×Ÿ / ×—×™×“×•×“ ×©×¤×” ×¢×™×¦×•×‘×™×ª', goal:'×–×”×•×ª ××•×ª×’×™×ª ×—×–×§×”', priority:'high', assignee:'dana', ws:0, wl:3 },
        { name:'×¢×™×¦×•×‘ ×œ×•×’×• ×•×•×¨×™××¦×™×•×ª', goal:'××™×ª×•×’ ××§×¦×•×¢×™', priority:'high', assignee:'dana', ws:0, wl:2 },
        { name:'×™×¦×™×¨×ª Brand Book', goal:'×¢×§×‘×™×•×ª ××•×ª×’×™×ª', priority:'medium', assignee:'dana', ws:2, wl:3 },
      ]},
      { sub:'××¨×›×™×•×Ÿ', tasks:[
        { name:'××¨×’×•×Ÿ ×•×ª×™×•×’ ×›×œ ×”×§×‘×¦×™× ×”×§×™×™××™×', goal:'× ×’×™×©×•×ª ×•×¡×“×¨', priority:'medium', assignee:'dana', ws:4, wl:2 },
      ]},
      { sub:'×›×œ×™×', tasks:[
        { name:'×‘×—×™× ×ª ×›×œ×™ ×¢×™×¦×•×‘ ×•×× ×™××¦×™×” ×—×“×©×™×', goal:'×©×“×¨×•×’ ×˜×›× ×•×œ×•×’×™', priority:'low', assignee:'gilad', ws:5, wl:2 },
      ]},
      { sub:'× ×›×¡×™× (Assets)', tasks:[
        { name:'×‘× ×™×™×ª ×¡×¤×¨×™×™×ª Assets ××©×•×ª×¤×ª', goal:'×¢×‘×•×“×” ××”×™×¨×”', priority:'medium', assignee:'dana', ws:3, wl:2 },
      ]},
    ],
    'strategy': [
      { sub:'×—×–×•×Ÿ', tasks:[
        { name:'×¡×“× ×ª ×—×–×•×Ÿ - ×œ××Ÿ ×”×¡×˜×•×“×™×• ×”×•×œ×š?', goal:'×›×™×•×•×Ÿ ×‘×¨×•×¨', priority:'high', assignee:'rubi', ws:0, wl:1 },
        { name:'×›×ª×™×‘×ª ×”×¦×”×¨×ª ×—×–×•×Ÿ ×•××©×™××”', goal:'××™×§×•×“ ×•××•×˜×™×‘×¦×™×”', priority:'high', assignee:'gilad', ws:0, wl:1 },
      ]},
      { sub:'×™×¢×“×™×', tasks:[
        { name:'×”×’×“×¨×ª OKRs ×œ×¨×‘×¢×•×Ÿ', goal:'××™×§×•×“ ×‘×™×¢×“×™×', priority:'high', assignee:'rubi', ws:0, wl:1 },
        { name:'×‘× ×™×™×ª ×“×©×‘×•×¨×“ ××¢×§×‘ ×™×¢×“×™×', goal:'×©×§×™×¤×•×ª ×•×‘×™×¦×•×¢', priority:'medium', assignee:'gilad', ws:1, wl:2 },
      ]},
      { sub:'×—×“×©× ×•×ª', tasks:[
        { name:'×–××Ÿ R&D ×©×‘×•×¢×™ ×§×‘×•×¢', goal:'×—×“×©× ×•×ª ××ª××“×ª', priority:'medium', assignee:'gilad', ws:2, wl:10 },
      ]},
      { sub:'×¦××™×—×” (Scaling)', tasks:[
        { name:'××™×¤×•×™ ×”×–×“×× ×•×™×•×ª ×¦××™×—×”', goal:'×’×“×™×œ×”', priority:'medium', assignee:'rubi', ws:4, wl:2 },
        { name:'×ª×•×›× ×™×ª ×’×™×•×¡ / ×©×™×ª×•×¤×™ ×¤×¢×•×œ×”', goal:'×”×¨×—×‘×ª ×™×›×•×œ×•×ª', priority:'low', assignee:'rubi', ws:8, wl:3 },
      ]},
    ],
    'marketing': [
      { sub:'××ª×¨', tasks:[
        { name:'××¤×™×•×Ÿ ×•×¢×™×¦×•×‘ ××ª×¨ ×”×¡×˜×•×“×™×•', goal:'× ×•×›×—×•×ª ××§×¦×•×¢×™×ª', priority:'high', assignee:'dana', ws:1, wl:4 },
        { name:'×›×ª×™×‘×ª ×ª×•×›×Ÿ ×œ××ª×¨', goal:'SEO ×•××¡×¨×™×', priority:'high', assignee:'rubi', ws:2, wl:3 },
        { name:'×¤×™×ª×•×— ×•×”×¢×œ××ª ××ª×¨', goal:'× ×•×›×—×•×ª ×“×™×’×™×˜×œ×™×ª', priority:'high', assignee:'gilad', ws:4, wl:4 },
      ]},
      { sub:'×ª×™×§ ×¢×‘×•×“×•×ª (Portfolio)', tasks:[
        { name:'×‘×—×™×¨×” ×•×¢×¨×™×›×” ×©×œ ×¢×‘×•×“×•×ª ×œ×ª×™×§', goal:'×”×¦×’×ª ×™×›×•×œ×•×ª', priority:'high', assignee:'gilad', ws:1, wl:3 },
        { name:'×¦×™×œ×•× / ×”×¤×§×ª Case Studies', goal:'×ª×•×›×Ÿ ×©×™×•×•×§×™', priority:'medium', assignee:'dana', ws:3, wl:3 },
      ]},
      { sub:'×™×—"×¦', tasks:[
        { name:'×¨×©×™××ª ××“×™×” ×•×¢×™×ª×•× ××™× ×¨×œ×•×•× ×˜×™×™×', goal:'×—×©×™×¤×”', priority:'low', assignee:'rubi', ws:6, wl:2 },
      ]},
      { sub:'×”××œ×¦×•×ª (Testimonials)', tasks:[
        { name:'××™×¡×•×£ ×”××œ×¦×•×ª ××œ×§×•×—×•×ª ×§×™×™××™×', goal:'×××™× ×•×ª', priority:'medium', assignee:'rubi', ws:3, wl:2 },
      ]},
    ],
    'finance': [
      { sub:'×¨×•×•×—×™×•×ª', tasks:[
        { name:'× ×™×ª×•×— ×¨×•×•×—×™×•×ª ×œ×¤×™ ×¤×¨×•×™×§×˜', goal:'××™×§×¡×•× ×¨×•×•×—', priority:'high', assignee:'rubi', ws:1, wl:2 },
      ]},
      { sub:'×ª×–×¨×™×', tasks:[
        { name:'×‘× ×™×™×ª ×ª×—×–×™×ª ×ª×–×¨×™× ×œ-3 ×—×•×“×©×™×', goal:'×™×¦×™×‘×•×ª ×¤×™× × ×¡×™×ª', priority:'high', assignee:'rubi', ws:0, wl:2 },
        { name:'×”×§××ª ××¢×§×‘ ×”×›× ×¡×•×ª/×”×•×¦××•×ª ×©×•×˜×£', goal:'×©×œ×™×˜×” ×¤×™× × ×¡×™×ª', priority:'high', assignee:'rubi', ws:0, wl:1 },
      ]},
      { sub:'××™×¡×•×™', tasks:[
        { name:'×¤×’×™×©×” ×¢× ×¨×•"×— - ×ª×›× ×•×Ÿ ××¡', goal:'××•×¤×˜×™××™×–×¦×™×”', priority:'medium', assignee:'rubi', ws:2, wl:1 },
      ]},
      { sub:'×ª×§×¦×™×‘', tasks:[
        { name:'×”×›× ×ª ×ª×§×¦×™×‘ ×¨×‘×¢×•× ×™', goal:'× ×™×”×•×œ ×”×•×¦××•×ª', priority:'high', assignee:'rubi', ws:0, wl:1 },
        { name:'×”×’×“×¨×ª ×ª×§×¦×™×‘ ×©×™×•×•×§', goal:'ROI', priority:'medium', assignee:'gilad', ws:1, wl:1 },
      ]},
    ],
    'knowledge': [
      { sub:'××ª×•×“×•×œ×•×’×™×”', tasks:[
        { name:'×ª×™×¢×•×“ ×ª×”×œ×™×›×™ ×¢×‘×•×“×” ××¨×›×–×™×™×', goal:'×”×¢×‘×¨×ª ×™×“×¢', priority:'medium', assignee:'gilad', ws:2, wl:3 },
      ]},
      { sub:'×ª×‘× ×™×•×ª (Templates)', tasks:[
        { name:'×™×¦×™×¨×ª ×ª×‘× ×™×•×ª ×œ×¤×¨×•×™×§×˜×™× ×—×•×–×¨×™×', goal:'×™×¢×™×œ×•×ª', priority:'medium', assignee:'dana', ws:4, wl:2 },
      ]},
      { sub:'×”×“×¨×›×•×ª', tasks:[
        { name:'×‘× ×™×™×ª ×ª×•×›× ×™×ª ×œ××™×“×” ×¤× ×™××™×ª', goal:'×©×“×¨×•×’ ××™×•×× ×•×™×•×ª', priority:'low', assignee:'gilad', ws:5, wl:2 },
      ]},
      { sub:'××•×˜×•××¦×™×”', tasks:[
        { name:'××™×¤×•×™ ×ª×”×œ×™×›×™× ×©× ×™×ª× ×™× ×œ××•×˜×•××¦×™×”', goal:'×—×™×¡×›×•×Ÿ ×–××Ÿ', priority:'high', assignee:'gilad', ws:1, wl:2 },
        { name:'×”×˜××¢×ª ×›×œ×™ ××•×˜×•××¦×™×” ×¨××©×•×Ÿ', goal:'×™×¢×™×œ×•×ª', priority:'medium', assignee:'gilad', ws:3, wl:2 },
      ]},
      { sub:'×‘×™× ×” ××œ××›×•×ª×™×ª (AI)', tasks:[
        { name:'××—×§×¨ ×›×œ×™ AI ×¨×œ×•×•× ×˜×™×™× ×œ×ª×—×•×', goal:'×™×ª×¨×•×Ÿ ×ª×—×¨×•×ª×™', priority:'high', assignee:'gilad', ws:0, wl:2 },
        { name:'×”×˜××¢×ª AI ×‘×ª×”×œ×™×›×™ ×¢×‘×•×“×”', goal:'×¤×¨×•×“×•×§×˜×™×‘×™×•×ª', priority:'medium', assignee:'gilad', ws:2, wl:3 },
      ]},
    ],
    'networking': [
      { sub:'Outreach', tasks:[
        { name:'×¨×©×™××ª 50 ×§×•× ×˜×§×˜×™× ×¤×•×˜× ×¦×™××œ×™×™×', goal:'×”×¨×—×‘×ª ×¨×©×ª', priority:'medium', assignee:'rubi', ws:1, wl:2 },
        { name:'×©×œ×™×—×ª 10 ××™×™×œ×™× ×¤×ª×™×—×”', goal:'×™×¦×™×¨×ª ×§×©×¨×™×', priority:'medium', assignee:'rubi', ws:3, wl:1 },
      ]},
      { sub:'×¤×’×™×©×•×ª', tasks:[
        { name:'3 ×¤×’×™×©×•×ª × ×˜×•×•×¨×§×™× ×’ ×‘×—×•×“×©', goal:'× ×•×›×—×•×ª ×‘×©×•×§', priority:'medium', assignee:'rubi', ws:2, wl:10 },
      ]},
      { sub:'××™×¨×•×¢×™×', tasks:[
        { name:'××™×¤×•×™ ××™×¨×•×¢×™× ×¨×œ×•×•× ×˜×™×™× ×‘×ª×¢×©×™×™×”', goal:'×—×©×™×¤×”', priority:'low', assignee:'gilad', ws:2, wl:1 },
        { name:'×”×©×ª×ª×¤×•×ª ×‘××™×¨×•×¢ ×¨××©×•×Ÿ', goal:'× ×˜×•×•×¨×§×™× ×’', priority:'medium', assignee:'rubi', ws:5, wl:1 },
      ]},
    ]
  };

  for (const catId in T) {
    for (const sub of T[catId]) {
      for (const t of sub.tasks) {
        tasks.push({
          id:nextId++, name:t.name, category:catId, sub:sub.sub,
          assignee:'', priority:t.priority,
          status:'todo',
          goal:t.goal, startDate:null, endDate:null, notes:'',
          subtasks:[], tags:[], recurrence:'none', comments:[],
          inBank:true
        });
      }
    }
  }
  return tasks;
}

let allTasks = []; // Populated from Firebase, or generated fresh on first load

// Tag color palette
const TAG_COLORS = ['#6c5ce7','#00b894','#fd79a8','#fdcb6e','#74b9ff','#e17055','#81ecec','#a29bfe','#55efc4','#fab1a0'];
const TAG_PRESETS = ['×“×—×•×£','×—×©×•×‘','×œ×§×•×—','×¢×™×¦×•×‘','×¤×™×ª×•×—','×©×™×•×•×§','×ª×•×›×Ÿ','×¤×™× × ×¡×™','×™×©×™×‘×”','××¢×§×‘'];

// Enrich generated tasks with sample data (only used on first-ever load)
function enrichTasks() {
  allTasks.forEach((t, i) => {
    if (i % 3 === 0) {
      const subs = [
        [{text:'××—×§×¨ ×¨××©×•× ×™',done:true},{text:'×”×›× ×ª ××¡××š',done:false},{text:'××™×©×•×¨ ×× ×”×œ',done:false}],
        [{text:'××™×¡×•×£ ××™×“×¢',done:true},{text:'× ×™×ª×•×— × ×ª×•× ×™×',done:true},{text:'×”×¦×’×ª ××¡×§× ×•×ª',done:false}],
        [{text:'×ª×›× ×•×Ÿ',done:true},{text:'×‘×™×¦×•×¢',done:false},{text:'×‘×“×™×§×”',done:false},{text:'×”×©×§×”',done:false}],
      ];
      t.subtasks = subs[i % subs.length].map((s,j) => ({id:j+1, text:s.text, done:s.done}));
    }
    if (i % 2 === 0) {
      const tagSets = [['×“×—×•×£','×œ×§×•×—'],['×¢×™×¦×•×‘'],['×©×™×•×•×§','×ª×•×›×Ÿ'],['×¤×™× × ×¡×™','×—×©×•×‘'],['×¤×™×ª×•×—','××¢×§×‘']];
      t.tags = tagSets[i % tagSets.length];
    }
    if (i % 7 === 0) {
      const recs = ['daily','weekly','biweekly','monthly'];
      t.recurrence = recs[i % recs.length];
    }
    if (i % 4 === 0) {
      const commentSets = [
        [{author:'rubi',text:'×¦×¨×™×š ×œ×§×“× ××ª ×–×” ×”×©×‘×•×¢, @×“× ×” ×ª×•×›×œ×™ ×œ×¢×–×•×¨?',time:new Date(today.getTime()-86400000*2)},{author:'dana',text:'×‘×˜×—! ××ª×—×™×œ ××—×¨ ×‘×‘×•×§×¨',time:new Date(today.getTime()-86400000)}],
        [{author:'gilad',text:'×¢×“×›×•×Ÿ: ×¡×™×™××ª×™ ××ª ×”×©×œ×‘ ×”×¨××©×•×Ÿ. @×¨×•×‘×™ ×¦×¨×™×š ××ª ×”××™×©×•×¨ ×©×œ×š',time:new Date(today.getTime()-86400000*3)}],
        [{author:'rubi',text:'×‘×•××• × ×“×•×Ÿ ×‘×–×” ×‘×™×©×™×‘×ª ×”×¦×•×•×ª ×”×‘××” @×’×œ×¢×“ @×“× ×”',time:new Date(today.getTime()-86400000*5)},{author:'gilad',text:'××ª××™×, ×”×•×¡×¤×ª×™ ×œ×™×•××Ÿ',time:new Date(today.getTime()-86400000*4)},{author:'dana',text:'ğŸ‘',time:new Date(today.getTime()-86400000*4)}],
      ];
      t.comments = commentSets[i % commentSets.length];
    }
  });
}

// Notifications system
let notifications = [];
function generateInitialNotifs() {
  const now = today;
  // Overdue notifications
  allTasks.filter(t => t.endDate && t.endDate < now && t.status !== 'done').forEach(t => {
    const daysLate = Math.ceil((now - t.endDate) / 86400000);
    notifications.push({id:notifications.length+1, type:'overdue', icon:'âš ï¸', title:`××©×™××” ×‘××™×—×•×¨: ${t.name}`, desc:`${daysLate} ×™××™× ×‘××™×—×•×¨ - ${TEAM.find(m=>m.id===t.assignee)?.name||''}`, taskId:t.id, time:new Date(now.getTime()-daysLate*86400000), read:false});
  });
  // Upcoming deadlines (3 days)
  allTasks.filter(t => t.status !== 'done' && t.endDate && t.endDate >= now && t.endDate <= new Date(now.getTime()+3*86400000)).forEach(t => {
    const daysLeft = Math.ceil((t.endDate - now) / 86400000);
    notifications.push({id:notifications.length+1, type:'deadline', icon:'â°', title:`×“×“-×œ×™×™×Ÿ ××ª×§×¨×‘: ${t.name}`, desc:`×¢×•×“ ${daysLeft} ×™××™×`, taskId:t.id, time:new Date(now.getTime()-86400000), read:false});
  });
  // Mention notifications from comments
  allTasks.forEach(t => {
    (t.comments||[]).forEach(c => {
      if (c.text.includes('@')) {
        const mentioned = TEAM.filter(m => c.text.includes('@'+m.name));
        mentioned.forEach(m => {
          notifications.push({id:notifications.length+1, type:'mention', icon:'ğŸ’¬', title:`${TEAM.find(x=>x.id===c.author)?.name||''} ×”×–×›×™×¨/×” ××•×ª×š`, desc:`"${c.text.substring(0,50)}${c.text.length>50?'...':''}" - ${t.name}`, taskId:t.id, time:c.time, read:Math.random()>0.5});
        });
      }
    });
  });
  notifications.sort((a,b) => b.time - a.time);
  notifications = notifications.slice(0, 30);
}
// generateInitialNotifs called after Firebase loads data

let currentView = 'dashboard';
let currentSort = { field:'deadline', asc:true };
let activeFilters = { category:'all', assignee:'all', status:'all', priority:'all' };
let calendarDate = new Date(today);

// ===== NAVIGATION =====
function switchView(view, el) {
  currentView = view;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (el) el.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('view-'+view).classList.add('active');
  const titles = {dashboard:'ğŸ“Š ×“×©×‘×•×¨×“',bank:'ğŸ¦ ×‘× ×§ ××©×™××•×ª',tasks:'ğŸ“‹ ××©×™××•×ª',gantt:'ğŸ“… ×ª×¨×©×™× ×’×× ×˜',calendar:'ğŸ—“ï¸ ×§×œ× ×“×¨',categories:'ğŸ“ ×œ×¤×™ ×§×˜×’×•×¨×™×”',workload:'âš–ï¸ ×¢×•××¡×™×',weekview:'ğŸ“† ×©×‘×•×¢ × ×•×›×—×™',kanban:'ğŸ”² ×§× ×‘××Ÿ',burndown:'ğŸ“‰ ×‘×¨× ×“××•×Ÿ',activitylog:'ğŸ“ ×œ×•×’ ×¤×¢×™×œ×•×ª',reports:'ğŸ“Š ×“×•×—×•×ª',velocity:'ğŸš€ ××”×™×¨×•×ª',dependencies:'ğŸ”— ×ª×œ×•×™×•×ª',timeline:'ğŸ“Œ ×¦×™×¨ ×–××Ÿ ××™×©×™',pricing:'ğŸ’° ×©×¢×•×ª ×•×ª××—×•×¨',clients:'ğŸ¢ ×œ×§×•×—×•×ª',okr:'ğŸ¯ OKR'};
  document.getElementById('viewTitle').textContent = titles[view]||'';
  renderView();
}

function renderView() {
  switch(currentView) {
    case 'dashboard': renderDashboard(); break;
    case 'bank': renderBank(); break;
    case 'tasks': renderTasks(); break;
    case 'gantt': renderGantt(); break;
    case 'calendar': renderCalendar(); break;
    case 'categories': renderCategories(); break;
    case 'workload': renderWorkload(); break;
    case 'weekview': renderWeekView(); break;
    case 'kanban': renderKanban(); break;
    case 'burndown': renderBurndown(); break;
    case 'activitylog': renderActivityLog(); break;
    case 'reports': renderReports(); break;
    case 'velocity': renderVelocity(); break;
    case 'dependencies': renderDependencies(); break;
    case 'timeline': renderTimeline(); break;
    case 'pricing': renderPricing(); break;
    case 'clients': renderClients(); break;
    case 'okr': renderOKR(); break;
  }
}

// ===== DASHBOARD =====
function renderDashboard() {
  // Widget toggle controls
  const widgetNames = {stats:'ğŸ“ˆ ×¡×˜×˜×™×¡×˜×™×§×•×ª',kpi:'ğŸ‘¥ KPI ×¦×•×•×ª',urgent:'ğŸ“Œ ×“×—×•×¤×•×ª',categories:'ğŸ“Š ×§×˜×’×•×¨×™×•×ª'};
  document.getElementById('widgetToggle').innerHTML = '<span style="font-size:11px;color:var(--text2);line-height:26px;">×•×•×™×“×’\'×˜×™×:</span>' +
    Object.entries(widgetNames).map(([k,v]) => `<span class="widget-chip ${dashWidgets[k]?'active':''}" onclick="toggleWidget('${k}')">${v}</span>`).join('');

  const total=allTasks.length, done=allTasks.filter(t=>t.status==='done').length,
    prog=allTasks.filter(t=>t.status==='progress').length,
    overdue=allTasks.filter(t=>t.endDate&&t.endDate<today&&t.status!=='done').length;

  document.getElementById('statsGrid').style.display = dashWidgets.stats ? '' : 'none';
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card accent"><div class="label">×¡×”"×› ××©×™××•×ª</div><div class="value">${total}</div><div class="sub">${CATEGORIES.length} ×§×˜×’×•×¨×™×•×ª</div></div>
    <div class="stat-card green"><div class="label">×”×•×©×œ××•</div><div class="value">${done}</div><div class="sub">${total?Math.round(done/total*100):0}%</div></div>
    <div class="stat-card yellow"><div class="label">×‘×ª×”×œ×™×š</div><div class="value">${prog}</div><div class="sub">${allTasks.filter(t=>t.status==='review').length} ×‘×‘×“×™×§×”</div></div>
    <div class="stat-card red"><div class="label">×‘××™×—×•×¨</div><div class="value">${overdue}</div><div class="sub">×“×•×¨×©×™× ×˜×™×¤×•×œ</div></div>`;

  let kpi='';
  TEAM.forEach(m=>{
    const mt=allTasks.filter(t=>t.assignee===m.id), md=mt.filter(t=>t.status==='done').length;
    const p=mt.length?Math.round(md/mt.length*100):0;
    kpi+=`<div class="kpi-card"><h4 style="display:flex;align-items:center;gap:6px;">
      <div class="avatar avatar-${m.id}" style="width:22px;height:22px;font-size:10px;">${m.name[0]}</div>${m.name} - ${mt.length} ××©×™××•×ª</h4>
      <div class="progress-bar" style="margin-bottom:8px;"><div class="progress-fill" style="width:${p}%;background:${m.color};"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);"><span>${md} ×”×•×©×œ××•</span><span>${mt.filter(t=>t.status==='progress').length} ×‘×ª×”×œ×™×š</span><span>${p}%</span></div></div>`;
  });
  document.getElementById('kpiGrid').style.display = dashWidgets.kpi ? '' : 'none';
  document.getElementById('kpiGrid').innerHTML = kpi;

  const urgentParent = document.getElementById('urgentTasks').parentElement;
  const catParent = document.getElementById('recentActivity').parentElement;
  urgentParent.parentElement.style.display = (dashWidgets.urgent || dashWidgets.categories) ? '' : 'none';
  urgentParent.style.display = dashWidgets.urgent ? '' : 'none';
  catParent.style.display = dashWidgets.categories ? '' : 'none';

  const urgent=allTasks.filter(t=>t.priority==='high'&&t.status!=='done').sort((a,b)=>(a.endDate||new Date(9999,0))-(b.endDate||new Date(9999,0))).slice(0,6);
  document.getElementById('urgentTasks').innerHTML = urgent.map(t=>{
    const m=TEAM.find(x=>x.id===t.assignee);
    return `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;">
      <span class="priority-dot priority-${t.priority}"></span><span style="flex:1;">${t.name}</span>
      ${m?`<div class="avatar avatar-${t.assignee}" style="width:20px;height:20px;font-size:9px;">${m.name[0]}</div>`:'<span style="font-size:10px;color:var(--text2);">ğŸ¦</span>'}
      <span style="color:var(--text2);">${t.endDate?fmtD(t.endDate):'×‘× ×§'}</span></div>`;
  }).join('');

  document.getElementById('recentActivity').innerHTML = CATEGORIES.map(c=>{
    const ct=allTasks.filter(t=>t.category===c.id), cd=ct.filter(t=>t.status==='done').length;
    const p=ct.length?Math.round(cd/ct.length*100):0;
    return `<div style="display:flex;align-items:center;gap:8px;padding:5px 0;font-size:12px;">
      <span>${c.emoji}</span><span style="flex:1;">${c.name}</span><span style="color:var(--text2);width:40px;text-align:left;">${p}%</span>
      <div class="progress-bar" style="width:80px;"><div class="progress-fill" style="width:${p}%;background:${c.color};"></div></div></div>`;
  }).join('');
}

// ===== TASK BANK =====
let bankDragTaskId = null;

function renderBank() {
  const search = (document.getElementById('bankSearch')?.value || '').toLowerCase();
  const bankTasks = allTasks.filter(t => t.inBank);
  const assignedTasks = allTasks.filter(t => !t.inBank && t.assignee);
  const filtered = bankTasks.filter(t => !search || t.name.toLowerCase().includes(search) || t.goal.toLowerCase().includes(search));

  // Stats
  document.getElementById('bankStats').innerHTML = `
    <div class="bank-stat"><div class="num" style="color:var(--accent)">${bankTasks.length}</div><div class="lbl">×‘×‘× ×§</div></div>
    <div class="bank-stat"><div class="num" style="color:var(--green)">${assignedTasks.length}</div><div class="lbl">×©×•×‘×¦×•</div></div>
    <div class="bank-stat"><div class="num" style="color:var(--yellow)">${allTasks.length}</div><div class="lbl">×¡×”"×›</div></div>
    <div class="bank-stat"><div class="num" style="color:var(--pink)">${assignedTasks.filter(t=>t.status==='done').length}</div><div class="lbl">×”×•×©×œ××•</div></div>
  `;

  // Group by category
  const groups = {};
  filtered.forEach(t => {
    if (!groups[t.category]) groups[t.category] = [];
    groups[t.category].push(t);
  });

  const catMap = {};
  CATEGORIES.forEach(c => catMap[c.id] = c);

  let html = '';
  for (const catId in groups) {
    const cat = catMap[catId];
    if (!cat) continue;
    html += `<div class="bank-cat-group">
      <div class="bank-cat-header">
        <span>${cat.emoji}</span> ${cat.name}
        <span class="bank-count">${groups[catId].length}</span>
      </div>
      <div class="bank-cards">`;
    groups[catId].forEach(t => {
      const prioColors = {high:'var(--red)',medium:'var(--yellow)',low:'var(--green)'};
      const prioLabels = {high:'×’×‘×•×”×”',medium:'×‘×™× ×•× ×™×ª',low:'× ××•×›×”'};
      html += `<div class="bank-card" draggable="true"
        ondragstart="bankDragStart(event,${t.id})"
        ondragend="bankDragEnd(event)">
        <div class="bank-card-title">${t.name}</div>
        <div class="bank-card-meta">
          <span style="color:${prioColors[t.priority]||'var(--text2)'}">â— ${prioLabels[t.priority]||t.priority}</span>
          <span>${t.sub}</span>
          <span>ğŸ¯ ${t.goal}</span>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <button class="btn btn-primary btn-sm" style="font-size:10px;padding:3px 8px;" onclick="bankQuickAssign(${t.id})">âš¡ ×©×‘×¥</button>
          <button class="btn btn-secondary btn-sm" style="font-size:10px;padding:3px 8px;" onclick="openEditModal(${t.id})">âœï¸</button>
        </div>
      </div>`;
    });
    html += `</div></div>`;
  }

  if (!html) html = '<div style="text-align:center;color:var(--text2);padding:40px;">ğŸ‰ ×›×œ ×”××©×™××•×ª ×©×•×‘×¦×•! ×”×‘× ×§ ×¨×™×§.</div>';
  document.getElementById('bankMain').innerHTML = html;

  // Assigned list in sidebar
  const assignedHtml = assignedTasks.length ? assignedTasks.slice(0,15).map(t => {
    const member = TEAM.find(m => m.id === t.assignee);
    return `<div style="padding:6px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-size:12px;">${t.name}</div>
        <div style="font-size:10px;color:var(--text2);">${member?.name||''} | ${t.startDate?fmtD(t.startDate):''}</div>
      </div>
      <button class="btn btn-secondary btn-sm" style="font-size:9px;padding:2px 6px;" onclick="bankUnassign(${t.id})" title="×”×—×–×¨ ×œ×‘× ×§">â†©ï¸</button>
    </div>`;
  }).join('') + (assignedTasks.length>15?`<div style="text-align:center;padding:6px;font-size:11px;color:var(--text2);">...×•×¢×•×“ ${assignedTasks.length-15}</div>`:'')
  : '<div style="color:var(--text2);font-size:11px;">××™×Ÿ ××©×™××•×ª ××©×•×‘×¦×•×ª ×¢×“×™×™×Ÿ</div>';
  document.getElementById('bankAssignedList').innerHTML = assignedHtml;
}

function bankDragStart(e, taskId) {
  bankDragTaskId = taskId;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function bankDragEnd(e) {
  e.target.classList.remove('dragging');
}

function bankDrop(e) {
  e.preventDefault();
  document.getElementById('bankDropZone').classList.remove('drag-over');
  if (bankDragTaskId) {
    bankQuickAssign(bankDragTaskId);
    bankDragTaskId = null;
  }
}

function bankQuickAssign(taskId) {
  const task = allTasks.find(t => t.id === taskId);
  if (!task) return;
  document.getElementById('bankAssignTaskName').textContent = task.name;
  document.getElementById('bankAssignPerson').value = task.assignee || '';
  document.getElementById('bankAssignStart').value = '';
  document.getElementById('bankAssignEnd').value = '';
  document.getElementById('bankAssignForm').style.display = 'block';
  document.getElementById('bankAssignForm').dataset.taskId = taskId;
}

function bankAssignConfirm() {
  const taskId = parseInt(document.getElementById('bankAssignForm').dataset.taskId);
  const task = allTasks.find(t => t.id === taskId);
  if (!task) return;
  const person = document.getElementById('bankAssignPerson').value;
  const startVal = document.getElementById('bankAssignStart').value;
  const endVal = document.getElementById('bankAssignEnd').value;
  if (!person) { toast('âš ï¸ ×™×© ×œ×‘×—×•×¨ ××—×¨××™'); return; }
  if (!startVal || !endVal) { toast('âš ï¸ ×™×© ×œ×‘×—×•×¨ ×ª××¨×™×›×™ ×”×ª×—×œ×” ×•×¡×™×•×'); return; }
  task.assignee = person;
  task.startDate = new Date(startVal);
  task.endDate = new Date(endVal);
  task.status = 'todo';
  task.inBank = false;
  document.getElementById('bankAssignForm').style.display = 'none';
  logActivity('assign','ğŸ“¤',`<strong>${TEAM.find(m=>m.id===person)?.name||''}</strong> ×©×•×‘×¥/×” ×œ××©×™××”: "${task.name}"`);
  saveTasks();renderBank();
  toast('âœ… ××©×™××” ×©×•×‘×¦×” ×‘×”×¦×œ×—×”!');
}

function bankAssignCancel() {
  document.getElementById('bankAssignForm').style.display = 'none';
  bankDragTaskId = null;
}

function bankUnassign(taskId) {
  const task = allTasks.find(t => t.id === taskId);
  if (!task) return;
  task.assignee = '';
  task.startDate = null;
  task.endDate = null;
  task.status = 'todo';
  task.inBank = true;
  logActivity('unassign','â†©ï¸',`××©×™××” ×”×•×—×–×¨×” ×œ×‘× ×§: "${task.name}"`);
  saveTasks();renderBank();
  toast('â†©ï¸ ××©×™××” ×”×•×—×–×¨×” ×œ×‘× ×§');
}

// ===== TASKS TABLE =====
function renderTasks() {
  renderFilters();
  const sorted = sortTaskList(getFilteredTasks());
  document.getElementById('taskTableBody').innerHTML = sorted.map(t=>{
    const c=CATEGORIES.find(x=>x.id===t.category), m=TEAM.find(x=>x.id===t.assignee);
    const od=t.endDate&&t.endDate<today&&t.status!=='done';
    return `<tr>
      <td><span class="priority-dot priority-${t.priority}"></span></td>
      <td class="task-name-cell" onclick="openEditTask(${t.id})">
        <div>${t.name}${t.recurrence&&t.recurrence!=='none'?' <span class="recur-badge">ğŸ” '+getRecurrenceLabel(t.recurrence)+'</span>':''}</div>
        ${t.tags&&t.tags.length?'<div class="tags-wrap" style="margin-top:3px;">'+t.tags.map(tg=>'<span class="tag" style="background:'+getTagColor(tg)+'33;color:'+getTagColor(tg)+';">'+tg+'</span>').join('')+'</div>':''}
        ${t.subtasks&&t.subtasks.length?'<div style="font-size:10px;color:var(--text2);margin-top:2px;">ğŸ“‹ '+t.subtasks.filter(s=>s.done).length+'/'+t.subtasks.length+' ×ª×ª×™-××©×™××•×ª</div>':''}
      </td>
      <td><span class="category-tag" style="background:${c.color}22;color:${c.color};">${c.emoji} ${c.name}</span></td>
      <td>${m?`<div style="display:flex;align-items:center;gap:6px;"><div class="avatar avatar-${t.assignee}" style="width:22px;height:22px;font-size:10px;">${m.name[0]}</div>${m.name}</div>`:'<span style="color:var(--text2);font-size:12px;">ğŸ¦ ×‘×‘× ×§</span>'}</td>
      <td><select onchange="updateStatus(${t.id},this.value)" style="background:transparent;border:none;color:inherit;font-family:'Heebo';font-size:12px;cursor:pointer;outline:none;">
        <option value="todo" ${t.status==='todo'?'selected':''}>ğŸ“ ×œ×‘×™×¦×•×¢</option>
        <option value="progress" ${t.status==='progress'?'selected':''}>ğŸ”„ ×‘×ª×”×œ×™×š</option>
        <option value="review" ${t.status==='review'?'selected':''}>ğŸ‘€ ×‘×‘×“×™×§×”</option>
        <option value="done" ${t.status==='done'?'selected':''}>âœ… ×”×•×©×œ×</option>
        <option value="blocked" ${t.status==='blocked'?'selected':''}>ğŸš« ×—×¡×•×</option>
      </select></td>
      <td style="${od?'color:var(--red);font-weight:600;':''}">${t.endDate?fmtD(t.endDate):'â€”'}${od?' âš ï¸':''}</td>
      <td style="font-size:12px;color:var(--text2);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.goal}</td>
      <td><button class="btn btn-secondary btn-sm" onclick="openEditTask(${t.id})" style="padding:3px 8px;">âœï¸</button>
        <button class="btn btn-sm" onclick="addToGCal(${t.id})" style="padding:3px 6px;background:#4285f4;color:#fff;border:none;border-radius:6px;cursor:pointer;" title="×”×•×¡×£ ×œ×’×•×’×œ ×§×œ× ×“×¨">ğŸ“…</button></td>
    </tr>`;
  }).join('');
}

function renderFilters() {
  let h='<span style="font-size:12px;color:var(--text2);">×¡×™× ×•×Ÿ:</span>';
  h+=`<div class="filter-chip ${activeFilters.category==='all'?'active':''}" onclick="setFilter('category','all')">×”×›×œ</div>`;
  CATEGORIES.forEach(c=>{h+=`<div class="filter-chip ${activeFilters.category===c.id?'active':''}" onclick="setFilter('category','${c.id}')">${c.emoji} ${c.name}</div>`;});
  h+='<span style="margin-right:10px;font-size:12px;color:var(--text2);">|</span>';
  h+=`<div class="filter-chip ${activeFilters.status==='all'?'active':''}" onclick="setFilter('status','all')">×›×œ ×”×¡×˜×˜×•×¡×™×</div>`;
  h+=`<div class="filter-chip ${activeFilters.status==='todo'?'active':''}" onclick="setFilter('status','todo')">ğŸ“ ×œ×‘×™×¦×•×¢</div>`;
  h+=`<div class="filter-chip ${activeFilters.status==='progress'?'active':''}" onclick="setFilter('status','progress')">ğŸ”„ ×‘×ª×”×œ×™×š</div>`;
  h+=`<div class="filter-chip ${activeFilters.status==='done'?'active':''}" onclick="setFilter('status','done')">âœ… ×”×•×©×œ×</div>`;
  h+='<span style="margin-right:10px;font-size:12px;color:var(--text2);">|</span>';
  h+=`<div class="filter-chip ${activeFilters.assignee==='all'?'active':''}" onclick="setFilter('assignee','all')">×›×•×œ×</div>`;
  TEAM.forEach(m=>{h+=`<div class="filter-chip ${activeFilters.assignee===m.id?'active':''}" onclick="setFilter('assignee','${m.id}')">${m.name}</div>`;});
  document.getElementById('filtersBar').innerHTML = h;
}

function setFilter(type,val) { activeFilters[type]=val; renderTasks(); }

function getFilteredTasks() {
  let t=[...allTasks];
  const s=document.getElementById('searchBox').value.trim();
  if(s) t=t.filter(x=>x.name.includes(s)||x.goal.includes(s)||x.sub.includes(s)||(x.tags&&x.tags.some(tg=>tg.includes(s))));
  if(activeFilters.category!=='all') t=t.filter(x=>x.category===activeFilters.category);
  if(activeFilters.assignee!=='all') t=t.filter(x=>x.assignee===activeFilters.assignee);
  if(activeFilters.status!=='all') t=t.filter(x=>x.status===activeFilters.status);
  return t;
}

function sortTasks(f) { if(currentSort.field===f) currentSort.asc=!currentSort.asc; else {currentSort.field=f;currentSort.asc=true;} renderTasks(); }
function sortTaskList(tasks) {
  const f=currentSort.field, d=currentSort.asc?1:-1;
  return tasks.sort((a,b)=>{
    if(f==='deadline') return ((a.endDate||new Date(9999,0))-(b.endDate||new Date(9999,0)))*d;
    if(f==='priority'){const p={high:0,medium:1,low:2};return (p[a.priority]-p[b.priority])*d;}
    return (a[f]||'').localeCompare(b[f]||'','he')*d;
  });
}
function updateStatus(id,s){const t=allTasks.find(x=>x.id===id);if(t){t.status=s;if(s==='done'){if(t.recurrence&&t.recurrence!=='none')generateRecurringTask(t);showConfetti();}logActivity('status',s==='done'?'âœ…':'ğŸ”„',`<strong>${TEAM.find(m=>m.id===t.assignee)?.name||''}</strong> ×©×™× ×”/×ª×” ×¡×˜×˜×•×¡ ×œ${getStatusLabel(s)}: "${t.name}"`);saveTasks();renderView();}}
function filterTasks(){renderView();}

// ===== GANTT WITH DRAG =====
let ganttFilterVal='all';
function ganttFilter(v,el){ganttFilterVal=v;document.querySelectorAll('#view-gantt .filter-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');renderGantt();}

const GANTT_DAYS = 91; // 13 weeks
let ganttStartDate;

function renderGantt() {
  ganttStartDate = new Date(today);
  ganttStartDate.setDate(ganttStartDate.getDate() - ganttStartDate.getDay()); // Sunday

  let tasks=allTasks.filter(t=>!t.inBank && t.startDate && t.endDate);
  if(ganttFilterVal!=='all') tasks=tasks.filter(t=>t.assignee===ganttFilterVal);

  // Build day headers
  let weekHeaders='', dayHeaders='';
  let currentWeekStart=null, weekDayCount=0;

  for(let d=0;d<GANTT_DAYS;d++){
    const date=new Date(ganttStartDate);
    date.setDate(date.getDate()+d);
    const dow=date.getDay();
    const isWeekend=dow===5||dow===6;
    const isToday=date.toDateString()===today.toDateString();

    if(d%7===0){
      if(currentWeekStart!==null){
        weekHeaders+=`<div class="gantt-week-header" style="flex:${weekDayCount};min-width:${weekDayCount*38}px;">${fmtDS(currentWeekStart)}</div>`;
      }
      currentWeekStart=new Date(date);
      weekDayCount=0;
    }
    weekDayCount++;
    dayHeaders+=`<div class="gantt-day-header${isWeekend?' weekend':''}${isToday?' today-col':''}">${date.getDate()}</div>`;
  }
  if(currentWeekStart) weekHeaders+=`<div class="gantt-week-header" style="flex:${weekDayCount};min-width:${weekDayCount*38}px;">${fmtDS(currentWeekStart)}</div>`;

  let html=`<div class="gantt-header">
    <div class="gantt-label-col" style="display:flex;flex-direction:column;justify-content:center;">
      <span>××©×™××”</span>
    </div>
    <div style="flex:1;overflow:hidden;">
      <div style="display:flex;">${weekHeaders}</div>
      <div class="gantt-timeline-header">${dayHeaders}</div>
    </div>
  </div><div class="gantt-body">`;

  CATEGORIES.forEach(cat=>{
    const ct=tasks.filter(t=>t.category===cat.id);
    if(!ct.length) return;
    html+=`<div class="gantt-row cat-header">
      <div class="gantt-row-label" style="font-weight:600;color:${cat.color};"><span style="font-size:14px;">${cat.emoji}</span> ${cat.name} (${ct.length})</div>
      <div class="gantt-row-timeline">`;
    for(let d=0;d<GANTT_DAYS;d++){const dt=new Date(ganttStartDate);dt.setDate(dt.getDate()+d);const dw=dt.getDay();html+=`<div class="gantt-day-cell${dw===5||dw===6?' weekend':''}${dt.toDateString()===today.toDateString()?' today-col':''}"></div>`;}
    html+='</div></div>';

    ct.forEach(t=>{
      const m=TEAM.find(x=>x.id===t.assignee);
      html+=`<div class="gantt-row"><div class="gantt-row-label">
        <div class="avatar avatar-${t.assignee}" style="width:20px;height:20px;font-size:9px;flex-shrink:0;">${m.name[0]}</div>
        <span style="overflow:hidden;text-overflow:ellipsis;" title="${t.name}">${t.name}</span></div>
        <div class="gantt-row-timeline" data-task-id="${t.id}">`;
      for(let d=0;d<GANTT_DAYS;d++){const dt=new Date(ganttStartDate);dt.setDate(dt.getDate()+d);const dw=dt.getDay();html+=`<div class="gantt-day-cell${dw===5||dw===6?' weekend':''}${dt.toDateString()===today.toDateString()?' today-col':''}"></div>`;}

      // Bar
      const ds=Math.floor((t.startDate-ganttStartDate)/86400000);
      const de=Math.floor((t.endDate-ganttStartDate)/86400000)+1;
      const bs=Math.max(0,ds), be=Math.min(GANTT_DAYS,de);
      if(be>bs){
        const left=(bs/GANTT_DAYS*100), width=((be-bs)/GANTT_DAYS*100);
        const sc={todo:cat.color+'aa',progress:cat.color,review:'#fdcb6e',done:'#00b894',blocked:'#e17055'};
        html+=`<div class="gantt-bar" data-task-id="${t.id}" style="right:${left}%;width:${width}%;background:${sc[t.status]||cat.color};"
          onmousedown="ganttDragStart(event,${t.id},'move')">
          <div class="resize-handle right" onmousedown="event.stopPropagation();ganttDragStart(event,${t.id},'resize-start')"></div>
          <button class="gcal-btn" onclick="event.stopPropagation();addToGCal(${t.id})">ğŸ“…</button>
          <span class="bar-label">${width>6?t.name.substring(0,25):''}</span>
          <div class="resize-handle left" onmousedown="event.stopPropagation();ganttDragStart(event,${t.id},'resize-end')"></div>
        </div>`;
      }
      html+='</div></div>';
    });
  });

  html+='</div>';
  document.getElementById('ganttContainer').innerHTML=html;
}

// Gantt drag & drop
let ganttDrag = null;

function ganttDragStart(e, taskId, mode) {
  e.preventDefault();
  const bar = e.target.closest('.gantt-bar');
  const timeline = bar.parentElement;
  const rect = timeline.getBoundingClientRect();

  ganttDrag = {
    taskId, mode, bar, timeline, rect,
    startX: e.clientX,
    origRight: parseFloat(bar.style.right),
    origWidth: parseFloat(bar.style.width)
  };
  bar.classList.add('dragging');
  document.addEventListener('mousemove', ganttDragMove);
  document.addEventListener('mouseup', ganttDragEnd);
}

function ganttDragMove(e) {
  if (!ganttDrag) return;
  const dx = ganttDrag.startX - e.clientX; // RTL: reversed
  const pct = (dx / ganttDrag.rect.width) * 100;

  if (ganttDrag.mode === 'move') {
    ganttDrag.bar.style.right = (ganttDrag.origRight + pct) + '%';
  } else if (ganttDrag.mode === 'resize-end') {
    // Resize from left side (end date in RTL)
    const newWidth = ganttDrag.origWidth - pct;
    if (newWidth > 1) ganttDrag.bar.style.width = newWidth + '%';
  } else if (ganttDrag.mode === 'resize-start') {
    // Resize from right side (start date in RTL)
    const newWidth = ganttDrag.origWidth + pct;
    const newRight = ganttDrag.origRight - pct;
    if (newWidth > 1 && newRight >= 0) {
      ganttDrag.bar.style.width = newWidth + '%';
      ganttDrag.bar.style.right = newRight + '%';
    }
  }
}

function ganttDragEnd(e) {
  if (!ganttDrag) return;
  document.removeEventListener('mousemove', ganttDragMove);
  document.removeEventListener('mouseup', ganttDragEnd);

  const bar = ganttDrag.bar;
  bar.classList.remove('dragging');

  // Calculate new dates from bar position
  const rightPct = parseFloat(bar.style.right);
  const widthPct = parseFloat(bar.style.width);

  const startDay = Math.round(rightPct / 100 * GANTT_DAYS);
  const duration = Math.round(widthPct / 100 * GANTT_DAYS);

  const task = allTasks.find(t => t.id === ganttDrag.taskId);
  if (task && duration > 0) {
    const newStart = new Date(ganttStartDate);
    newStart.setDate(newStart.getDate() + startDay);
    const newEnd = new Date(newStart);
    newEnd.setDate(newEnd.getDate() + duration - 1);

    task.startDate = newStart;
    task.endDate = newEnd;
    saveTasks();
    toast(`ğŸ“… ${task.name} â†’ ${fmtD(newStart)} - ${fmtD(newEnd)}`);
  }

  ganttDrag = null;
  renderGantt();
}

// ===== CALENDAR WITH DRAG =====
let calDrag = null;

function renderCalendar() {
  const year=calendarDate.getFullYear(), month=calendarDate.getMonth();
  const mNames=['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
  document.getElementById('calTitle').textContent=`${mNames[month]} ${year}`;

  const dNames=['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
  let html=dNames.map(d=>`<div class="cal-header">${d}</div>`).join('');

  const first=new Date(year,month,1), last=new Date(year,month+1,0);
  const pad=first.getDay();

  for(let i=0;i<pad;i++){
    const d=new Date(year,month,-(pad-i-1));
    html+=`<div class="cal-day other-month"><div class="cal-day-num">${d.getDate()}</div></div>`;
  }

  for(let d=1;d<=last.getDate();d++){
    const date=new Date(year,month,d);
    const iso=date.toISOString().split('T')[0];
    const isToday=date.toDateString()===today.toDateString();
    const dayTasks=allTasks.filter(t=>t.startDate&&t.endDate&&date>=new Date(t.startDate.toDateString())&&date<=new Date(t.endDate.toDateString()));

    html+=`<div class="cal-day${isToday?' today':''}" data-date="${iso}"
      onclick="showDayTasks(${year},${month},${d})"
      ondragover="calDragOver(event)" ondragleave="calDragLeave(event)" ondrop="calDrop(event)">
      <div class="cal-day-num">${d}</div>`;

    dayTasks.slice(0,4).forEach(t=>{
      const cat=CATEGORIES.find(c=>c.id===t.category);
      html+=`<div class="cal-event" draggable="true" data-task-id="${t.id}"
        style="background:${cat.color}33;color:${cat.color};"
        ondragstart="calDragStart(event,${t.id})"
        ondragend="calDragEnd(event)">
        <span class="gcal-icon" onclick="event.stopPropagation();addToGCal(${t.id})">ğŸ“…</span>
        ${t.name.substring(0,18)}</div>`;
    });
    if(dayTasks.length>4) html+=`<div style="font-size:10px;color:var(--text2);padding:2px;">+${dayTasks.length-4} ×¢×•×“</div>`;
    html+='</div>';
  }

  const total=pad+last.getDate(), rem=total%7===0?0:7-(total%7);
  for(let i=1;i<=rem;i++) html+=`<div class="cal-day other-month"><div class="cal-day-num">${i}</div></div>`;

  document.getElementById('calendarGrid').innerHTML=html;
}

function calDragStart(e, taskId) {
  calDrag = taskId;
  e.dataTransfer.setData('text/plain', taskId);
  e.target.classList.add('dragging');
}

function calDragEnd(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.cal-day.drag-over').forEach(d=>d.classList.remove('drag-over'));
}

function calDragOver(e) {
  e.preventDefault();
  const day = e.target.closest('.cal-day');
  if (day && !day.classList.contains('other-month')) {
    day.classList.add('drag-over');
  }
}

function calDragLeave(e) {
  const day = e.target.closest('.cal-day');
  if (day) day.classList.remove('drag-over');
}

function calDrop(e) {
  e.preventDefault();
  const day = e.target.closest('.cal-day');
  if (!day || !calDrag) return;
  day.classList.remove('drag-over');

  const dateStr = day.dataset.date;
  if (!dateStr) return;

  const task = allTasks.find(t => t.id === calDrag);
  if (!task) return;

  const newDate = new Date(dateStr);
  const duration = Math.round((task.endDate - task.startDate) / 86400000);

  task.startDate = newDate;
  task.endDate = new Date(newDate);
  task.endDate.setDate(task.endDate.getDate() + duration);
  saveTasks();
  toast(`ğŸ“… ${task.name} ×”×•×¢×‘×¨ ×œ-${fmtD(newDate)}`);
  calDrag = null;
  renderCalendar();
}

function calNav(dir){if(dir===0) calendarDate=new Date(today); else calendarDate.setMonth(calendarDate.getMonth()+dir);renderCalendar();}

function showDayTasks(year,month,day){
  const date=new Date(year,month,day);
  const dt=allTasks.filter(t=>date>=new Date(t.startDate.toDateString())&&date<=new Date(t.endDate.toDateString()));
  let html=`<h2>ğŸ“… ${fmtD(date)}</h2>`;
  if(!dt.length) html+='<p style="color:var(--text2);margin-top:12px;">××™×Ÿ ××©×™××•×ª ×œ×™×•× ×–×”</p>';
  else {
    html+='<div style="margin-top:14px;">';
    dt.forEach(t=>{
      const c=CATEGORIES.find(x=>x.id===t.category),m=TEAM.find(x=>x.id===t.assignee);
      html+=`<div style="padding:10px;margin-bottom:8px;background:var(--surface2);border-radius:8px;border-right:3px solid ${c.color};display:flex;align-items:center;gap:10px;">
        <div style="flex:1;"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
          <strong style="font-size:13px;">${t.name}</strong>
          <span class="status-badge status-${t.status}">${getStatusLabel(t.status)}</span></div>
          <div style="font-size:11px;color:var(--text2);">${c.emoji} ${c.name} Â· ğŸ‘¤ ${m.name} Â· ğŸ¯ ${t.goal}</div></div>
        <button class="btn btn-sm btn-google" onclick="addToGCal(${t.id})" style="padding:4px 10px;">ğŸ“… GCal</button></div>`;
    });
    html+='</div>';
  }
  html+='<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">×¡×’×•×¨</button></div>';
  openModal(html);
}

// ===== CATEGORIES =====
function renderCategories(){
  let html='';
  CATEGORIES.forEach(cat=>{
    const ct=allTasks.filter(t=>t.category===cat.id), done=ct.filter(t=>t.status==='done').length;
    const pct=ct.length?Math.round(done/ct.length*100):0;
    const subs={};ct.forEach(t=>{if(!subs[t.sub])subs[t.sub]=[];subs[t.sub].push(t);});
    html+=`<div class="category-section">
      <div class="category-header" style="border-right:4px solid ${cat.color};" onclick="this.parentElement.querySelector('.category-tasks').classList.toggle('collapsed')">
        <span style="font-size:20px;">${cat.emoji}</span><h3>${cat.name}</h3>
        <div class="progress-bar" style="width:100px;"><div class="progress-fill" style="width:${pct}%;background:${cat.color};"></div></div>
        <span style="font-size:12px;color:var(--text2);">${pct}%</span><span class="category-count">${ct.length} ××©×™××•×ª</span></div>
      <div class="category-tasks">`;
    for(const sn in subs){
      html+=`<div style="padding:8px 16px;background:var(--surface2);font-size:12px;font-weight:600;color:var(--text2);border-bottom:1px solid var(--border);">${sn}</div>`;
      subs[sn].forEach(t=>{
        const m=TEAM.find(x=>x.id===t.assignee);
        html+=`<div style="display:flex;align-items:center;gap:10px;padding:8px 16px;border-bottom:1px solid rgba(51,51,70,0.3);font-size:13px;cursor:pointer;" onclick="openEditTask(${t.id})">
          <span class="priority-dot priority-${t.priority}"></span><span style="flex:1;">${t.name}</span>
          ${m?`<div class="avatar avatar-${t.assignee}" style="width:22px;height:22px;font-size:10px;">${m.name[0]}</div>`:'<span style="font-size:10px;color:var(--text2);">ğŸ¦</span>'}
          <select onchange="event.stopPropagation();updateStatus(${t.id},this.value)" style="background:transparent;border:none;color:inherit;font-family:'Heebo';font-size:11px;cursor:pointer;outline:none;">
            <option value="todo" ${t.status==='todo'?'selected':''}>ğŸ“ ×œ×‘×™×¦×•×¢</option>
            <option value="progress" ${t.status==='progress'?'selected':''}>ğŸ”„ ×‘×ª×”×œ×™×š</option>
            <option value="review" ${t.status==='review'?'selected':''}>ğŸ‘€ ×‘×‘×“×™×§×”</option>
            <option value="done" ${t.status==='done'?'selected':''}>âœ… ×”×•×©×œ×</option>
            <option value="blocked" ${t.status==='blocked'?'selected':''}>ğŸš« ×—×¡×•×</option>
          </select>
          <span style="color:var(--text2);font-size:11px;min-width:75px;text-align:left;">${t.endDate?fmtD(t.endDate):'ğŸ¦ ×‘× ×§'}</span></div>`;
      });
    }
    html+='</div></div>';
  });
  document.getElementById('categoriesContainer').innerHTML=html;
}

// ===== GOOGLE CALENDAR =====
function addToGCal(taskId) {
  const t = allTasks.find(x => x.id === taskId);
  if (!t) return;
  const cat = CATEGORIES.find(c => c.id === t.category);
  const member = TEAM.find(m => m.id === t.assignee);

  if (!t.startDate || !t.endDate) { alert('××™×Ÿ ×ª××¨×™×›×™× ×œ××©×™××” ×–×•. ×™×© ×œ×©×‘×¥ ××•×ª×” ×§×•×“×.'); return; }
  const start = fmtISO(t.startDate).replace(/-/g, '');
  const end = fmtISO(new Date(t.endDate.getTime() + 86400000)).replace(/-/g, ''); // end is exclusive

  const details = encodeURIComponent(`×™×¢×“: ${t.goal}\n××—×¨××™: ${member?.name||'×œ× ××©×•×‘×¥'}\n×§×˜×’×•×¨×™×”: ${cat.emoji} ${cat.name}\n×ª×ª-×§×˜×’×•×¨×™×”: ${t.sub}\n×¢×“×™×¤×•×ª: ${{high:'×’×‘×•×”×”',medium:'×‘×™× ×•× ×™×ª',low:'× ××•×›×”'}[t.priority]}`);
  const title = encodeURIComponent(`${cat.emoji} ${t.name}`);

  const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${start}/${end}&details=${details}&sf=true`;
  window.open(url, '_blank');
}

function exportAllToGCal() {
  const pending = allTasks.filter(t => t.status !== 'done');
  if (pending.length > 20) {
    openModal(`<h2>ğŸ“… ×™×™×¦×•× ×œ×’×•×’×œ ×§×œ× ×“×¨</h2>
      <p style="margin-bottom:14px;color:var(--text2);">×™×© ${pending.length} ××©×™××•×ª ×¤×ª×•×—×•×ª. ×™×™×¦×•× ×©×œ ×™×•×ª×¨ ×-20 ××©×™××•×ª ×‘×‘×ª ××—×ª ×¢×œ×•×œ ×œ×¤×ª×•×— ×—×œ×•× ×•×ª ×¨×‘×™×.</p>
      <p style="margin-bottom:14px;">××•××œ×¥ ×œ×”×•×¨×™×“ ×§×•×‘×¥ ICS ×•×œ×™×™×‘× ××•×ª×• ×œ×’×•×’×œ ×§×œ× ×“×¨ ×‘×¤×¢×•×œ×” ××—×ª.</p>
      <div class="modal-actions">
        <button class="btn btn-google" onclick="closeModal();exportICS()">â¬‡ï¸ ×”×•×¨×“ ×§×•×‘×¥ ICS</button>
        <button class="btn btn-primary" onclick="closeModal();batchGCal()">ğŸ“… ×¤×ª×— ×‘×›×œ ×–××ª (${Math.min(20,pending.length)} ×¨××©×•× ×•×ª)</button>
        <button class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
      </div>`);
  } else {
    batchGCal();
  }
}

function batchGCal() {
  const pending = allTasks.filter(t => t.status !== 'done').slice(0, 20);
  pending.forEach((t, i) => {
    setTimeout(() => addToGCal(t.id), i * 800);
  });
  toast(`ğŸ“… ×¤×•×ª×— ${pending.length} ××©×™××•×ª ×‘×’×•×’×œ ×§×œ× ×“×¨...`);
}

function exportICS() {
  let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Studio Manager//HE\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n';

  allTasks.filter(t => t.status !== 'done' && t.startDate && t.endDate).forEach(t => {
    const cat = CATEGORIES.find(c => c.id === t.category);
    const member = TEAM.find(m => m.id === t.assignee);
    const start = fmtISO(t.startDate).replace(/-/g, '');
    const end = fmtISO(new Date(t.endDate.getTime() + 86400000)).replace(/-/g, '');

    ics += `BEGIN:VEVENT\nDTSTART;VALUE=DATE:${start}\nDTEND;VALUE=DATE:${end}\n`;
    ics += `SUMMARY:${cat.emoji} ${t.name}\n`;
    ics += `DESCRIPTION:×™×¢×“: ${t.goal}\\n××—×¨××™: ${member?.name||'×œ× ××©×•×‘×¥'}\\n×§×˜×’×•×¨×™×”: ${cat.name}\\n×¢×“×™×¤×•×ª: ${{high:'×’×‘×•×”×”',medium:'×‘×™× ×•× ×™×ª',low:'× ××•×›×”'}[t.priority]}\n`;
    ics += `STATUS:${t.status === 'progress' ? 'IN-PROCESS' : 'NEEDS-ACTION'}\n`;
    ics += `UID:studio-${t.id}@studioManager\n`;
    ics += `END:VEVENT\n`;
  });

  ics += 'END:VCALENDAR';

  const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'studio-tasks.ics';
  a.click();
  URL.revokeObjectURL(url);
  toast('â¬‡ï¸ ×§×•×‘×¥ ICS ×”×•×¨×“ - ×™×™×‘× ××•×ª×• ×œ×’×•×’×œ ×§×œ× ×“×¨');
}

// ===== MODAL & FORMS =====
function openModal(html){document.getElementById('modalContent').innerHTML=html;document.getElementById('modalOverlay').classList.add('show');}
function closeModal(){document.getElementById('modalOverlay').classList.remove('show');}

function openAddTask(){
  const co=CATEGORIES.map(c=>`<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');
  const ao=TEAM.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
  openModal(`<h2>â• ××©×™××” ×—×“×©×”</h2>
    <div class="form-group"><label>×©× ×”××©×™××”</label><input class="form-input" id="f-name" placeholder="××” ×¦×¨×™×š ×œ×¢×©×•×ª?"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group"><label>×§×˜×’×•×¨×™×”</label><select class="form-input" id="f-category" onchange="updateSubOpts()">${co}</select></div>
      <div class="form-group"><label>×ª×ª-×§×˜×’×•×¨×™×”</label><select class="form-input" id="f-sub"></select></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div class="form-group"><label>××—×¨××™</label><select class="form-input" id="f-assignee">${ao}</select></div>
      <div class="form-group"><label>×¢×“×™×¤×•×ª</label><select class="form-input" id="f-priority"><option value="high">ğŸ”´ ×’×‘×•×”×”</option><option value="medium" selected>ğŸŸ¡ ×‘×™× ×•× ×™×ª</option><option value="low">ğŸŸ¢ × ××•×›×”</option></select></div>
      <div class="form-group"><label>×¡×˜×˜×•×¡</label><select class="form-input" id="f-status"><option value="todo">ğŸ“ ×œ×‘×™×¦×•×¢</option><option value="progress">ğŸ”„ ×‘×ª×”×œ×™×š</option></select></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group"><label>×ª××¨×™×š ×”×ª×—×œ×”</label><input class="form-input" type="date" id="f-start" value="${fmtISO(today)}"></div>
      <div class="form-group"><label>×“×“-×œ×™×™×Ÿ</label><input class="form-input" type="date" id="f-end"></div>
    </div>
    <div class="form-group"><label>×™×¢×“</label><input class="form-input" id="f-goal" placeholder="××” ×”×™×¢×“ ×©×œ ×”××©×™××”?"></div>
    <div class="form-group"><label>×”×¢×¨×•×ª</label><textarea class="form-input" id="f-notes" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveNewTask()">ğŸ’¾ ×©××•×¨</button>
      <button class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`);
  updateSubOpts();
}

function updateSubOpts(){const c=CATEGORIES.find(x=>x.id===document.getElementById('f-category').value);document.getElementById('f-sub').innerHTML=c.subs.map(s=>`<option value="${s}">${s}</option>`).join('');}

function saveNewTask(){
  const name=document.getElementById('f-name').value.trim();
  if(!name)return alert('× × ×œ×”×–×™×Ÿ ×©× ××©×™××”');
  allTasks.push({id:nextId++,name,category:document.getElementById('f-category').value,sub:document.getElementById('f-sub').value,
    assignee:document.getElementById('f-assignee').value,priority:document.getElementById('f-priority').value,
    status:document.getElementById('f-status').value,goal:document.getElementById('f-goal').value,
    startDate:document.getElementById('f-start').value?new Date(document.getElementById('f-start').value):null,endDate:document.getElementById('f-end').value?new Date(document.getElementById('f-end').value):null,notes:document.getElementById('f-notes').value,
    subtasks:[],tags:[],recurrence:'none',comments:[],inBank:!document.getElementById('f-assignee').value||!document.getElementById('f-start').value||!document.getElementById('f-end').value});
  saveTasks();closeModal();renderView();toast('âœ… ××©×™××” ×—×“×©×” × ×•×¡×¤×”');
}

function openEditTask(id){
  const t=allTasks.find(x=>x.id===id);if(!t)return;
  const co=CATEGORIES.map(c=>`<option value="${c.id}" ${t.category===c.id?'selected':''}>${c.emoji} ${c.name}</option>`).join('');
  const ao=TEAM.map(m=>`<option value="${m.id}" ${t.assignee===m.id?'selected':''}>${m.name}</option>`).join('');
  const cat=CATEGORIES.find(c=>c.id===t.category);
  const so=cat.subs.map(s=>`<option value="${s}" ${t.sub===s?'selected':''}>${s}</option>`).join('');

  openModal(`<h2>âœï¸ ×¢×¨×™×›×ª ××©×™××”</h2>
    <div class="form-group"><label>×©× ×”××©×™××”</label><input class="form-input" id="f-name" value="${t.name}"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group"><label>×§×˜×’×•×¨×™×”</label><select class="form-input" id="f-category" onchange="updateSubOptsE()">${co}</select></div>
      <div class="form-group"><label>×ª×ª-×§×˜×’×•×¨×™×”</label><select class="form-input" id="f-sub">${so}</select></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div class="form-group"><label>××—×¨××™</label><select class="form-input" id="f-assignee">${ao}</select></div>
      <div class="form-group"><label>×¢×“×™×¤×•×ª</label><select class="form-input" id="f-priority">
        <option value="high" ${t.priority==='high'?'selected':''}>ğŸ”´ ×’×‘×•×”×”</option><option value="medium" ${t.priority==='medium'?'selected':''}>ğŸŸ¡ ×‘×™× ×•× ×™×ª</option><option value="low" ${t.priority==='low'?'selected':''}>ğŸŸ¢ × ××•×›×”</option></select></div>
      <div class="form-group"><label>×¡×˜×˜×•×¡</label><select class="form-input" id="f-status">
        <option value="todo" ${t.status==='todo'?'selected':''}>ğŸ“ ×œ×‘×™×¦×•×¢</option><option value="progress" ${t.status==='progress'?'selected':''}>ğŸ”„ ×‘×ª×”×œ×™×š</option><option value="review" ${t.status==='review'?'selected':''}>ğŸ‘€ ×‘×‘×“×™×§×”</option><option value="done" ${t.status==='done'?'selected':''}>âœ… ×”×•×©×œ×</option><option value="blocked" ${t.status==='blocked'?'selected':''}>ğŸš« ×—×¡×•×</option></select></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group"><label>×ª××¨×™×š ×”×ª×—×œ×”</label><input class="form-input" type="date" id="f-start" value="${t.startDate?fmtISO(t.startDate):''}"></div>
      <div class="form-group"><label>×“×“-×œ×™×™×Ÿ</label><input class="form-input" type="date" id="f-end" value="${t.endDate?fmtISO(t.endDate):''}"></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group"><label>×™×¢×“</label><input class="form-input" id="f-goal" value="${t.goal}"></div>
      <div class="form-group"><label>ğŸ” ×—×–×¨×”</label><select class="form-input" id="f-recurrence">
        <option value="none" ${t.recurrence==='none'?'selected':''}>×œ×œ×</option>
        <option value="daily" ${t.recurrence==='daily'?'selected':''}>×™×•××™</option>
        <option value="weekly" ${t.recurrence==='weekly'?'selected':''}>×©×‘×•×¢×™</option>
        <option value="biweekly" ${t.recurrence==='biweekly'?'selected':''}>×“×•-×©×‘×•×¢×™</option>
        <option value="monthly" ${t.recurrence==='monthly'?'selected':''}>×—×•×“×©×™</option>
      </select></div>
    </div>
    <div class="form-group"><label>ğŸ·ï¸ ×ª×’×™×•×ª</label>
      <div class="tags-wrap" id="f-tags-wrap">${(t.tags||[]).map((tag,i) => `<span class="tag" style="background:${TAG_COLORS[TAG_PRESETS.indexOf(tag)%TAG_COLORS.length]}33;color:${TAG_COLORS[TAG_PRESETS.indexOf(tag)%TAG_COLORS.length]};">${tag}<button class="tag-remove" onclick="removeTagFromEdit(${t.id},'${tag}')">âœ•</button></span>`).join('')}</div>
      <div class="tag-input-wrap"><input id="f-tag-input" placeholder="×”×•×¡×£ ×ª×’×™×ª..." onkeydown="if(event.key==='Enter'){addTagToEdit(${t.id});event.preventDefault();}"><button class="btn btn-secondary btn-sm" onclick="addTagToEdit(${t.id})">+</button></div>
      <div class="tag-presets">${TAG_PRESETS.filter(p => !(t.tags||[]).includes(p)).map(p => `<span class="tag-preset" onclick="addPresetTag(${t.id},'${p}')">${p}</span>`).join('')}</div>
    </div>
    <div class="form-group"><label>ğŸ“‹ ×ª×ª×™-××©×™××•×ª ${t.subtasks&&t.subtasks.length ? `(${t.subtasks.filter(s=>s.done).length}/${t.subtasks.length})` : ''}</label>
      ${t.subtasks&&t.subtasks.length ? `<div class="subtask-progress"><div class="progress-bar" style="flex:1;"><div class="progress-fill" style="width:${t.subtasks.length?t.subtasks.filter(s=>s.done).length/t.subtasks.length*100:0}%;background:var(--green);"></div></div><span>${Math.round(t.subtasks.length?t.subtasks.filter(s=>s.done).length/t.subtasks.length*100:0)}%</span></div>` : ''}
      <div class="subtask-list" id="f-subtasks">${(t.subtasks||[]).map(s => `<div class="subtask-item"><input type="checkbox" ${s.done?'checked':''} onchange="toggleSubtask(${t.id},${s.id})"><span class="st-text ${s.done?'done':''}">${s.text}</span><button class="st-del" onclick="removeSubtask(${t.id},${s.id})">âœ•</button></div>`).join('')}</div>
      <div class="subtask-add"><input id="f-st-input" placeholder="×”×•×¡×£ ×ª×ª-××©×™××”..." onkeydown="if(event.key==='Enter'){addSubtask(${t.id});event.preventDefault();}"><button class="btn btn-secondary btn-sm" onclick="addSubtask(${t.id})">+</button></div>
    </div>
    <div class="form-group"><label>×”×¢×¨×•×ª</label><textarea class="form-input" id="f-notes">${t.notes||''}</textarea></div>
    ${renderComments(t.id)}
    <div class="timer-widget">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div><span style="font-size:13px;font-weight:600;">â±ï¸ ××¢×§×‘ ×–××Ÿ</span><span class="time-logged">${t.timeLogged ? (t.timeLogged/3600).toFixed(1)+'×© '+(Math.round(t.timeLogged%3600/60))+'×“ ×ª×•×¢×“×•' : '×œ×œ× ×ª×™×¢×•×“'}</span></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="timer-display" id="timer-display-${t.id}">${activeTimer&&activeTimer.taskId===t.id?'×¤×•×¢×œ...':'00:00'}</span>
          ${activeTimer&&activeTimer.taskId===t.id
            ? `<button class="timer-btn" onclick="stopTimer()" style="background:var(--red);">â¹ ×¢×¦×•×¨</button>`
            : `<button class="timer-btn" onclick="startTimer(${t.id})">â–¶ ×”×ª×—×œ</button>`}
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveEditTask(${t.id})">ğŸ’¾ ×©××•×¨</button>
      <button class="btn btn-google" onclick="addToGCal(${t.id})">ğŸ“… ×”×•×¡×£ ×œ×’×•×’×œ ×§×œ× ×“×¨</button>
      <button class="btn btn-secondary" onclick="deleteTask(${t.id})" style="background:var(--red-bg);color:var(--red);border-color:var(--red);">ğŸ—‘ï¸ ××—×§</button>
      <button class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`);
}

function updateSubOptsE(){const c=CATEGORIES.find(x=>x.id===document.getElementById('f-category').value);document.getElementById('f-sub').innerHTML=c.subs.map(s=>`<option value="${s}">${s}</option>`).join('');}

function saveEditTask(id){
  const t=allTasks.find(x=>x.id===id);if(!t)return;
  t.name=document.getElementById('f-name').value;t.category=document.getElementById('f-category').value;t.sub=document.getElementById('f-sub').value;
  t.assignee=document.getElementById('f-assignee').value;t.priority=document.getElementById('f-priority').value;t.status=document.getElementById('f-status').value;
  const sv=document.getElementById('f-start').value, ev=document.getElementById('f-end').value;
  t.startDate=sv?new Date(sv):null;t.endDate=ev?new Date(ev):null;
  t.goal=document.getElementById('f-goal').value;t.notes=document.getElementById('f-notes').value;
  t.recurrence=document.getElementById('f-recurrence').value;
  // Update bank status based on assignment
  t.inBank = !t.assignee || !t.startDate || !t.endDate;
  if(t.status==='done' && t.recurrence && t.recurrence!=='none') generateRecurringTask(t);
  saveTasks();closeModal();renderView();toast('âœ… ××©×™××” ×¢×•×“×›× ×”');
}

function deleteTask(id){if(!confirm('×œ××—×•×§ ××ª ×”××©×™××”?'))return;allTasks=allTasks.filter(t=>t.id!==id);saveTasks();closeModal();renderView();toast('ğŸ—‘ï¸ ××©×™××” × ××—×§×”');}

// ===== HELPERS =====
function fmtD(d){if(!(d instanceof Date))d=new Date(d);return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;}
function fmtDS(d){return `${d.getDate()}/${d.getMonth()+1}`;}
function fmtISO(d){if(!(d instanceof Date))d=new Date(d);return d.toISOString().split('T')[0];}
function getStatusLabel(s){return {todo:'×œ×‘×™×¦×•×¢',progress:'×‘×ª×”×œ×™×š',review:'×‘×‘×“×™×§×”',done:'×”×•×©×œ×',blocked:'×—×¡×•×'}[s]||s;}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.classList.add('hide'), 2500);
  setTimeout(() => t.remove(), 3000);
}

// ===== WORKLOAD VIEW =====
function renderWorkload() {
  let cards = '';
  TEAM.forEach(m => {
    const mt = allTasks.filter(t => t.assignee === m.id);
    const done = mt.filter(t => t.status === 'done').length;
    const prog = mt.filter(t => t.status === 'progress').length;
    const todo = mt.filter(t => t.status === 'todo').length;
    const review = mt.filter(t => t.status === 'review').length;
    const blocked = mt.filter(t => t.status === 'blocked').length;
    const overdue = mt.filter(t => t.endDate && t.endDate < today && t.status !== 'done').length;
    const pct = mt.length ? Math.round(done / mt.length * 100) : 0;
    const totalHrs = mt.reduce((s, t) => s + (t.timeLogged || 0), 0);
    cards += `<div class="workload-card">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
        <div class="avatar avatar-${m.id}" style="width:40px;height:40px;font-size:16px;">${m.name[0]}</div>
        <div><div style="font-weight:600;font-size:15px;">${m.name}</div><div style="font-size:11px;color:var(--text2);">${m.role} â€¢ ${mt.length} ××©×™××•×ª</div></div>
      </div>
      <div class="progress-bar" style="margin-bottom:10px;"><div class="progress-fill" style="width:${pct}%;background:${m.color};"></div></div>
      <div style="font-size:11px;color:var(--text2);margin-bottom:12px;">${pct}% ×”×•×©×œ× â€¢ ${totalHrs > 0 ? (totalHrs / 60).toFixed(1) + ' ×©×¢×•×ª ××ª×•×¢×“×•×ª' : '×œ×œ× ×ª×™×¢×•×“ ×–××Ÿ'}</div>
      <div class="wl-bar-row"><span>×œ×‘×™×¦×•×¢</span><div class="wl-fill" style="width:${mt.length ? todo/mt.length*100 : 0}%;background:var(--blue);"></div><span>${todo}</span></div>
      <div class="wl-bar-row"><span>×‘×ª×”×œ×™×š</span><div class="wl-fill" style="width:${mt.length ? prog/mt.length*100 : 0}%;background:var(--yellow);"></div><span>${prog}</span></div>
      <div class="wl-bar-row"><span>×‘×‘×“×™×§×”</span><div class="wl-fill" style="width:${mt.length ? review/mt.length*100 : 0}%;background:var(--purple);"></div><span>${review}</span></div>
      <div class="wl-bar-row"><span>×”×•×©×œ×</span><div class="wl-fill" style="width:${mt.length ? done/mt.length*100 : 0}%;background:var(--green);"></div><span>${done}</span></div>
      <div class="wl-bar-row"><span>×—×¡×•×</span><div class="wl-fill" style="width:${mt.length ? blocked/mt.length*100 : 0}%;background:var(--red);"></div><span>${blocked}</span></div>
      ${overdue > 0 ? `<div style="margin-top:8px;padding:6px 10px;background:var(--red-bg);border-radius:6px;font-size:12px;color:var(--red);">âš ï¸ ${overdue} ××©×™××•×ª ×‘××™×—×•×¨</div>` : ''}
    </div>`;
  });
  document.getElementById('workloadCards').innerHTML = cards;

  // Heatmap - 13 weeks
  const startW = new Date(today); startW.setDate(startW.getDate() - startW.getDay());
  let hm = '<div style="display:flex;gap:2px;margin-bottom:6px;padding-right:70px;">';
  for (let w = 0; w < 13; w++) {
    const wd = new Date(startW); wd.setDate(wd.getDate() + w * 7);
    hm += `<div style="flex:1;text-align:center;font-size:9px;color:var(--text2);">${wd.getDate()}/${wd.getMonth()+1}</div>`;
  }
  hm += '</div>';
  TEAM.forEach(m => {
    hm += `<div style="display:flex;align-items:center;gap:2px;margin-bottom:2px;">
      <div style="width:70px;font-size:11px;color:var(--text2);text-align:left;">${m.name}</div>`;
    for (let w = 0; w < 13; w++) {
      const ws = new Date(startW); ws.setDate(ws.getDate() + w * 7);
      const we = new Date(ws); we.setDate(we.getDate() + 6);
      const cnt = allTasks.filter(t => t.assignee === m.id && t.status !== 'done' && t.startDate <= we && t.endDate >= ws).length;
      const intensity = Math.min(cnt / 5, 1);
      const bg = cnt === 0 ? 'var(--surface2)' : `rgba(${m.color.match(/\w\w/g).map(x=>parseInt(x,16)).join(',')},${0.2 + intensity * 0.7})`;
      hm += `<div style="flex:1;height:24px;background:${bg};border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;" title="${m.name}: ${cnt} ××©×™××•×ª ×¤×¢×™×œ×•×ª">${cnt||''}</div>`;
    }
    hm += '</div>';
  });
  document.getElementById('workloadHeatmap').innerHTML = hm;
}

// ===== WEEK VIEW =====
let weekOffset = 0;
function weekNav(dir) {
  if (dir === 0) weekOffset = 0; else weekOffset += dir;
  renderWeekView();
}

function renderWeekView() {
  const base = new Date(today);
  base.setDate(base.getDate() + weekOffset * 7);
  // Find Sunday of this week
  const sun = new Date(base);
  sun.setDate(sun.getDate() - sun.getDay());
  const days = [];
  const dayNames = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™'];
  for (let i = 0; i < 5; i++) {
    const d = new Date(sun); d.setDate(d.getDate() + i);
    days.push(d);
  }
  const endD = new Date(sun); endD.setDate(endD.getDate() + 4);
  document.getElementById('weekTitle').textContent = `${fmtDS(sun)} - ${fmtDS(endD)}`;

  let html = '<div class="week-grid"><div class="week-header"><div class="week-member"></div>';
  days.forEach((d, i) => {
    const isToday = d.toDateString() === today.toDateString();
    html += `<div class="week-cell" style="${isToday ? 'background:rgba(108,92,231,0.15);border-radius:8px;' : ''}"><div style="font-weight:600;font-size:13px;">${dayNames[i]}</div><div style="font-size:11px;color:var(--text2);">${fmtDS(d)}</div></div>`;
  });
  html += '</div>';

  TEAM.forEach(m => {
    html += `<div class="week-header"><div class="week-member"><div class="avatar avatar-${m.id}" style="width:28px;height:28px;font-size:11px;">${m.name[0]}</div><span style="font-size:12px;">${m.name}</span></div>`;
    days.forEach(d => {
      const dayStart = new Date(d); dayStart.setHours(0,0,0,0);
      const dayEnd = new Date(d); dayEnd.setHours(23,59,59,999);
      const tasks = allTasks.filter(t => t.assignee === m.id && t.startDate && t.endDate && t.startDate <= dayEnd && t.endDate >= dayStart && t.status !== 'done');
      html += '<div class="week-cell">';
      tasks.forEach(t => {
        const cat = CATEGORIES.find(c => c.id === t.category);
        const pColor = {high:'var(--red)',medium:'var(--yellow)',low:'var(--green)'}[t.priority];
        html += `<div class="week-task" onclick="openEditTask(${t.id})" style="border-right:3px solid ${pColor};cursor:pointer;" title="${t.name}">
          <div style="font-size:11px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${cat?cat.emoji:''} ${t.name}</div>
          <div style="font-size:9px;color:var(--text2);margin-top:2px;">${getStatusLabel(t.status)}${t.timeLogged ? ' â€¢ '+(t.timeLogged/60).toFixed(1)+'×©' : ''}</div>
        </div>`;
      });
      if (tasks.length === 0) html += '<div style="font-size:10px;color:var(--text2);text-align:center;padding:8px;">â€”</div>';
      html += '</div>';
    });
    html += '</div>';
  });
  html += '</div>';
  document.getElementById('weekGrid').innerHTML = html;
}

// ===== KANBAN =====
let kanbanFilterVal = 'all';
function kanbanFilter(val, el) {
  kanbanFilterVal = val;
  if (el) {
    el.parentElement.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
  }
  renderKanban();
}

function renderKanban() {
  const statuses = [
    {id:'todo', label:'×œ×‘×™×¦×•×¢', icon:'ğŸ“‹', color:'var(--blue)'},
    {id:'progress', label:'×‘×ª×”×œ×™×š', icon:'ğŸ”„', color:'var(--yellow)'},
    {id:'review', label:'×‘×‘×“×™×§×”', icon:'ğŸ‘€', color:'var(--purple)'},
    {id:'blocked', label:'×—×¡×•×', icon:'ğŸš«', color:'var(--red)'},
    {id:'done', label:'×”×•×©×œ×', icon:'âœ…', color:'var(--green)'}
  ];
  const filtered = kanbanFilterVal === 'all' ? allTasks : allTasks.filter(t => t.assignee === kanbanFilterVal);

  let html = '';
  statuses.forEach(s => {
    const tasks = filtered.filter(t => t.status === s.id);
    html += `<div class="kanban-column" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="kanbanDrop(event,'${s.id}');this.classList.remove('drag-over')">
      <div class="kanban-col-header"><span>${s.icon} ${s.label}</span><span class="badge" style="background:${s.color}22;color:${s.color};">${tasks.length}</span></div>
      <div class="kanban-col-body">`;
    tasks.forEach(t => {
      const m = TEAM.find(x => x.id === t.assignee);
      const cat = CATEGORIES.find(c => c.id === t.category);
      const pColor = {high:'var(--red)',medium:'var(--yellow)',low:'var(--green)'}[t.priority];
      html += `<div class="kanban-card" draggable="true" ondragstart="event.dataTransfer.setData('text','${t.id}')" onclick="openEditTask(${t.id})" style="cursor:pointer;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-size:11px;color:var(--text2);">${cat ? cat.emoji + ' ' + cat.name : ''}</span>
          <span style="width:8px;height:8px;border-radius:50%;background:${pColor};"></span>
        </div>
        <div style="font-size:13px;font-weight:500;margin-bottom:8px;">${t.name}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="avatar avatar-${t.assignee}" style="width:22px;height:22px;font-size:9px;" title="${m?m.name:''}">${m?m.name[0]:''}</div>
          <span style="font-size:10px;color:var(--text2);">${t.endDate?fmtDS(t.endDate):'â€”'}</span>
        </div>
      </div>`;
    });
    html += '</div></div>';
  });
  document.getElementById('kanbanContainer').innerHTML = html;
}

function kanbanDrop(e, newStatus) {
  e.preventDefault();
  const taskId = parseInt(e.dataTransfer.getData('text'));
  const task = allTasks.find(t => t.id === taskId);
  if (task) {
    task.status = newStatus;
    saveTasks();renderKanban();
    toast('âœ… ×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×œ' + getStatusLabel(newStatus));
  }
}

// ===== TIME TRACKING =====
let activeTimer = null;
let timerInterval = null;

// Add timeLogged to all tasks if missing
allTasks.forEach(t => { if (!t.timeLogged) t.timeLogged = 0; });

function startTimer(taskId) {
  if (activeTimer) stopTimer();
  activeTimer = { taskId, startTime: Date.now() };
  const task = allTasks.find(t => t.id === taskId);
  timerInterval = setInterval(() => {
    const el = document.getElementById('timer-display-' + taskId);
    if (el) {
      const elapsed = Math.floor((Date.now() - activeTimer.startTime) / 1000);
      const m = Math.floor(elapsed / 60), s = elapsed % 60;
      el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
  }, 1000);
  toast('â±ï¸ ×˜×™×™××¨ ×”×•×¤×¢×œ: ' + (task ? task.name : ''));
  renderView();
}

function stopTimer() {
  if (!activeTimer) return;
  const elapsed = Math.floor((Date.now() - activeTimer.startTime) / 1000);
  const minutes = Math.round(elapsed / 60);
  const task = allTasks.find(t => t.id === activeTimer.taskId);
  if (task) {
    task.timeLogged = (task.timeLogged || 0) + elapsed;
    toast(`â±ï¸ ${minutes} ×“×§×•×ª ×ª×•×¢×“×• ×œ: ${task.name}`);
  }
  clearInterval(timerInterval);
  activeTimer = null;
  timerInterval = null;
  renderView();
}

// ===== BURNDOWN CHART =====
let burndownRange = 'month';
function setBurndownRange(range, el) {
  burndownRange = range;
  if (el) { el.parentElement.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); }
  renderBurndown();
}

function renderBurndown() {
  const days = burndownRange === 'month' ? 30 : burndownRange === 'quarter' ? 90 : 180;
  const startD = new Date(today); startD.setDate(startD.getDate() - days);
  const totalTasks = allTasks.length;

  // Calculate ideal and actual burndown
  const points = [];
  const tasksAtStart = allTasks.filter(t => t.startDate && t.startDate <= startD).length;
  const remaining = totalTasks - allTasks.filter(t => t.status === 'done').length;

  for (let i = 0; i <= days; i++) {
    const d = new Date(startD); d.setDate(d.getDate() + i);
    const doneByDate = allTasks.filter(t => t.status === 'done' && t.endDate && t.endDate <= d).length;
    const ideal = totalTasks - Math.round((totalTasks / days) * i);
    points.push({ day: i, date: d, actual: totalTasks - doneByDate, ideal: Math.max(0, ideal) });
  }

  const W = 800, H = 280, padL = 50, padR = 20, padT = 20, padB = 40;
  const chartW = W - padL - padR, chartH = H - padT - padB;
  const maxY = totalTasks;
  const scaleX = i => padL + (i / days) * chartW;
  const scaleY = v => padT + (1 - v / maxY) * chartH;

  // Grid lines
  let svg = `<svg viewBox="0 0 ${W} ${H}" class="burndown-svg">`;
  for (let g = 0; g <= 4; g++) {
    const y = scaleY((maxY / 4) * g);
    const val = Math.round((maxY / 4) * g);
    svg += `<line x1="${padL}" y1="${y}" x2="${W-padR}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;
    svg += `<text x="${padL-8}" y="${y+4}" fill="var(--text2)" font-size="10" text-anchor="end" font-family="Heebo">${val}</text>`;
  }

  // X-axis labels
  const labelStep = Math.max(1, Math.floor(days / 6));
  for (let i = 0; i <= days; i += labelStep) {
    const d = points[i].date;
    svg += `<text x="${scaleX(i)}" y="${H-5}" fill="var(--text2)" font-size="9" text-anchor="middle" font-family="Heebo">${d.getDate()}/${d.getMonth()+1}</text>`;
  }

  // Ideal line
  svg += `<polyline fill="none" stroke="var(--text2)" stroke-width="1.5" stroke-dasharray="6 4" opacity="0.5" points="`;
  points.forEach(p => { svg += `${scaleX(p.day)},${scaleY(p.ideal)} `; });
  svg += `"/>`;

  // Actual line with gradient fill
  svg += `<defs><linearGradient id="burnFill" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent)" stop-opacity="0.3"/><stop offset="100%" stop-color="var(--accent)" stop-opacity="0.02"/></linearGradient></defs>`;
  svg += `<polygon fill="url(#burnFill)" points="${scaleX(0)},${scaleY(0)} `;
  points.forEach(p => { svg += `${scaleX(p.day)},${scaleY(p.actual)} `; });
  svg += `${scaleX(days)},${scaleY(0)}"/>`;

  svg += `<polyline fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" points="`;
  points.forEach(p => { svg += `${scaleX(p.day)},${scaleY(p.actual)} `; });
  svg += `"/>`;

  // Today marker
  const todayIdx = days;
  svg += `<circle cx="${scaleX(todayIdx)}" cy="${scaleY(points[todayIdx].actual)}" r="5" fill="var(--accent)" stroke="var(--bg)" stroke-width="2"/>`;
  svg += `<text x="${scaleX(todayIdx)}" y="${scaleY(points[todayIdx].actual)-12}" fill="var(--accent)" font-size="11" text-anchor="middle" font-family="Heebo" font-weight="600">${points[todayIdx].actual} × ×•×ª×¨×•</text>`;

  svg += '</svg>';

  // Summary stats
  const doneTotal = allTasks.filter(t => t.status === 'done').length;
  const doneThisPeriod = allTasks.filter(t => t.status === 'done' && t.endDate >= startD && t.endDate <= today).length;
  const avgPerDay = days > 0 ? (doneThisPeriod / days).toFixed(1) : 0;
  const daysToFinish = avgPerDay > 0 ? Math.ceil(remaining / avgPerDay) : 'âˆ';

  let html = `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px;">
    <div style="background:var(--surface2);padding:12px;border-radius:8px;text-align:center;"><div style="font-size:11px;color:var(--text2);">×¡×”"×› ××©×™××•×ª</div><div style="font-size:24px;font-weight:700;">${totalTasks}</div></div>
    <div style="background:var(--surface2);padding:12px;border-radius:8px;text-align:center;"><div style="font-size:11px;color:var(--text2);">×”×•×©×œ××• ×‘×ª×§×•×¤×”</div><div style="font-size:24px;font-weight:700;color:var(--green);">${doneThisPeriod}</div></div>
    <div style="background:var(--surface2);padding:12px;border-radius:8px;text-align:center;"><div style="font-size:11px;color:var(--text2);">×××•×¦×¢ ×œ×™×•×</div><div style="font-size:24px;font-weight:700;color:var(--blue);">${avgPerDay}</div></div>
    <div style="background:var(--surface2);padding:12px;border-radius:8px;text-align:center;"><div style="font-size:11px;color:var(--text2);">×™××™× ×œ×¡×™×•× (×¦×¤×™)</div><div style="font-size:24px;font-weight:700;color:var(--yellow);">${daysToFinish}</div></div>
  </div>`;
  html += svg;
  html += `<div class="burndown-legend"><span style="color:var(--accent);">â— ×§×• ×‘×¤×•×¢×œ</span><span style="color:var(--text2);">â— ×§×• ××™×“×™××œ×™</span></div>`;

  document.getElementById('burndownChart').innerHTML = html;
}

// ===== ACTIVITY LOG =====
let activityLogData = [];
let logFilterVal = 'all';

// Track activities - wrap existing functions
const _origSaveNew = typeof saveNewTask === 'function' ? saveNewTask : null;
const _origSaveEdit = typeof saveEditTask === 'function' ? saveEditTask : null;
const _origDeleteTask = typeof deleteTask === 'function' ? deleteTask : null;

function logActivity(type, icon, text) {
  activityLogData.unshift({ type, icon, text, time: new Date() });
  if (activityLogData.length > 200) activityLogData.pop();
}

// Generate some initial activity log entries from existing tasks
(function initActivityLog() {
  const statusIcons = { done:'âœ…', progress:'ğŸ”„', review:'ğŸ‘€', todo:'ğŸ“‹', blocked:'ğŸš«' };
  // Simulate past activities from task data
  allTasks.forEach(t => {
    const m = TEAM.find(x => x.id === t.assignee);
    const cat = CATEGORIES.find(c => c.id === t.category);
    const d = new Date(t.startDate);
    activityLogData.push({
      type: 'create', icon: 'â•',
      text: `<strong>${m ? m.name : ''}</strong> ×™×¦×¨/×” ××ª ×”××©×™××” "${t.name}" ×‘×§×˜×’×•×¨×™×” ${cat ? cat.emoji + ' ' + cat.name : ''}`,
      time: d
    });
    if (t.status !== 'todo') {
      const d2 = new Date(t.startDate); d2.setDate(d2.getDate() + 2);
      activityLogData.push({
        type: 'status', icon: statusIcons[t.status] || 'ğŸ”„',
        text: `<strong>${m ? m.name : ''}</strong> ×©×™× ×”/×ª×” ×¡×˜×˜×•×¡ ×œ${getStatusLabel(t.status)}: "${t.name}"`,
        time: d2
      });
    }
  });
  activityLogData.sort((a, b) => b.time - a.time);
  activityLogData = activityLogData.slice(0, 100);
})();

function logFilter(val, el) {
  logFilterVal = val;
  if (el) { el.parentElement.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); }
  renderActivityLog();
}

function renderActivityLog() {
  const filtered = logFilterVal === 'all' ? activityLogData : activityLogData.filter(a => a.type === logFilterVal);
  if (filtered.length === 0) {
    document.getElementById('activityLog').innerHTML = '<div style="text-align:center;padding:40px;color:var(--text2);">××™×Ÿ ×¤×¢×™×œ×•×ª ××¡×•×’ ×–×”</div>';
    return;
  }
  let html = '';
  let lastDate = '';
  filtered.forEach(a => {
    const dateStr = fmtD(a.time);
    if (dateStr !== lastDate) {
      lastDate = dateStr;
      html += `<div style="padding:8px 16px;font-size:11px;color:var(--text2);background:var(--surface2);font-weight:600;">${dateStr}</div>`;
    }
    const timeStr = `${String(a.time.getHours()).padStart(2,'0')}:${String(a.time.getMinutes()).padStart(2,'0')}`;
    html += `<div class="log-entry"><span class="log-time">${timeStr}</span><span class="log-icon">${a.icon}</span><span class="log-text">${a.text}</span></div>`;
  });
  document.getElementById('activityLog').innerHTML = html;
}

// ===== REPORTS =====
let reportPeriod = 'week';
function setReportPeriod(period, el) {
  reportPeriod = period;
  if (el) { el.parentElement.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); }
  renderReports();
}

function renderReports() {
  const now = today;
  let periodStart;
  if (reportPeriod === 'week') { periodStart = new Date(now); periodStart.setDate(periodStart.getDate() - 7); }
  else if (reportPeriod === 'month') { periodStart = new Date(now); periodStart.setMonth(periodStart.getMonth() - 1); }
  else { periodStart = new Date(2020, 0, 1); }

  const periodTasks = allTasks.filter(t => t.startDate && t.endDate && t.startDate <= now && t.endDate >= periodStart);
  const donePeriod = periodTasks.filter(t => t.status === 'done').length;
  const totalP = periodTasks.length;
  const pctDone = totalP ? Math.round(donePeriod / totalP * 100) : 0;
  const overdue = periodTasks.filter(t => t.endDate && t.endDate < now && t.status !== 'done').length;

  // Team breakdown
  let teamRows = '';
  TEAM.forEach(m => {
    const mt = periodTasks.filter(t => t.assignee === m.id);
    const md = mt.filter(t => t.status === 'done').length;
    const mp = mt.filter(t => t.status === 'progress').length;
    const mpct = mt.length ? Math.round(md / mt.length * 100) : 0;
    const hrs = mt.reduce((s, t) => s + (t.timeLogged || 0), 0);
    teamRows += `<tr>
      <td><div style="display:flex;align-items:center;gap:6px;"><div class="avatar avatar-${m.id}" style="width:20px;height:20px;font-size:9px;">${m.name[0]}</div>${m.name}</div></td>
      <td>${mt.length}</td><td>${md}</td><td>${mp}</td>
      <td><div class="report-bar"><div class="report-bar-fill" style="width:${mpct}%;background:${m.color};"></div></div></td>
      <td>${hrs > 0 ? (hrs/3600).toFixed(1) + '×©' : '-'}</td>
    </tr>`;
  });

  // Category breakdown
  let catRows = '';
  CATEGORIES.forEach(c => {
    const ct = periodTasks.filter(t => t.category === c.id);
    const cd = ct.filter(t => t.status === 'done').length;
    const cpct = ct.length ? Math.round(cd / ct.length * 100) : 0;
    if (ct.length > 0) {
      catRows += `<tr><td>${c.emoji} ${c.name}</td><td>${ct.length}</td><td>${cd}</td>
        <td><div class="report-bar"><div class="report-bar-fill" style="width:${cpct}%;background:${c.color};"></div></div></td>
        <td>${cpct}%</td></tr>`;
    }
  });

  // Priority breakdown
  const highT = periodTasks.filter(t => t.priority === 'high');
  const medT = periodTasks.filter(t => t.priority === 'medium');
  const lowT = periodTasks.filter(t => t.priority === 'low');

  const periodLabel = reportPeriod === 'week' ? '×©×‘×•×¢×™' : reportPeriod === 'month' ? '×—×•×“×©×™' : '×›×œ×œ×™';

  let html = `
  <div class="report-card" style="grid-column:1/-1;">
    <h3>ğŸ“Š ×¡×™×›×•× ${periodLabel}</h3>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;">
      <div style="text-align:center;"><div style="font-size:11px;color:var(--text2);">×¡×”"×› ××©×™××•×ª</div><div class="big-num">${totalP}</div></div>
      <div style="text-align:center;"><div style="font-size:11px;color:var(--text2);">×”×•×©×œ××•</div><div class="big-num" style="color:var(--green);">${donePeriod}</div></div>
      <div style="text-align:center;"><div style="font-size:11px;color:var(--text2);">××—×•×– ×”×©×œ××”</div><div class="big-num" style="color:var(--accent);">${pctDone}%</div></div>
      <div style="text-align:center;"><div style="font-size:11px;color:var(--text2);">×‘××™×—×•×¨</div><div class="big-num" style="color:var(--red);">${overdue}</div></div>
      <div style="text-align:center;"><div style="font-size:11px;color:var(--text2);">×¡"×” ×©×¢×•×ª</div><div class="big-num" style="color:var(--blue);">${(periodTasks.reduce((s,t)=>s+(t.timeLogged||0),0)/3600).toFixed(1)}</div></div>
    </div>
  </div>

  <div class="report-card">
    <h3>ğŸ‘¥ ×‘×™×¦×•×¢×™ ×¦×•×•×ª</h3>
    <table class="report-table">
      <thead><tr><th>×—×‘×¨ ×¦×•×•×ª</th><th>××©×™××•×ª</th><th>×”×•×©×œ××•</th><th>×‘×ª×”×œ×™×š</th><th>×”×ª×§×“××•×ª</th><th>×©×¢×•×ª</th></tr></thead>
      <tbody>${teamRows}</tbody>
    </table>
  </div>

  <div class="report-card">
    <h3>ğŸ“ ×œ×¤×™ ×§×˜×’×•×¨×™×”</h3>
    <table class="report-table">
      <thead><tr><th>×§×˜×’×•×¨×™×”</th><th>××©×™××•×ª</th><th>×”×•×©×œ××•</th><th>×”×ª×§×“××•×ª</th><th>%</th></tr></thead>
      <tbody>${catRows}</tbody>
    </table>
  </div>

  <div class="report-card">
    <h3>ğŸ¯ ×œ×¤×™ ×¢×“×™×¤×•×ª</h3>
    <div style="display:flex;flex-direction:column;gap:14px;margin-top:8px;">
      <div><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;"><span>ğŸ”´ ×’×‘×•×”×”</span><span>${highT.filter(t=>t.status==='done').length}/${highT.length}</span></div><div class="report-bar" style="height:10px;"><div class="report-bar-fill" style="width:${highT.length?highT.filter(t=>t.status==='done').length/highT.length*100:0}%;background:var(--red);"></div></div></div>
      <div><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;"><span>ğŸŸ¡ ×‘×™× ×•× ×™×ª</span><span>${medT.filter(t=>t.status==='done').length}/${medT.length}</span></div><div class="report-bar" style="height:10px;"><div class="report-bar-fill" style="width:${medT.length?medT.filter(t=>t.status==='done').length/medT.length*100:0}%;background:var(--yellow);"></div></div></div>
      <div><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;"><span>ğŸŸ¢ × ××•×›×”</span><span>${lowT.filter(t=>t.status==='done').length}/${lowT.length}</span></div><div class="report-bar" style="height:10px;"><div class="report-bar-fill" style="width:${lowT.length?lowT.filter(t=>t.status==='done').length/lowT.length*100:0}%;background:var(--green);"></div></div></div>
    </div>
  </div>

  <div class="report-card">
    <h3>âš ï¸ ××©×™××•×ª ×‘××™×—×•×¨</h3>
    ${overdue > 0 ? periodTasks.filter(t => t.endDate < now && t.status !== 'done').sort((a,b) => a.endDate - b.endDate).slice(0,8).map(t => {
      const m = TEAM.find(x => x.id === t.assignee);
      const daysLate = Math.ceil((now - t.endDate) / 86400000);
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;">
        <div style="display:flex;align-items:center;gap:8px;"><div class="avatar avatar-${t.assignee}" style="width:20px;height:20px;font-size:9px;">${m?m.name[0]:''}</div><span>${t.name}</span></div>
        <span style="color:var(--red);font-size:11px;">${daysLate} ×™××™× ×‘××™×—×•×¨</span></div>`;
    }).join('') : '<div style="text-align:center;padding:20px;color:var(--green);font-size:13px;">âœ… ××™×Ÿ ××©×™××•×ª ×‘××™×—×•×¨!</div>'}
  </div>`;

  document.getElementById('reportGrid').innerHTML = html;
}

// ===== VELOCITY =====
function renderVelocity() {
  // Calculate weekly velocity for past 12 weeks
  const weeks = [];
  for (let w = 11; w >= 0; w--) {
    const wEnd = new Date(today); wEnd.setDate(wEnd.getDate() - w * 7);
    const wStart = new Date(wEnd); wStart.setDate(wStart.getDate() - 6);
    const done = allTasks.filter(t => t.status === 'done' && t.endDate && t.endDate >= wStart && t.endDate <= wEnd).length;
    weeks.push({ start: wStart, end: wEnd, done });
  }

  const maxDone = Math.max(...weeks.map(w => w.done), 1);
  const avgVel = weeks.length ? (weeks.reduce((s, w) => s + w.done, 0) / weeks.length).toFixed(1) : 0;
  const lastWeek = weeks[weeks.length - 1].done;
  const prevWeek = weeks[weeks.length - 2].done;
  const trend = lastWeek - prevWeek;
  const totalDone = allTasks.filter(t => t.status === 'done').length;
  const remaining = allTasks.length - totalDone;
  const weeksToFinish = avgVel > 0 ? Math.ceil(remaining / avgVel) : 'âˆ';

  // Stats
  document.getElementById('velocityStats').innerHTML = `
    <div class="vel-stat"><div class="num">${avgVel}</div><div class="lbl">×××•×¦×¢ ×©×‘×•×¢×™</div></div>
    <div class="vel-stat"><div class="num" style="color:var(--green);">${lastWeek}</div><div class="lbl">×©×‘×•×¢ ××—×¨×•×Ÿ</div></div>
    <div class="vel-stat"><div class="num" style="color:${trend >= 0 ? 'var(--green)' : 'var(--red)'};">${trend >= 0 ? 'â†‘' : 'â†“'}${Math.abs(trend)}</div><div class="lbl">××’××”</div></div>
    <div class="vel-stat"><div class="num" style="color:var(--yellow);">${weeksToFinish}</div><div class="lbl">×©×‘×•×¢×•×ª ×œ×¡×™×•× (×¦×¤×™)</div></div>`;

  // Bar chart
  let bars = '';
  let labels = '';
  weeks.forEach((w, i) => {
    const h = maxDone > 0 ? (w.done / maxDone * 100) : 0;
    const isLast = i === weeks.length - 1;
    const color = isLast ? 'var(--accent)' : 'var(--accent2)';
    bars += `<div class="vel-bar-wrap">
      <div class="vel-val" style="color:${color};">${w.done}</div>
      <div class="vel-bar" style="height:${Math.max(h, 3)}%;background:${color};opacity:${isLast ? 1 : 0.6};"></div>
    </div>`;
  });
  document.getElementById('velocityBars').innerHTML = bars;

  // Labels
  let lblHtml = '';
  weeks.forEach(w => {
    lblHtml += `<span>${w.start.getDate()}/${w.start.getMonth()+1}</span>`;
  });
  document.getElementById('velocityLabels').innerHTML = lblHtml;

  // Team velocity
  let teamHtml = '';
  TEAM.forEach(m => {
    const mWeeks = weeks.map(w => {
      return allTasks.filter(t => t.assignee === m.id && t.status === 'done' && t.endDate >= w.start && t.endDate <= w.end).length;
    });
    const mAvg = (mWeeks.reduce((s, v) => s + v, 0) / mWeeks.length).toFixed(1);
    const mMax = Math.max(...mWeeks, 1);
    teamHtml += `<div style="margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <div class="avatar avatar-${m.id}" style="width:24px;height:24px;font-size:10px;">${m.name[0]}</div>
        <span style="font-size:13px;font-weight:500;">${m.name}</span>
        <span style="font-size:11px;color:var(--text2);">×××•×¦×¢: ${mAvg} / ×©×‘×•×¢</span>
      </div>
      <div style="display:flex;align-items:flex-end;gap:3px;height:40px;">
        ${mWeeks.map((v, i) => `<div style="flex:1;background:${m.color};opacity:${0.3 + (v/mMax)*0.7};height:${Math.max(v/mMax*100, 5)}%;border-radius:3px 3px 0 0;" title="×©×‘×•×¢ ${i+1}: ${v} ××©×™××•×ª"></div>`).join('')}
      </div>
    </div>`;
  });
  document.getElementById('velocityTeam').innerHTML = teamHtml;
}

// ===== DEPENDENCIES =====
let taskDependencies = [];

// Generate some sample dependencies
(function initDeps() {
  const doneTasks = allTasks.filter(t => t.status === 'done');
  const activeTasks = allTasks.filter(t => t.status !== 'done');
  // Create ~8 sample dependencies
  for (let i = 0; i < Math.min(8, activeTasks.length); i++) {
    const from = allTasks[i * 3 % allTasks.length];
    const to = allTasks[(i * 3 + 5) % allTasks.length];
    if (from && to && from.id !== to.id) {
      taskDependencies.push({ from: from.id, to: to.id });
    }
  }
})();

function addDependency() {
  const fromId = parseInt(document.getElementById('depFrom').value);
  const toId = parseInt(document.getElementById('depTo').value);
  if (!fromId || !toId || fromId === toId) { toast('âš ï¸ ×‘×—×¨ ×©×ª×™ ××©×™××•×ª ×©×•× ×•×ª'); return; }
  if (taskDependencies.find(d => d.from === fromId && d.to === toId)) { toast('âš ï¸ ×ª×œ×•×ª ×›×‘×¨ ×§×™×™××ª'); return; }
  // Check circular
  if (hasCircular(fromId, toId)) { toast('âš ï¸ ×ª×œ×•×ª ××¢×’×œ×™×ª!'); return; }
  taskDependencies.push({ from: fromId, to: toId });
  logActivity('edit', 'ğŸ”—', `× ×•×¡×¤×” ×ª×œ×•×ª ×—×“×©×”`);
  renderDependencies();
  toast('âœ… ×ª×œ×•×ª × ×•×¡×¤×”');
}

function hasCircular(from, to) {
  const visited = new Set();
  function dfs(node) {
    if (node === from) return true;
    if (visited.has(node)) return false;
    visited.add(node);
    const deps = taskDependencies.filter(d => d.from === node);
    return deps.some(d => dfs(d.to));
  }
  return dfs(to);
}

function removeDependency(from, to) {
  taskDependencies = taskDependencies.filter(d => !(d.from === from && d.to === to));
  renderDependencies();
  toast('ğŸ—‘ï¸ ×ª×œ×•×ª ×”×•×¡×¨×”');
}

function getBlockingTasks(taskId) {
  return taskDependencies.filter(d => d.to === taskId).map(d => allTasks.find(t => t.id === d.from)).filter(Boolean);
}

function isBlocked(taskId) {
  const blockers = getBlockingTasks(taskId);
  return blockers.some(b => b.status !== 'done');
}

function renderDependencies() {
  // Populate dropdowns
  const opts = allTasks.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
  document.getElementById('depFrom').innerHTML = '<option value="">×‘×—×¨ ××©×™××” ×—×•×¡××ª...</option>' + opts;
  document.getElementById('depTo').innerHTML = '<option value="">×‘×—×¨ ××©×™××” ×—×¡×•××”...</option>' + opts;

  // Dependency list
  let listHtml = '';
  if (taskDependencies.length === 0) {
    listHtml = '<div style="text-align:center;padding:30px;color:var(--text2);">××™×Ÿ ×ª×œ×•×™×•×ª ××•×’×“×¨×•×ª</div>';
  } else {
    taskDependencies.forEach(d => {
      const fromT = allTasks.find(t => t.id === d.from);
      const toT = allTasks.find(t => t.id === d.to);
      if (!fromT || !toT) return;
      const fromDone = fromT.status === 'done';
      const toBlocked = isBlocked(toT.id);
      listHtml += `<div class="dep-row">
        <div class="dep-task ${fromDone ? 'done' : ''}" onclick="openEditTask(${fromT.id})" title="${fromT.name}">
          <span style="font-size:12px;">${fromDone ? 'âœ…' : 'ğŸ”„'} ${fromT.name.substring(0, 25)}${fromT.name.length > 25 ? '...' : ''}</span>
        </div>
        <div class="dep-arrow">â†’</div>
        <div class="dep-task ${toBlocked ? 'blocked' : ''}" onclick="openEditTask(${toT.id})" title="${toT.name}">
          <span style="font-size:12px;">${toBlocked ? 'ğŸš«' : 'ğŸ“‹'} ${toT.name.substring(0, 25)}${toT.name.length > 25 ? '...' : ''}</span>
        </div>
        <button onclick="removeDependency(${d.from},${d.to})" style="background:none;border:none;cursor:pointer;font-size:14px;color:var(--red);margin-right:auto;" title="×”×¡×¨ ×ª×œ×•×ª">âœ•</button>
      </div>`;
    });
  }
  document.getElementById('depList').innerHTML = listHtml;

  // Blocked tasks panel
  const blockedTasks = allTasks.filter(t => t.status !== 'done' && isBlocked(t.id));
  let blockedHtml = '';
  if (blockedTasks.length === 0) {
    blockedHtml = '<div style="text-align:center;padding:30px;color:var(--green);">âœ… ××™×Ÿ ××©×™××•×ª ×—×¡×•××•×ª!</div>';
  } else {
    blockedTasks.forEach(t => {
      const blockers = getBlockingTasks(t.id).filter(b => b.status !== 'done');
      const m = TEAM.find(x => x.id === t.assignee);
      blockedHtml += `<div style="padding:12px;background:var(--red-bg);border:1px solid rgba(225,112,85,0.2);border-radius:8px;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <span style="font-size:14px;">ğŸš«</span>
          <span style="font-weight:500;font-size:13px;cursor:pointer;" onclick="openEditTask(${t.id})">${t.name}</span>
          <div class="avatar avatar-${t.assignee}" style="width:18px;height:18px;font-size:8px;margin-right:auto;">${m?m.name[0]:''}</div>
        </div>
        <div style="font-size:11px;color:var(--text2);">×—×¡×•× ×¢"×™: ${blockers.map(b => '<span style="color:var(--red);">'+b.name+'</span>').join(', ')}</div>
      </div>`;
    });
  }
  document.getElementById('depBlocked').innerHTML = blockedHtml;
}

// ===== SUBTASKS =====
function addSubtask(taskId) {
  const input = document.getElementById('f-st-input');
  const text = input.value.trim();
  if (!text) return;
  const t = allTasks.find(x => x.id === taskId);
  if (!t) return;
  if (!t.subtasks) t.subtasks = [];
  const newId = t.subtasks.length ? Math.max(...t.subtasks.map(s => s.id)) + 1 : 1;
  t.subtasks.push({ id: newId, text, done: false });
  logActivity('edit', 'ğŸ“‹', `×ª×ª-××©×™××” ×—×“×©×” × ×•×¡×¤×”: "${text}" ×œ××©×™××” "${t.name}"`);
  saveTasks();openEditTask(taskId);
}

function toggleSubtask(taskId, subId) {
  const t = allTasks.find(x => x.id === taskId);
  if (!t || !t.subtasks) return;
  const sub = t.subtasks.find(s => s.id === subId);
  if (sub) {
    sub.done = !sub.done;
    logActivity('edit', sub.done ? 'âœ…' : 'â¬œ', `×ª×ª-××©×™××” "${sub.text}" ×¡×•×× ×” ×›${sub.done ? '×”×•×©×œ×' : '×œ× ×”×•×©×œ×'}`);
  }
  saveTasks();openEditTask(taskId);
}

function removeSubtask(taskId, subId) {
  const t = allTasks.find(x => x.id === taskId);
  if (!t || !t.subtasks) return;
  t.subtasks = t.subtasks.filter(s => s.id !== subId);
  saveTasks();openEditTask(taskId);
}

// ===== TAGS =====
function addTagToEdit(taskId) {
  const input = document.getElementById('f-tag-input');
  const tag = input.value.trim();
  if (!tag) return;
  const t = allTasks.find(x => x.id === taskId);
  if (!t) return;
  if (!t.tags) t.tags = [];
  if (t.tags.includes(tag)) { toast('âš ï¸ ×ª×’×™×ª ×›×‘×¨ ×§×™×™××ª'); return; }
  t.tags.push(tag);
  logActivity('edit', 'ğŸ·ï¸', `×ª×’×™×ª "${tag}" × ×•×¡×¤×” ×œ××©×™××” "${t.name}"`);
  saveTasks();openEditTask(taskId);
}

function addPresetTag(taskId, tag) {
  const t = allTasks.find(x => x.id === taskId);
  if (!t) return;
  if (!t.tags) t.tags = [];
  if (t.tags.includes(tag)) return;
  t.tags.push(tag);
  logActivity('edit', 'ğŸ·ï¸', `×ª×’×™×ª "${tag}" × ×•×¡×¤×” ×œ××©×™××” "${t.name}"`);
  saveTasks();openEditTask(taskId);
}

function removeTagFromEdit(taskId, tag) {
  const t = allTasks.find(x => x.id === taskId);
  if (!t || !t.tags) return;
  t.tags = t.tags.filter(tg => tg !== tag);
  saveTasks();openEditTask(taskId);
}

function getTagColor(tag) {
  const idx = TAG_PRESETS.indexOf(tag);
  if (idx >= 0) return TAG_COLORS[idx % TAG_COLORS.length];
  // Hash for custom tags
  let hash = 0;
  for (let i = 0; i < tag.length; i++) hash = tag.charCodeAt(i) + ((hash << 5) - hash);
  return TAG_COLORS[Math.abs(hash) % TAG_COLORS.length];
}

// ===== RECURRING TASKS =====
function getRecurrenceLabel(r) {
  return {none:'',daily:'×™×•××™',weekly:'×©×‘×•×¢×™',biweekly:'×“×•-×©×‘×•×¢×™',monthly:'×—×•×“×©×™'}[r] || '';
}

function generateRecurringTask(task) {
  if (!task.recurrence || task.recurrence === 'none' || task.status !== 'done') return;
  const dayOffset = {daily:1, weekly:7, biweekly:14, monthly:30}[task.recurrence];
  if (!dayOffset) return;
  // Check if a recurring instance already exists
  const existingNext = allTasks.find(t => t.name === task.name && t.id !== task.id && t.startDate > task.endDate && t.status !== 'done');
  if (existingNext) return;
  const duration = Math.ceil((task.endDate - task.startDate) / 86400000);
  const newStart = new Date(task.endDate); newStart.setDate(newStart.getDate() + dayOffset);
  const newEnd = new Date(newStart); newEnd.setDate(newEnd.getDate() + duration);
  const newTask = {
    ...task,
    id: Math.max(...allTasks.map(t => t.id)) + 1,
    status: 'todo',
    startDate: newStart,
    endDate: newEnd,
    subtasks: task.subtasks ? task.subtasks.map(s => ({...s, done: false})) : [],
    timeLogged: 0
  };
  allTasks.push(newTask);
  saveTasks();
  logActivity('create', 'ğŸ”', `××©×™××” ×—×•×–×¨×ª × ×•×¦×¨×”: "${newTask.name}" (${getRecurrenceLabel(task.recurrence)})`);
  toast(`ğŸ” ××©×™××” ×—×•×–×¨×ª × ×•×¦×¨×”: ${newTask.name}`);
}

// Hook into saveEditTask to trigger recurring generation
const _origSaveEditForRecur = saveEditTask;

// ===== COMMENTS =====
function renderComments(taskId) {
  const t = allTasks.find(x => x.id === taskId);
  if (!t) return '';
  const comments = t.comments || [];
  let html = '<div class="comments-section"><label style="font-size:13px;font-weight:500;">ğŸ’¬ ×ª×’×•×‘×•×ª ' + (comments.length ? '<span class="comment-count">(' + comments.length + ')</span>' : '') + '</label>';
  if (comments.length) {
    html += '<div class="comment-list">';
    comments.forEach((c, i) => {
      const author = TEAM.find(m => m.id === c.author);
      const timeAgo = getTimeAgo(c.time);
      const textWithMentions = c.text.replace(/@(×¨×•×‘×™|×’×œ×¢×“|×“× ×”)/g, '<span class="mention">@$1</span>');
      html += `<div class="comment-item">
        <div class="comment-header"><div class="avatar avatar-${c.author}" style="width:20px;height:20px;font-size:9px;">${author?author.name[0]:''}</div>
        <span class="comment-author" style="color:${author?author.color:'var(--text)'};">${author?author.name:c.author}</span><span class="comment-time">${timeAgo}</span></div>
        <div class="comment-text">${textWithMentions}</div>
        <button class="comment-del" onclick="deleteComment(${taskId},${i})">ğŸ—‘ï¸</button>
      </div>`;
    });
    html += '</div>';
  }
  html += `<div class="comment-input-wrap">
    <textarea id="f-comment-${taskId}" placeholder="×”×•×¡×£ ×ª×’×•×‘×”... (×”×©×ª××© ×‘-@ ×œ××–×›×•×¨)" rows="1" oninput="checkMention(this,${taskId})" onkeydown="if(event.key==='Enter'&&!event.shiftKey){addComment(${taskId});event.preventDefault();}"></textarea>
    <button class="btn btn-primary btn-sm" onclick="addComment(${taskId})" style="align-self:flex-end;">×©×œ×—</button>
  </div></div>`;
  return html;
}

function getTimeAgo(date) {
  const diff = today.getTime() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return mins <= 1 ? '×¢×›×©×™×•' : mins + ' ×“×§\'';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + ' ×©×¢\'';
  const days = Math.floor(hrs / 24);
  if (days < 7) return days + ' ×™××™×';
  return fmtDS(date);
}

function addComment(taskId) {
  const textarea = document.getElementById('f-comment-' + taskId);
  const text = textarea.value.trim();
  if (!text) return;
  const t = allTasks.find(x => x.id === taskId);
  if (!t) return;
  if (!t.comments) t.comments = [];
  t.comments.push({ author: currentTeamId, text, time: new Date() });
  // Check for mentions and create notifications
  const mentions = text.match(/@(×¨×•×‘×™|×’×œ×¢×“|×“× ×”)/g);
  if (mentions) {
    mentions.forEach(mention => {
      const name = mention.replace('@', '');
      const mentioned = TEAM.find(m => m.name === name);
      if (mentioned) {
        notifications.unshift({
          id: notifications.length + 1, type: 'mention', icon: 'ğŸ’¬',
          title: `${TEAM.find(m=>m.id===currentTeamId)?.name||'××©×ª××©'} ×”×–×›×™×¨/×” ××•×ª×š`, desc: `"${text.substring(0,50)}${text.length>50?'...':''}" - ${t.name}`,
          taskId: t.id, time: new Date(), read: false
        });
      }
    });
    updateNotifBadge();
  }
  logActivity('edit', 'ğŸ’¬', `<strong>${TEAM.find(m=>m.id===currentTeamId)?.name||'××©×ª××©'}</strong> ×”×•×¡×™×£/×” ×ª×’×•×‘×” ×œ××©×™××” "${t.name}"`);
  saveTasks();openEditTask(taskId);
  toast('ğŸ’¬ ×ª×’×•×‘×” × ×•×¡×¤×”');
}

function deleteComment(taskId, idx) {
  const t = allTasks.find(x => x.id === taskId);
  if (!t || !t.comments) return;
  t.comments.splice(idx, 1);
  saveTasks();openEditTask(taskId);
}

function checkMention(textarea, taskId) {
  const text = textarea.value;
  const lastAt = text.lastIndexOf('@');
  // Remove existing dropdown
  const existing = document.getElementById('mentionDropdown');
  if (existing) existing.remove();
  if (lastAt === -1) return;
  const afterAt = text.substring(lastAt + 1);
  if (afterAt.includes(' ') || afterAt.length > 10) return;
  const matches = TEAM.filter(m => m.name.startsWith(afterAt) || afterAt === '');
  if (matches.length === 0) return;
  const dd = document.createElement('div');
  dd.id = 'mentionDropdown';
  dd.className = 'mention-dropdown';
  dd.style.cssText = 'position:fixed;bottom:80px;right:50%;';
  matches.forEach(m => {
    const opt = document.createElement('div');
    opt.className = 'mention-option';
    opt.innerHTML = `<div class="avatar avatar-${m.id}" style="width:20px;height:20px;font-size:9px;">${m.name[0]}</div>${m.name}`;
    opt.onclick = () => {
      textarea.value = text.substring(0, lastAt) + '@' + m.name + ' ';
      dd.remove();
      textarea.focus();
    };
    dd.appendChild(opt);
  });
  document.body.appendChild(dd);
  // Position near textarea
  const rect = textarea.getBoundingClientRect();
  dd.style.bottom = (window.innerHeight - rect.top + 4) + 'px';
  dd.style.right = (window.innerWidth - rect.right) + 'px';
}

// Close mention dropdown on click outside
document.addEventListener('click', e => {
  const dd = document.getElementById('mentionDropdown');
  if (dd && !dd.contains(e.target)) dd.remove();
});

// ===== NOTIFICATIONS =====
function toggleNotifPanel() {
  const panel = document.getElementById('notifPanel');
  const backdrop = document.getElementById('notifBackdrop');
  panel.classList.toggle('open');
  backdrop.classList.toggle('open');
  if (panel.classList.contains('open')) renderNotifList();
}

function updateNotifBadge() {
  const unread = notifications.filter(n => !n.read).length;
  const badge = document.getElementById('notifBadge');
  if (unread > 0) { badge.style.display = 'flex'; badge.textContent = unread > 9 ? '9+' : unread; }
  else { badge.style.display = 'none'; }
}

function renderNotifList() {
  const list = document.getElementById('notifList');
  if (notifications.length === 0) {
    list.innerHTML = '<div class="notif-empty">ğŸ”” ××™×Ÿ ×”×ª×¨××•×ª</div>';
    return;
  }
  list.innerHTML = notifications.map(n => `
    <div class="notif-item ${n.read ? '' : 'unread'}" onclick="openNotifTask(${n.id},${n.taskId})">
      <div class="notif-title">${n.icon} ${n.title}</div>
      <div class="notif-desc">${n.desc}</div>
      <div class="notif-time">${getTimeAgo(n.time)}</div>
    </div>`).join('');
}

function openNotifTask(notifId, taskId) {
  const n = notifications.find(x => x.id === notifId);
  if (n) n.read = true;
  updateNotifBadge();
  toggleNotifPanel();
  openEditTask(taskId);
}

function markAllNotifsRead() {
  notifications.forEach(n => n.read = true);
  updateNotifBadge();
  renderNotifList();
  toast('âœ… ×›×œ ×”×”×ª×¨××•×ª ×¡×•×× ×• ×›× ×§×¨×');
}

function addNotification(type, icon, title, desc, taskId) {
  notifications.unshift({ id: notifications.length + 1, type, icon, title, desc, taskId, time: new Date(), read: false });
  updateNotifBadge();
}

// ===== THEME TOGGLE =====
let isDark = true;
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  const track = document.getElementById('themeToggle');
  const label = document.getElementById('themeLabel');
  track.classList.toggle('on', !isDark);
  label.textContent = isDark ? '××¦×‘ ×›×”×”' : '××¦×‘ ×‘×”×™×¨';
}

// ===== CUSTOMIZABLE DASHBOARD =====
let dashWidgets = {stats:true, kpi:true, urgent:true, categories:true};
function toggleWidget(key) {
  dashWidgets[key] = !dashWidgets[key];
  renderDashboard();
}

// Wrap existing renderDashboard to add widget controls
const _origRenderDashboard = typeof renderDashboard === 'function' ? renderDashboard : null;

// ===== PERSONAL TIMELINE =====
let timelinePerson = 'rubi';
function setTimelinePerson(person, el) {
  timelinePerson = person;
  if (el) { el.parentElement.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); }
  renderTimeline();
}

function renderTimeline() {
  const member = TEAM.find(m => m.id === timelinePerson);
  const tasks = allTasks.filter(t => t.assignee === timelinePerson && t.endDate)
    .sort((a, b) => a.endDate - b.endDate);

  let html = '<div class="timeline-line"></div>';
  let lastMonth = '';

  tasks.forEach(t => {
    const monthStr = t.endDate.toLocaleDateString('he-IL', {month:'long', year:'numeric'});
    if (monthStr !== lastMonth) {
      lastMonth = monthStr;
      html += `<div class="timeline-date-group">${monthStr}</div>`;
    }

    const cat = CATEGORIES.find(c => c.id === t.category);
    const pColor = {high:'var(--red)',medium:'var(--yellow)',low:'var(--green)'}[t.priority];
    const sColor = {todo:'var(--blue)',progress:'var(--yellow)',review:'var(--purple)',done:'var(--green)',blocked:'var(--red)'}[t.status];
    const isOverdue = t.endDate < today && t.status !== 'done';
    const stPct = t.subtasks && t.subtasks.length ? Math.round(t.subtasks.filter(s=>s.done).length/t.subtasks.length*100) : null;
    const commentCount = (t.comments||[]).length;

    html += `<div class="timeline-item" onclick="openEditTask(${t.id})" style="${isOverdue ? 'border-color:var(--red);' : ''}">
      <div class="timeline-dot" style="background:${sColor};"></div>
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
        <div style="font-weight:500;font-size:13px;">${t.name}</div>
        <span style="font-size:10px;white-space:nowrap;color:${isOverdue?'var(--red)':'var(--text2)'};">${fmtDS(t.startDate)} - ${fmtDS(t.endDate)}${isOverdue?' âš ï¸':''}</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span class="category-tag" style="background:${cat?cat.color+'22':'var(--surface2)'};color:${cat?cat.color:'var(--text2)'};font-size:10px;padding:2px 6px;">${cat?cat.emoji+' '+cat.name:''}</span>
        <span style="font-size:10px;padding:2px 6px;border-radius:4px;background:${sColor}22;color:${sColor};">${getStatusLabel(t.status)}</span>
        <span style="width:6px;height:6px;border-radius:50%;background:${pColor};"></span>
        ${t.recurrence && t.recurrence !== 'none' ? '<span class="recur-badge">ğŸ” '+getRecurrenceLabel(t.recurrence)+'</span>' : ''}
        ${stPct !== null ? '<span style="font-size:10px;color:var(--text2);">ğŸ“‹ '+stPct+'%</span>' : ''}
        ${commentCount ? '<span style="font-size:10px;color:var(--text2);">ğŸ’¬ '+commentCount+'</span>' : ''}
        ${t.tags && t.tags.length ? t.tags.slice(0,3).map(tg => '<span class="tag" style="background:'+getTagColor(tg)+'33;color:'+getTagColor(tg)+';font-size:9px;padding:1px 5px;">'+tg+'</span>').join('') : ''}
      </div>
      ${t.goal ? '<div style="font-size:11px;color:var(--text2);margin-top:6px;">ğŸ¯ '+t.goal+'</div>' : ''}
    </div>`;
  });

  if (tasks.length === 0) {
    html = '<div style="text-align:center;padding:40px;color:var(--text2);">××™×Ÿ ××©×™××•×ª ×œ×—×‘×¨ ×¦×•×•×ª ×–×”</div>';
  }

  document.getElementById('timelineContainer').innerHTML = html;
}

// ===== SUCCESS ANIMATIONS =====
function showConfetti() {
  const container = document.createElement('div');
  container.className = 'confetti-container';
  const colors = ['#6c5ce7','#00b894','#fd79a8','#fdcb6e','#74b9ff','#e17055','#81ecec','#a29bfe'];
  for (let i = 0; i < 40; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = Math.random() * 100 + '%';
    c.style.background = colors[Math.floor(Math.random() * colors.length)];
    c.style.animationDelay = Math.random() * 0.5 + 's';
    c.style.animationDuration = (1.5 + Math.random()) + 's';
    c.style.width = (5 + Math.random() * 8) + 'px';
    c.style.height = (5 + Math.random() * 8) + 'px';
    container.appendChild(c);
  }
  document.body.appendChild(container);
  setTimeout(() => container.remove(), 3000);
}

// ===== HOURS & PRICING =====
function renderPricing() {
  const rate = parseFloat(document.getElementById('defaultRate').value) || 250;
  let html = '';

  // Per-member breakdown
  html += `<div class="pricing-card" style="grid-column:1/-1;"><h3 style="font-size:14px;margin-bottom:14px;">ğŸ’° ×¡×™×›×•× ×©×¢×•×ª ×•×ª××—×•×¨</h3>
    <table class="pricing-table"><thead><tr><th>×—×‘×¨ ×¦×•×•×ª</th><th>×©×¢×•×ª ××ª×•×¢×“×•×ª</th><th>×ª×¢×¨×™×£/×©×¢×”</th><th>×¡×”"×› ×¢×œ×•×ª</th><th>××©×™××•×ª</th><th>×××•×¦×¢/××©×™××”</th></tr></thead><tbody>`;
  let totalHrs = 0, totalCost = 0;
  TEAM.forEach(m => {
    const mt = allTasks.filter(t => t.assignee === m.id);
    const hrs = mt.reduce((s, t) => s + (t.timeLogged || 0), 0) / 3600;
    const cost = hrs * rate;
    totalHrs += hrs;
    totalCost += cost;
    const avgPerTask = mt.length ? (hrs / mt.length).toFixed(1) : 0;
    html += `<tr><td><div style="display:flex;align-items:center;gap:6px;"><div class="avatar avatar-${m.id}" style="width:20px;height:20px;font-size:9px;">${m.name[0]}</div>${m.name}</div></td>
      <td>${hrs.toFixed(1)}×©</td><td>â‚ª${rate}</td><td style="font-weight:600;">â‚ª${cost.toFixed(0)}</td><td>${mt.length}</td><td>${avgPerTask}×©</td></tr>`;
  });
  html += `<tr style="font-weight:700;border-top:2px solid var(--border);"><td>×¡×”"×›</td><td>${totalHrs.toFixed(1)}×©</td><td>â‚ª${rate}</td><td>â‚ª${totalCost.toFixed(0)}</td><td>${allTasks.length}</td><td>${allTasks.length?(totalHrs/allTasks.length).toFixed(1):'0'}×©</td></tr>`;
  html += '</tbody></table></div>';

  // Per-category breakdown
  html += `<div class="pricing-card"><h3 style="font-size:14px;margin-bottom:14px;">ğŸ“ ×œ×¤×™ ×§×˜×’×•×¨×™×”</h3>
    <table class="pricing-table"><thead><tr><th>×§×˜×’×•×¨×™×”</th><th>×©×¢×•×ª</th><th>×¢×œ×•×ª</th></tr></thead><tbody>`;
  CATEGORIES.forEach(c => {
    const ct = allTasks.filter(t => t.category === c.id);
    const hrs = ct.reduce((s, t) => s + (t.timeLogged || 0), 0) / 3600;
    html += `<tr><td>${c.emoji} ${c.name}</td><td>${hrs.toFixed(1)}×©</td><td>â‚ª${(hrs*rate).toFixed(0)}</td></tr>`;
  });
  html += '</tbody></table></div>';

  // Top time-consuming tasks
  const topTasks = [...allTasks].filter(t => t.timeLogged > 0).sort((a, b) => b.timeLogged - a.timeLogged).slice(0, 10);
  html += `<div class="pricing-card"><h3 style="font-size:14px;margin-bottom:14px;">â±ï¸ ××©×™××•×ª ×¢× ×”×›×™ ×”×¨×‘×” ×©×¢×•×ª</h3>`;
  if (topTasks.length) {
    html += '<table class="pricing-table"><thead><tr><th>××©×™××”</th><th>×©×¢×•×ª</th><th>×¢×œ×•×ª</th></tr></thead><tbody>';
    topTasks.forEach(t => {
      const hrs = t.timeLogged / 3600;
      html += `<tr><td style="cursor:pointer;" onclick="openEditTask(${t.id})">${t.name}</td><td>${hrs.toFixed(1)}×©</td><td>â‚ª${(hrs*rate).toFixed(0)}</td></tr>`;
    });
    html += '</tbody></table>';
  } else { html += '<div style="text-align:center;padding:20px;color:var(--text2);">××™×Ÿ ×©×¢×•×ª ××ª×•×¢×“×•×ª ×¢×“×™×™×Ÿ</div>'; }
  html += '</div>';

  document.getElementById('pricingGrid').innerHTML = html;
}

// ===== CLIENT DASHBOARD =====
let clients = [
  {id:1, name:'×¡×˜××¨×˜××¤ XYZ', project:'×•×™×“××• ×ª×“××™×ª', status:'active', budget:15000, tasks:[]},
  {id:2, name:'×—×‘×¨×ª ABC', project:'×¡×“×¨×ª ×× ×™××¦×™×”', status:'active', budget:45000, tasks:[]},
  {id:3, name:'××•×ª×’ 123', project:'×¢×™×¦×•×‘ ×œ×•×’×• + ×‘×¨× ×“×™× ×’', status:'completed', budget:8000, tasks:[]},
  {id:4, name:'×¢××•×ª×ª ×—×™× ×•×š', project:'×¡×¨×˜×•×Ÿ ×”×¡×‘×¨×”', status:'proposal', budget:12000, tasks:[]},
];

function addClient() {
  const name = document.getElementById('newClientName').value.trim();
  const project = document.getElementById('newClientProject').value.trim();
  if (!name) { toast('âš ï¸ ×”×–×Ÿ ×©× ×œ×§×•×—'); return; }
  clients.push({id: clients.length+1, name, project: project||'×¤×¨×•×™×§×˜ ×—×“×©', status:'proposal', budget:0, tasks:[]});
  document.getElementById('newClientName').value = '';
  document.getElementById('newClientProject').value = '';
  renderClients();
  toast('âœ… ×œ×§×•×— × ×•×¡×£');
}

function cycleClientStatus(id) {
  const c = clients.find(x => x.id === id);
  if (!c) return;
  const order = ['proposal','active','completed','on-hold'];
  c.status = order[(order.indexOf(c.status)+1) % order.length];
  renderClients();
}

function renderClients() {
  const statusLabels = {proposal:'×”×¦×¢×”',active:'×¤×¢×™×œ',completed:'×”×•×©×œ×','on-hold':'×‘×”××ª× ×”'};
  const statusColors = {proposal:'var(--yellow)',active:'var(--green)',completed:'var(--blue)','on-hold':'var(--text2)'};

  // Summary stats
  const active = clients.filter(c => c.status === 'active').length;
  const totalBudget = clients.reduce((s,c) => s + c.budget, 0);

  let html = `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;">
    <div style="background:var(--surface);padding:12px;border-radius:8px;text-align:center;border:1px solid var(--border);"><div style="font-size:11px;color:var(--text2);">×¡×”"×› ×œ×§×•×—×•×ª</div><div style="font-size:24px;font-weight:700;">${clients.length}</div></div>
    <div style="background:var(--surface);padding:12px;border-radius:8px;text-align:center;border:1px solid var(--border);"><div style="font-size:11px;color:var(--text2);">×¤×¢×™×œ×™×</div><div style="font-size:24px;font-weight:700;color:var(--green);">${active}</div></div>
    <div style="background:var(--surface);padding:12px;border-radius:8px;text-align:center;border:1px solid var(--border);"><div style="font-size:11px;color:var(--text2);">×”×¦×¢×•×ª</div><div style="font-size:24px;font-weight:700;color:var(--yellow);">${clients.filter(c=>c.status==='proposal').length}</div></div>
    <div style="background:var(--surface);padding:12px;border-radius:8px;text-align:center;border:1px solid var(--border);"><div style="font-size:11px;color:var(--text2);">×ª×§×¦×™×‘ ×›×•×œ×œ</div><div style="font-size:24px;font-weight:700;color:var(--accent);">â‚ª${totalBudget.toLocaleString()}</div></div>
  </div>`;

  clients.forEach(c => {
    html += `<div class="client-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;">
        <div><div style="font-weight:600;font-size:15px;">${c.name}</div><div style="font-size:12px;color:var(--text2);">${c.project}</div></div>
        <span class="client-status" style="background:${statusColors[c.status]}22;color:${statusColors[c.status]};cursor:pointer;" onclick="cycleClientStatus(${c.id})" title="×œ×—×¥ ×œ×©×™× ×•×™ ×¡×˜×˜×•×¡">${statusLabels[c.status]}</span>
      </div>
      <div style="display:flex;gap:12px;font-size:12px;color:var(--text2);">
        <span>ğŸ’° ×ª×§×¦×™×‘: <input class="pricing-input" value="${c.budget}" onchange="clients.find(x=>x.id===${c.id}).budget=parseInt(this.value)||0;renderClients();" style="width:80px;"></span>
      </div>
    </div>`;
  });

  document.getElementById('clientGrid').innerHTML = html;
}

// ===== OKR TRACKER =====
let okrs = [
  {id:1, objective:'×”×’×“×œ×ª ×‘×¡×™×¡ ×”×œ×§×•×—×•×ª ×‘-50%', owner:'rubi', keyResults:[
    {id:1,text:'×¡×’×™×¨×ª 5 ×œ×§×•×—×•×ª ×—×“×©×™×',current:2,target:5},
    {id:2,text:'×™×¦×™×¨×ª 10 ×œ×™×“×™× ×—×“×©×™× ×‘×—×•×“×©',current:7,target:10},
    {id:3,text:'×©×™×¤×•×¨ ×©×™×¢×•×¨ ×”××¨×” ×œ-30%',current:22,target:30}
  ]},
  {id:2, objective:'×©×™×¤×•×¨ ××™×›×•×ª ×”×ª×•×¦×¨×™×', owner:'dana', keyResults:[
    {id:1,text:'0 ×ª×™×§×•× ×™× ×—×•×–×¨×™× ××œ×§×•×—×•×ª',current:3,target:0},
    {id:2,text:'×™×¦×™×¨×ª 5 ×˜××¤×œ×™×™×˜×™× ×—×“×©×™×',current:2,target:5},
    {id:3,text:'×§×™×¦×•×¨ ×–××Ÿ ×”×¤×§×” ×‘-20%',current:10,target:20}
  ]},
  {id:3, objective:'×‘× ×™×™×ª × ×•×›×—×•×ª ×“×™×’×™×˜×œ×™×ª ×—×–×§×”', owner:'gilad', keyResults:[
    {id:1,text:'10,000 ×¢×•×§×‘×™× ×‘××™× ×¡×˜×’×¨×',current:4500,target:10000},
    {id:2,text:'×¤×¨×¡×•× 3 ×¤×•×¡×˜×™× ×‘×©×‘×•×¢',current:2,target:3},
    {id:3,text:'×”×’×¢×” ×œ-50 ×¦×¤×™×•×ª ×‘×™×•×˜×™×•×‘ ×œ×¡×¨×˜×•×Ÿ',current:30,target:50}
  ]}
];

function addOKR() {
  const obj = document.getElementById('newOkrObj').value.trim();
  const owner = document.getElementById('newOkrOwner').value;
  if (!obj) { toast('âš ï¸ ×”×–×Ÿ ×™×¢×“'); return; }
  okrs.push({id:okrs.length+1, objective:obj, owner, keyResults:[]});
  document.getElementById('newOkrObj').value = '';
  renderOKR();
  toast('âœ… ×™×¢×“ × ×•×¡×£');
}

function addKR(okrId) {
  const input = document.getElementById('kr-input-'+okrId);
  const text = input.value.trim();
  if (!text) return;
  const okr = okrs.find(o => o.id === okrId);
  if (!okr) return;
  okr.keyResults.push({id:okr.keyResults.length+1, text, current:0, target:100});
  input.value = '';
  renderOKR();
}

function updateKR(okrId, krId, val) {
  const okr = okrs.find(o => o.id === okrId);
  if (!okr) return;
  const kr = okr.keyResults.find(k => k.id === krId);
  if (kr) { kr.current = parseFloat(val) || 0; renderOKR(); }
}

function renderOKR() {
  let html = '';
  okrs.forEach(o => {
    const m = TEAM.find(x => x.id === o.owner);
    const avgProgress = o.keyResults.length ?
      Math.round(o.keyResults.reduce((s,kr) => {
        const p = kr.target > kr.current ? (kr.current/kr.target*100) : (kr.target === 0 && kr.current === 0 ? 100 : kr.current <= kr.target ? 100 : Math.max(0, 100-(kr.current-kr.target)/(kr.target||1)*100));
        return s + Math.min(p, 100);
      }, 0) / o.keyResults.length) : 0;
    const pColor = avgProgress >= 70 ? 'var(--green)' : avgProgress >= 40 ? 'var(--yellow)' : 'var(--red)';

    html += `<div class="okr-card">
      <div class="okr-objective">
        <div class="avatar avatar-${o.owner}" style="width:28px;height:28px;font-size:11px;">${m?m.name[0]:''}</div>
        <span style="flex:1;">${o.objective}</span>
        <span style="font-size:20px;font-weight:700;color:${pColor};">${avgProgress}%</span>
      </div>
      <div class="progress-bar" style="margin-bottom:14px;height:6px;"><div class="progress-fill" style="width:${avgProgress}%;background:${pColor};"></div></div>`;

    o.keyResults.forEach(kr => {
      const p = kr.target > 0 ? Math.min(Math.round(kr.current / kr.target * 100), 100) : (kr.current === 0 ? 100 : 0);
      const kColor = p >= 70 ? 'var(--green)' : p >= 40 ? 'var(--yellow)' : 'var(--red)';
      html += `<div class="kr-item">
        <div class="kr-progress" style="flex:1;">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;"><span>${kr.text}</span><span style="color:${kColor};">${p}%</span></div>
          <div class="progress-bar" style="height:4px;"><div class="progress-fill" style="width:${p}%;background:${kColor};"></div></div>
        </div>
        <div style="display:flex;align-items:center;gap:4px;font-size:11px;min-width:100px;">
          <input class="pricing-input" value="${kr.current}" onchange="updateKR(${o.id},${kr.id},this.value)" style="width:50px;">
          <span style="color:var(--text2);">/ ${kr.target}</span>
        </div>
      </div>`;
    });

    html += `<div style="margin-top:10px;display:flex;gap:6px;">
      <input class="form-input" id="kr-input-${o.id}" placeholder="×”×•×¡×£ ×ª×•×¦××” ××¤×ª×—..." style="flex:1;padding:6px 10px;font-size:12px;" onkeydown="if(event.key==='Enter')addKR(${o.id})">
      <button class="btn btn-secondary btn-sm" onclick="addKR(${o.id})">+</button>
    </div></div>`;
  });

  document.getElementById('okrContainer').innerHTML = html;
}

// ===== INIT =====
// App initializes after Firebase auth + data sync (see initFirebaseSync)
</script>
</body>
</html>
